

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>google.appengine.ext.db &mdash; oauth2client 1.4.12 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="oauth2client 1.4.12 documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../../../index.html" class="fa fa-home"> oauth2client</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/modules.html">oauth2client</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../source/oauth2client.html">oauth2client package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">Contributor License Agreements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html#before-writing-code-file-an-issue">Before writing code, file an issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html#fork-oauth2client">Fork oauth2client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html#include-tests">Include tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html#make-the-pull-request">Make the pull request</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">oauth2client</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      
    <li>google.appengine.ext.db</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for google.appengine.ext.db</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c">#</span>
<span class="c"># Copyright 2007 Google Inc.</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>
<span class="c">#</span>




<span class="sd">&quot;&quot;&quot;Simple, schema-based database abstraction layer for the datastore.</span>

<span class="sd">Modeled after Django&#39;s abstraction layer on top of SQL databases,</span>
<span class="sd">http://www.djangoproject.com/documentation/mode_api/. Ours is a little simpler</span>
<span class="sd">and a lot less code because the datastore is so much simpler than SQL</span>
<span class="sd">databases.</span>

<span class="sd">The programming model is to declare Python subclasses of the Model class,</span>
<span class="sd">declaring datastore properties as class members of that class. So if you want to</span>
<span class="sd">publish a story with title, body, and created date, you would do it like this:</span>

<span class="sd">    class Story(db.Model):</span>
<span class="sd">      title = db.StringProperty()</span>
<span class="sd">      body = db.TextProperty()</span>
<span class="sd">      created = db.DateTimeProperty(auto_now_add=True)</span>

<span class="sd">You can create a new Story in the datastore with this usage pattern:</span>

<span class="sd">    story = Story(title=&#39;My title&#39;)</span>
<span class="sd">    story.body = &#39;My body&#39;</span>
<span class="sd">    story.put()</span>

<span class="sd">You query for Story entities using built in query interfaces that map directly</span>
<span class="sd">to the syntax and semantics of the datastore:</span>

<span class="sd">    stories = Story.all().filter(&#39;date &gt;=&#39;, yesterday).order(&#39;-date&#39;)</span>
<span class="sd">    for story in stories:</span>
<span class="sd">      print story.title</span>

<span class="sd">The Property declarations enforce types by performing validation on assignment.</span>
<span class="sd">For example, the DateTimeProperty enforces that you assign valid datetime</span>
<span class="sd">objects, and if you supply the &quot;required&quot; option for a property, you will not</span>
<span class="sd">be able to assign None to that property.</span>

<span class="sd">We also support references between models, so if a story has comments, you</span>
<span class="sd">would represent it like this:</span>

<span class="sd">    class Comment(db.Model):</span>
<span class="sd">      story = db.ReferenceProperty(Story)</span>
<span class="sd">      body = db.TextProperty()</span>

<span class="sd">When you get a story out of the datastore, the story reference is resolved</span>
<span class="sd">automatically the first time it is referenced, which makes it easy to use</span>
<span class="sd">model instances without performing additional queries by hand:</span>

<span class="sd">    comment = Comment.get(key)</span>
<span class="sd">    print comment.story.title</span>

<span class="sd">Likewise, you can access the set of comments that refer to each story through</span>
<span class="sd">this property through a reverse reference called comment_set, which is a Query</span>
<span class="sd">preconfigured to return all matching comments:</span>

<span class="sd">    story = Story.get(key)</span>
<span class="sd">    for comment in story.comment_set:</span>
<span class="sd">       print comment.body</span>

<span class="sd">&quot;&quot;&quot;</span>















<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">datastore</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">datastore_errors</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">datastore_types</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">namespace_manager</span>
<span class="kn">from</span> <span class="nn">google.appengine.api</span> <span class="kn">import</span> <span class="n">users</span>
<span class="kn">from</span> <span class="nn">google.appengine.datastore</span> <span class="kn">import</span> <span class="n">datastore_rpc</span>
<span class="kn">from</span> <span class="nn">google.appengine.datastore</span> <span class="kn">import</span> <span class="n">datastore_query</span>


<span class="n">Error</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">Error</span>
<span class="n">BadValueError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span>
<span class="n">BadPropertyError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadPropertyError</span>
<span class="n">BadRequestError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span>
<span class="n">EntityNotFoundError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">EntityNotFoundError</span>
<span class="n">BadArgumentError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span>
<span class="n">QueryNotFoundError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">QueryNotFoundError</span>
<span class="n">TransactionNotFoundError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">TransactionNotFoundError</span>
<span class="n">Rollback</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">Rollback</span>
<span class="n">TransactionFailedError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">TransactionFailedError</span>
<span class="n">BadFilterError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span>
<span class="n">BadQueryError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadQueryError</span>
<span class="n">BadKeyError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadKeyError</span>
<span class="n">InternalError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">InternalError</span>
<span class="n">NeedIndexError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">NeedIndexError</span>
<span class="n">ReferencePropertyResolveError</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">ReferencePropertyResolveError</span>
<span class="n">Timeout</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">Timeout</span>
<span class="n">CommittedButStillApplying</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">CommittedButStillApplying</span>

<span class="n">ValidationError</span> <span class="o">=</span> <span class="n">BadValueError</span>


<span class="n">Key</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">Key</span>
<span class="n">Category</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">Category</span>
<span class="n">Link</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">Link</span>
<span class="n">Email</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">Email</span>
<span class="n">GeoPt</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">GeoPt</span>
<span class="n">IM</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">IM</span>
<span class="n">PhoneNumber</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">PhoneNumber</span>
<span class="n">PostalAddress</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">PostalAddress</span>
<span class="n">Rating</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">Rating</span>
<span class="n">Text</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">Text</span>
<span class="n">Blob</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">Blob</span>
<span class="n">ByteString</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">ByteString</span>
<span class="n">BlobKey</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">BlobKey</span>


<span class="n">READ_CAPABILITY</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">READ_CAPABILITY</span>
<span class="n">WRITE_CAPABILITY</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">WRITE_CAPABILITY</span>


<span class="n">STRONG_CONSISTENCY</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">STRONG_CONSISTENCY</span>
<span class="n">EVENTUAL_CONSISTENCY</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">EVENTUAL_CONSISTENCY</span>


<span class="n">NESTED</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="o">.</span><span class="n">NESTED</span>
<span class="n">MANDATORY</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="o">.</span><span class="n">MANDATORY</span>
<span class="n">ALLOWED</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="o">.</span><span class="n">ALLOWED</span>
<span class="n">INDEPENDENT</span> <span class="o">=</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="o">.</span><span class="n">INDEPENDENT</span>


<span class="n">KEY_RANGE_EMPTY</span> <span class="o">=</span> <span class="s">&quot;Empty&quot;</span>
<span class="sd">&quot;&quot;&quot;Indicates the given key range is empty and the datastore&#39;s</span>
<span class="sd">automatic ID allocator will not assign keys in this range to new</span>
<span class="sd">entities.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">KEY_RANGE_CONTENTION</span> <span class="o">=</span> <span class="s">&quot;Contention&quot;</span>
<span class="sd">&quot;&quot;&quot;Indicates the given key range is empty but the datastore&#39;s</span>
<span class="sd">automatic ID allocator may assign new entities keys in this range.</span>
<span class="sd">However it is safe to manually assign keys in this range</span>
<span class="sd">if either of the following is true:</span>

<span class="sd"> - No other request will insert entities with the same kind and parent</span>
<span class="sd">   as the given key range until all entities with manually assigned</span>
<span class="sd">   keys from this range have been written.</span>
<span class="sd"> - Overwriting entities written by other requests with the same kind</span>
<span class="sd">   and parent as the given key range is acceptable.</span>

<span class="sd">The datastore&#39;s automatic ID allocator will not assign a key to a new</span>
<span class="sd">entity that will overwrite an existing entity, so once the range is</span>
<span class="sd">populated there will no longer be any contention.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">KEY_RANGE_COLLISION</span> <span class="o">=</span> <span class="s">&quot;Collision&quot;</span>
<span class="sd">&quot;&quot;&quot;Indicates that entities with keys inside the given key range</span>
<span class="sd">already exist and writing to this range will overwrite those entities.</span>
<span class="sd">Additionally the implications of KEY_RANGE_COLLISION apply. If</span>
<span class="sd">overwriting entities that exist in this range is acceptable it is safe</span>
<span class="sd">to use the given range.</span>

<span class="sd">The datastore&#39;s automatic ID allocator will never assign a key to</span>
<span class="sd">a new entity that will overwrite an existing entity so entities</span>
<span class="sd">written by the user to this range will never be overwritten by</span>
<span class="sd">an entity with an automatically assigned key.</span>
<span class="sd">&quot;&quot;&quot;</span>



<span class="n">_kind_map</span> <span class="o">=</span> <span class="p">{}</span>



<span class="n">_SELF_REFERENCE</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>




<span class="n">_RESERVED_WORDS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;key_name&#39;</span><span class="p">])</span>





<span class="k">class</span> <span class="nc">NotSavedError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when a saved-object action is performed on a non-saved object.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">KindError</span><span class="p">(</span><span class="n">BadValueError</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when an entity is used with incorrect Model.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">PropertyError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when non-existent property is referenced.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">DuplicatePropertyError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when a property is duplicated in a model definition.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ConfigurationError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when a property or model is improperly configured.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ReservedWordError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when a property is defined for a reserved word.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">DerivedPropertyError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when attempting to assign a value to a derived property.&quot;&quot;&quot;</span>


<span class="n">_ALLOWED_PROPERTY_TYPES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
    <span class="nb">basestring</span><span class="p">,</span>
    <span class="nb">str</span><span class="p">,</span>
    <span class="nb">unicode</span><span class="p">,</span>
    <span class="nb">bool</span><span class="p">,</span>
    <span class="nb">int</span><span class="p">,</span>
    <span class="nb">long</span><span class="p">,</span>
    <span class="nb">float</span><span class="p">,</span>
    <span class="n">Key</span><span class="p">,</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
    <span class="n">Blob</span><span class="p">,</span>
    <span class="n">datastore_types</span><span class="o">.</span><span class="n">EmbeddedEntity</span><span class="p">,</span>
    <span class="n">ByteString</span><span class="p">,</span>
    <span class="n">Text</span><span class="p">,</span>
    <span class="n">users</span><span class="o">.</span><span class="n">User</span><span class="p">,</span>
    <span class="n">Category</span><span class="p">,</span>
    <span class="n">Link</span><span class="p">,</span>
    <span class="n">Email</span><span class="p">,</span>
    <span class="n">GeoPt</span><span class="p">,</span>
    <span class="n">IM</span><span class="p">,</span>
    <span class="n">PhoneNumber</span><span class="p">,</span>
    <span class="n">PostalAddress</span><span class="p">,</span>
    <span class="n">Rating</span><span class="p">,</span>
    <span class="n">BlobKey</span><span class="p">,</span>
    <span class="p">])</span>

<span class="n">_ALLOWED_EXPANDO_PROPERTY_TYPES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_ALLOWED_PROPERTY_TYPES</span><span class="p">)</span>
<span class="n">_ALLOWED_EXPANDO_PROPERTY_TYPES</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">)))</span>



<span class="n">_OPERATORS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="s">&#39;==&#39;</span><span class="p">,</span> <span class="s">&#39;!=&#39;</span><span class="p">,</span> <span class="s">&#39;in&#39;</span><span class="p">]</span>
<span class="n">_FILTER_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="s">&#39;^\s*([^\s]+)(\s+(</span><span class="si">%s</span><span class="s">)\s*)?$&#39;</span> <span class="o">%</span> <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_OPERATORS</span><span class="p">),</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">class_for_kind</span><span class="p">(</span><span class="n">kind</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Return base-class responsible for implementing kind.</span>

<span class="sd">  Necessary to recover the class responsible for implementing provided</span>
<span class="sd">  kind.</span>

<span class="sd">  Args:</span>
<span class="sd">    kind: Entity kind string.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Class implementation for kind.</span>

<span class="sd">  Raises:</span>
<span class="sd">    KindError when there is no implementation for kind.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">_kind_map</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span>
  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;No implementation for kind </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_reserved_word</span><span class="p">(</span><span class="n">attr_name</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raise an exception if attribute name is a reserved word.</span>

<span class="sd">  Args:</span>
<span class="sd">    attr_name: Name to check to see if it is a reserved word.</span>

<span class="sd">  Raises:</span>
<span class="sd">    ReservedWordError when attr_name is determined to be a reserved word.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">RESERVED_PROPERTY_NAME</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">attr_name</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">ReservedWordError</span><span class="p">(</span>
        <span class="s">&quot;Cannot define property.  All names both beginning and &quot;</span>
        <span class="s">&quot;ending with &#39;__&#39; are reserved.&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">_RESERVED_WORDS</span> <span class="ow">or</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">ReservedWordError</span><span class="p">(</span>
        <span class="s">&quot;Cannot define property using reserved word &#39;</span><span class="si">%(attr_name)s</span><span class="s">&#39;. &quot;</span>
        <span class="s">&quot;If you would like to use this name in the datastore consider &quot;</span>
        <span class="s">&quot;using a different name like </span><span class="si">%(attr_name)s</span><span class="s">_ and adding &quot;</span>
        <span class="s">&quot;name=&#39;</span><span class="si">%(attr_name)s</span><span class="s">&#39; to the parameter list of the property &quot;</span>
        <span class="s">&quot;definition.&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">query_descendants</span><span class="p">(</span><span class="n">model_instance</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns a query for all the descendants of a model instance.</span>

<span class="sd">  Args:</span>
<span class="sd">    model_instance: Model instance to find the descendants of.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Query that will retrieve all entities that have the given model instance</span>
<span class="sd">  as an ancestor. Unlike normal ancestor queries, this does not include the</span>
<span class="sd">  ancestor itself.</span>
<span class="sd">  &quot;&quot;&quot;</span>


  <span class="n">result</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>

  <span class="n">result</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span> <span class="o">+</span> <span class="s">&#39; &gt;&#39;</span><span class="p">,</span>
                <span class="n">model_instance</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">model_to_protobuf</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="n">_entity_class</span><span class="o">=</span><span class="n">datastore</span><span class="o">.</span><span class="n">Entity</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Encodes a model instance as a protocol buffer.</span>

<span class="sd">  Args:</span>
<span class="sd">    model_instance: Model instance to encode.</span>
<span class="sd">  Returns:</span>
<span class="sd">    entity_pb.EntityProto representation of the model instance</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">return</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">_populate_entity</span><span class="p">(</span><span class="n">_entity_class</span><span class="p">)</span><span class="o">.</span><span class="n">ToPb</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">model_from_protobuf</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">_entity_class</span><span class="o">=</span><span class="n">datastore</span><span class="o">.</span><span class="n">Entity</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Decodes a model instance from a protocol buffer.</span>

<span class="sd">  Args:</span>
<span class="sd">    pb: The protocol buffer representation of the model instance. Can be an</span>
<span class="sd">        entity_pb.EntityProto or str encoding of an entity_bp.EntityProto</span>

<span class="sd">  Returns:</span>
<span class="sd">    Model instance resulting from decoding the protocol buffer</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">entity</span> <span class="o">=</span> <span class="n">_entity_class</span><span class="o">.</span><span class="n">FromPb</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">default_kind</span><span class="o">=</span><span class="n">Expando</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span>
  <span class="k">return</span> <span class="n">class_for_kind</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span><span class="o">.</span><span class="n">from_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">model_is_projection</span><span class="p">(</span><span class="n">model_instance</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns true if the given db.Model instance only contains a projection of</span>
<span class="sd">  the full entity.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">_entity</span> <span class="ow">and</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">_entity</span><span class="o">.</span><span class="n">is_projection</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_initialize_properties</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Initialize Property attributes for Model-class.</span>

<span class="sd">  Args:</span>
<span class="sd">    model_class: Model class to initialize properties for.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">model_class</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="p">{}</span>


  <span class="n">property_source</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">def</span> <span class="nf">get_attr_source</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">src_cls</span>  <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">mro</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">src_cls</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">src_cls</span>

  <span class="n">defined</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

  <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&#39;_properties&#39;</span><span class="p">):</span>
      <span class="n">property_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
      <span class="n">duplicate_property_keys</span> <span class="o">=</span> <span class="n">defined</span> <span class="o">&amp;</span> <span class="n">property_keys</span>
      <span class="k">for</span> <span class="n">dupe_prop_name</span> <span class="ow">in</span> <span class="n">duplicate_property_keys</span><span class="p">:</span>



        <span class="n">old_source</span> <span class="o">=</span> <span class="n">property_source</span><span class="p">[</span><span class="n">dupe_prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_attr_source</span><span class="p">(</span>
            <span class="n">dupe_prop_name</span><span class="p">,</span> <span class="n">property_source</span><span class="p">[</span><span class="n">dupe_prop_name</span><span class="p">])</span>
        <span class="n">new_source</span> <span class="o">=</span> <span class="n">get_attr_source</span><span class="p">(</span><span class="n">dupe_prop_name</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_source</span> <span class="o">!=</span> <span class="n">new_source</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">DuplicatePropertyError</span><span class="p">(</span>
              <span class="s">&#39;Duplicate property, </span><span class="si">%s</span><span class="s">, is inherited from both </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">dupe_prop_name</span><span class="p">,</span> <span class="n">old_source</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">new_source</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>



      <span class="n">property_keys</span> <span class="o">-=</span> <span class="n">duplicate_property_keys</span>
      <span class="k">if</span> <span class="n">property_keys</span><span class="p">:</span>
        <span class="n">defined</span> <span class="o">|=</span> <span class="n">property_keys</span>


        <span class="n">property_source</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">property_keys</span><span class="p">,</span> <span class="n">base</span><span class="p">))</span>
        <span class="n">model_class</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>


  <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">dct</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">attr</span> <span class="o">=</span> <span class="n">dct</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Property</span><span class="p">):</span>
      <span class="n">check_reserved_word</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">defined</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DuplicatePropertyError</span><span class="p">(</span><span class="s">&#39;Duplicate property: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">attr_name</span><span class="p">)</span>
      <span class="n">defined</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
      <span class="n">model_class</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
      <span class="n">attr</span><span class="o">.</span><span class="n">__property_config__</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>


  <span class="n">model_class</span><span class="o">.</span><span class="n">_all_properties</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
      <span class="n">prop</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>


  <span class="n">model_class</span><span class="o">.</span><span class="n">_unindexed_properties</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">prop</span><span class="o">.</span><span class="n">indexed</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_coerce_to_key</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns the value&#39;s key.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: a Model or Key instance or string encoded key or None</span>

<span class="sd">  Returns:</span>
<span class="sd">    The corresponding key, or None if value is None.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">None</span>

  <span class="n">value</span><span class="p">,</span> <span class="n">multiple</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">NormalizeAndTypeCheck</span><span class="p">(</span>
    <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Key</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">))</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span><span class="s">&#39;Expected only one model or key&#39;</span><span class="p">)</span>
  <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Key</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">PropertiedClass</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Meta-class for initializing Model classes properties.</span>

<span class="sd">  Used for initializing Properties defined in the context of a model.</span>
<span class="sd">  By using a meta-class much of the configuration of a Property</span>
<span class="sd">  descriptor becomes implicit.  By using this meta-class, descriptors</span>
<span class="sd">  that are of class Model are notified about which class they</span>
<span class="sd">  belong to and what attribute they are associated with and can</span>
<span class="sd">  do appropriate initialization via __property_config__.</span>

<span class="sd">  Duplicate properties are not permitted.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">map_kind</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes a class that might have property definitions.</span>

<span class="sd">    This method is called when a class is created with the PropertiedClass</span>
<span class="sd">    meta-class.</span>

<span class="sd">    Loads all properties for this model and its base classes in to a dictionary</span>
<span class="sd">    for easy reflection via the &#39;properties&#39; method.</span>

<span class="sd">    Configures each property defined in the new class.</span>

<span class="sd">    Duplicate properties, either defined in the new class or defined separately</span>
<span class="sd">    in two base classes are not permitted.</span>

<span class="sd">    Properties may not assigned to names which are in the list of</span>
<span class="sd">    _RESERVED_WORDS.  It is still possible to store a property using a reserved</span>
<span class="sd">    word in the datastore by using the &#39;name&#39; keyword argument to the Property</span>
<span class="sd">    constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      cls: Class being initialized.</span>
<span class="sd">      name: Name of new class.</span>
<span class="sd">      bases: Base classes of new class.</span>
<span class="sd">      dct: Dictionary of new definitions for class.</span>

<span class="sd">    Raises:</span>
<span class="sd">      DuplicatePropertyError when a property is duplicated either in the new</span>
<span class="sd">        class or separately in two base classes.</span>
<span class="sd">      ReservedWordError when a property is given a name that is in the list of</span>
<span class="sd">        reserved words, attributes of Model and names of the form &#39;__.*__&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">PropertiedClass</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>

    <span class="n">_initialize_properties</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">map_kind</span><span class="p">:</span>
      <span class="n">_kind_map</span><span class="p">[</span><span class="n">cls</span><span class="o">.</span><span class="n">kind</span><span class="p">()]</span> <span class="o">=</span> <span class="n">cls</span>




<span class="n">AUTO_UPDATE_UNCHANGED</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Property</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property is an attribute of a Model.</span>

<span class="sd">  It defines the type of the attribute, which determines how it is stored</span>
<span class="sd">  in the datastore and how the property values are validated. Different property</span>
<span class="sd">  types support different options, which change validation rules, default</span>
<span class="sd">  values, etc.  The simplest example of a property is a StringProperty:</span>

<span class="sd">     class Story(db.Model):</span>
<span class="sd">       title = db.StringProperty()</span>
<span class="sd">  &quot;&quot;&quot;</span>


  <span class="n">creation_counter</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">validator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">choices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">indexed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes this Property with the given options.</span>

<span class="sd">    Args:</span>
<span class="sd">      verbose_name: User friendly name of property.</span>
<span class="sd">      name: Storage name for property.  By default, uses attribute name</span>
<span class="sd">        as it is assigned in the Model sub-class.</span>
<span class="sd">      default: Default value for property if none is assigned.</span>
<span class="sd">      required: Whether property is required.</span>
<span class="sd">      validator: User provided method used for validation.</span>
<span class="sd">      choices: User provided set of valid property values.</span>
<span class="sd">      indexed: Whether property is indexed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose_name</span> <span class="o">=</span> <span class="n">verbose_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="n">required</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="o">=</span> <span class="n">validator</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">choices</span> <span class="o">=</span> <span class="n">choices</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">indexed</span> <span class="o">=</span> <span class="n">indexed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">creation_counter</span> <span class="o">=</span> <span class="n">Property</span><span class="o">.</span><span class="n">creation_counter</span>
    <span class="n">Property</span><span class="o">.</span><span class="n">creation_counter</span> <span class="o">+=</span> <span class="mi">1</span>

  <span class="k">def</span> <span class="nf">__property_config__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">property_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Configure property, connecting it to its model.</span>

<span class="sd">    Configure the property so that it knows its property name and what class</span>
<span class="sd">    it belongs to.</span>

<span class="sd">    Args:</span>
<span class="sd">      model_class: Model class which Property will belong to.</span>
<span class="sd">      property_name: Name of property within Model instance to store property</span>
<span class="sd">        values in.  By default this will be the property name preceded by</span>
<span class="sd">        an underscore, but may change for different subclasses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">property_name</span>

  <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the value for this property on the given model instance.</span>

<span class="sd">    See http://docs.python.org/ref/descriptors.html for a description of</span>
<span class="sd">    the arguments to this class and what they mean.&quot;&quot;&quot;</span>



    <span class="k">if</span> <span class="n">model_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span>





    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_name</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the value for this property on the given model instance.</span>

<span class="sd">    See http://docs.python.org/ref/descriptors.html for a description of</span>
<span class="sd">    the arguments to this class and what they mean.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_name</span><span class="p">(),</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default value for unassigned values.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Default value as provided by __init__(default).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assert that provided value is compatible with this property.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: Value to validate against this Property.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value, either the input unchanged or adapted to the</span>
<span class="sd">      required type.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if the value is not appropriate for this</span>
<span class="sd">      property in any way.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> is required&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> is </span><span class="si">%r</span><span class="s">; must be one of </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">choices</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine if value is empty in the context of this property.</span>

<span class="sd">    For most kinds, this is equivalent to &quot;not value&quot;, but for kinds like</span>
<span class="sd">    bool, the test is more subtle, so subclasses can override this method</span>
<span class="sd">    if necessary.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: Value to validate against this Property.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if this value is considered empty in the context of this Property</span>
<span class="sd">      type, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">get_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Datastore representation of this property.</span>

<span class="sd">    Looks for this property in the given model instance, and returns the proper</span>
<span class="sd">    datastore representation of the value that can be stored in a datastore</span>
<span class="sd">    entity.  Most critically, it will fetch the datastore key value for</span>
<span class="sd">    reference properties.</span>

<span class="sd">    Some properies (e.g. DateTimeProperty, UserProperty) optionally update their</span>
<span class="sd">    value on every put(). This call must return the current value for such</span>
<span class="sd">    properties (get_updated_value_for_datastore returns the new value).</span>

<span class="sd">    Args:</span>
<span class="sd">      model_instance: Instance to fetch datastore value from.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Datastore representation of the model value in a form that is</span>
<span class="sd">      appropriate for storing in the datastore.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get__</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">get_updated_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine new value for auto-updated property.</span>

<span class="sd">    Some properies (e.g. DateTimeProperty, UserProperty) optionally update their</span>
<span class="sd">    value on every put(). This call must return the new desired value for such</span>
<span class="sd">    properties. For all other properties, this call must return</span>
<span class="sd">    AUTO_UPDATE_UNCHANGED.</span>

<span class="sd">    Args:</span>
<span class="sd">      model_instance: Instance to get new value for.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Datastore representation of the new model value in a form that is</span>
<span class="sd">      appropriate for storing in the datastore, or AUTO_UPDATE_UNCHANGED.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">AUTO_UPDATE_UNCHANGED</span>

  <span class="k">def</span> <span class="nf">make_value_from_datastore_index_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_value</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">RestoreFromIndexValue</span><span class="p">(</span><span class="n">index_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_value_from_datastore</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">make_value_from_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Native representation of this property.</span>

<span class="sd">    Given a value retrieved from a datastore entity, return a value,</span>
<span class="sd">    possibly converted, to be stored on the model instance.  Usually</span>
<span class="sd">    this returns the value unchanged, but a property class may</span>
<span class="sd">    override this when it uses a different datatype on the model</span>
<span class="sd">    instance than on the entity.</span>

<span class="sd">    This API is not quite symmetric with get_value_for_datastore(),</span>
<span class="sd">    because the model instance on which to store the converted value</span>
<span class="sd">    may not exist yet -- we may be collecting values to be passed to a</span>
<span class="sd">    model constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: value retrieved from the datastore entity.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The value converted for use as a model instance attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_require_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwds</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets kwds[parameter] to value.</span>

<span class="sd">    If kwds[parameter] exists and is not value, raises ConfigurationError.</span>

<span class="sd">    Args:</span>
<span class="sd">      kwds: The parameter dict, which maps parameter names (strings) to values.</span>
<span class="sd">      parameter: The name of the parameter to set.</span>
<span class="sd">      value: The value to set it to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">kwds</span> <span class="ow">and</span> <span class="n">kwds</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> must be </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="n">kwds</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_attr_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attribute name we use for this property in model instances.</span>

<span class="sd">    DO NOT USE THIS METHOD.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>





  <span class="n">data_type</span> <span class="o">=</span> <span class="nb">str</span>

  <span class="k">def</span> <span class="nf">datastore_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deprecated backwards-compatible accessor method for self.data_type.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span>


<span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="n">datastore</span><span class="o">.</span><span class="n">_BaseIndex</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A datastore index.&quot;&quot;&quot;</span>

  <span class="nb">id</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">_BaseIndex</span><span class="o">.</span><span class="n">_Id</span>
  <span class="n">kind</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">_BaseIndex</span><span class="o">.</span><span class="n">_Kind</span>
  <span class="n">has_ancestor</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">_BaseIndex</span><span class="o">.</span><span class="n">_HasAncestor</span>
  <span class="n">properties</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">_BaseIndex</span><span class="o">.</span><span class="n">_Properties</span>


<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Model is the superclass of all object entities in the datastore.</span>

<span class="sd">  The programming model is to declare Python subclasses of the Model class,</span>
<span class="sd">  declaring datastore properties as class members of that class. So if you want</span>
<span class="sd">  to publish a story with title, body, and created date, you would do it like</span>
<span class="sd">  this:</span>

<span class="sd">    class Story(db.Model):</span>
<span class="sd">      title = db.StringProperty()</span>
<span class="sd">      body = db.TextProperty()</span>
<span class="sd">      created = db.DateTimeProperty(auto_now_add=True)</span>

<span class="sd">  A model instance can have a single parent.  Model instances without any</span>
<span class="sd">  parent are root entities.  It is possible to efficiently query for</span>
<span class="sd">  instances by their shared parent.  All descendents of a single root</span>
<span class="sd">  instance also behave as a transaction group.  This means that when you</span>
<span class="sd">  work one member of the group within a transaction all descendents of that</span>
<span class="sd">  root join the transaction.  All operations within a transaction on this</span>
<span class="sd">  group are ACID.</span>
<span class="sd">  &quot;&quot;&quot;</span>


  <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">PropertiedClass</span>

  <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">unused_kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allow subclasses to call __new__() with arguments.</span>

<span class="sd">    Do NOT list &#39;cls&#39; as the first argument, or in the case when</span>
<span class="sd">    the &#39;unused_kwds&#39; dictionary contains the key &#39;cls&#39;, the function</span>
<span class="sd">    will complain about multiple argument values for &#39;cls&#39;.</span>

<span class="sd">    Raises:</span>
<span class="sd">      TypeError if there are no positional arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
      <span class="n">cls</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;object.__new__(): not enough arguments&#39;</span><span class="p">)</span>



    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">key_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">_app</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">_from_entity</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new instance of this model.</span>

<span class="sd">    To create a new entity, you instantiate a model and then call put(),</span>
<span class="sd">    which saves the entity to the datastore:</span>

<span class="sd">       person = Person()</span>
<span class="sd">       person.name = &#39;Bret&#39;</span>
<span class="sd">       person.put()</span>

<span class="sd">    You can initialize properties in the model in the constructor with keyword</span>
<span class="sd">    arguments:</span>

<span class="sd">       person = Person(name=&#39;Bret&#39;)</span>

<span class="sd">    We initialize all other properties to the default value (as defined by the</span>
<span class="sd">    properties in the model definition) if they are not provided in the</span>
<span class="sd">    constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      parent: Parent instance for this instance or None, indicating a top-</span>
<span class="sd">        level instance.</span>
<span class="sd">      key_name: Name for new model instance.</span>
<span class="sd">      _from_entity: Intentionally undocumented.</span>
<span class="sd">      kwds: Keyword arguments mapping to properties of model.  Also:</span>
<span class="sd">        key: Key instance for this instance, if provided makes parent and</span>
<span class="sd">             key_name redundant (they do not need to be set but if they are</span>
<span class="sd">             they must match the key).</span>
<span class="sd">    &quot;&quot;&quot;</span>















    <span class="n">namespace</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_app</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_app</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadArgumentError</span><span class="p">(</span><span class="s">&#39;_app must have 2 values if type is tuple.&#39;</span><span class="p">)</span>
      <span class="n">_app</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="n">_app</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="n">encoded</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Expected Key type; received </span><span class="si">%s</span><span class="s"> (is </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">has_id_or_name</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">BadKeyError</span><span class="p">(</span><span class="s">&#39;Key must have an id or name&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">BadKeyError</span><span class="p">(</span><span class="s">&#39;Expected Key kind to be </span><span class="si">%s</span><span class="s">; received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">key</span><span class="o">.</span><span class="n">kind</span><span class="p">()))</span>
      <span class="k">if</span> <span class="n">_app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">app</span><span class="p">()</span> <span class="o">!=</span> <span class="n">_app</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadKeyError</span><span class="p">(</span><span class="s">&#39;Expected Key app to be </span><span class="si">%s</span><span class="s">; received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">_app</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">app</span><span class="p">()))</span>
      <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">namespace</span><span class="p">()</span> <span class="o">!=</span> <span class="n">namespace</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadKeyError</span><span class="p">(</span><span class="s">&#39;Expected Key namespace to be </span><span class="si">%s</span><span class="s">; received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">namespace</span><span class="p">()))</span>
      <span class="k">if</span> <span class="n">key_name</span> <span class="ow">and</span> <span class="n">key_name</span> <span class="o">!=</span> <span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">BadArgumentError</span><span class="p">(</span><span class="s">&#39;Cannot use key and key_name at the same time&#39;</span>
                               <span class="s">&#39; with different values&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">key</span><span class="o">.</span><span class="n">parent</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">BadArgumentError</span><span class="p">(</span><span class="s">&#39;Cannot use key and parent at the same time&#39;</span>
                               <span class="s">&#39; with different values&#39;</span><span class="p">)</span>
      <span class="n">namespace</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">namespace</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key_name</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">key_name</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadKeyError</span><span class="p">(</span><span class="s">&#39;Name cannot be empty.&#39;</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">key_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key_name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">BadKeyError</span><span class="p">(</span><span class="s">&#39;Name must be string type, not </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                          <span class="n">key_name</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Key</span><span class="p">)):</span>
          <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Expected Model type; received </span><span class="si">%s</span><span class="s"> (is </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parent</span><span class="o">.</span><span class="n">has_key</span><span class="p">():</span>
          <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span>
              <span class="s">&quot;</span><span class="si">%s</span><span class="s"> instance must have a complete key before it can be used as a &quot;</span>
              <span class="s">&quot;parent.&quot;</span> <span class="o">%</span> <span class="n">parent</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span> <span class="o">=</span> <span class="n">parent</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key_name</span> <span class="o">=</span> <span class="n">key_name</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span><span class="o">.</span><span class="n">namespace</span><span class="p">()</span> <span class="o">!=</span> <span class="n">namespace</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&#39;Expected parent namespace to be </span><span class="si">%r</span><span class="s">; received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span><span class="o">.</span><span class="n">namespace</span><span class="p">()))</span>
      <span class="n">namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span><span class="o">.</span><span class="n">namespace</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_entity</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">_app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_app</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadArgumentError</span><span class="p">(</span><span class="s">&#39;_app should be a string; received Key(</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">):</span><span class="se">\n</span><span class="s">&#39;</span>
                             <span class="s">&#39;  This may be the result of passing </span><span class="se">\&#39;</span><span class="s">key</span><span class="se">\&#39;</span><span class="s"> as &#39;</span>
                             <span class="s">&#39;a positional parameter in SDK 1.2.6.  Please &#39;</span>
                             <span class="s">&#39;only pass </span><span class="se">\&#39;</span><span class="s">key</span><span class="se">\&#39;</span><span class="s"> as a keyword parameter.&#39;</span> <span class="o">%</span> <span class="n">_app</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace_manager</span><span class="o">.</span><span class="n">get_namespace</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_app</span> <span class="o">=</span> <span class="n">_app</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__namespace</span> <span class="o">=</span> <span class="n">namespace</span>

    <span class="n">is_projection</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_from_entity</span><span class="p">,</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Entity</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_from_entity</span><span class="o">.</span><span class="n">is_saved</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_entity</span> <span class="o">=</span> <span class="n">_from_entity</span>
      <span class="n">is_projection</span> <span class="o">=</span> <span class="n">_from_entity</span><span class="o">.</span><span class="n">is_projection</span><span class="p">()</span>
      <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_name</span>
      <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>



    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
      <span class="k">elif</span> <span class="n">is_projection</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">default_value</span><span class="p">()</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">prop</span><span class="o">.</span><span class="n">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
      <span class="k">except</span> <span class="n">DerivedPropertyError</span><span class="p">:</span>





        <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">kwds</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_from_entity</span><span class="p">:</span>
          <span class="k">raise</span>

  <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unique key for this entity.</span>

<span class="sd">    This property is only available if this entity is already stored in the</span>
<span class="sd">    datastore or if it has a full key, so it is available if this entity was</span>
<span class="sd">    fetched returned from a query, or after put() is called the first time</span>
<span class="sd">    for new entities, or if a complete key was given when constructed.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Datastore key of persisted entity.</span>

<span class="sd">    Raises:</span>
<span class="sd">      NotSavedError when entity is not persistent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_saved</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_name</span><span class="p">:</span>
      <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
                                <span class="n">_app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__namespace</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">NotSavedError</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__set_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">datastore_value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">datastore_value</span> <span class="o">==</span> <span class="p">[]:</span>



      <span class="n">entity</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">entity</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">datastore_value</span>

  <span class="k">def</span> <span class="nf">_to_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copies information from this model to provided entity.</span>

<span class="sd">    Args:</span>
<span class="sd">      entity: Entity to save information on.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__set_property</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


    <span class="n">set_unindexed_properties</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s">&#39;set_unindexed_properties&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">set_unindexed_properties</span><span class="p">:</span>
      <span class="n">set_unindexed_properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unindexed_properties</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_populate_internal_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_entity_class</span><span class="o">=</span><span class="n">datastore</span><span class="o">.</span><span class="n">Entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Populates self._entity, saving its state to the datastore.</span>

<span class="sd">    After this method is called, calling is_saved() will return True.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Populated self._entity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate_entity</span><span class="p">(</span><span class="n">_entity_class</span><span class="o">=</span><span class="n">_entity_class</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="n">new_value</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">get_updated_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">AUTO_UPDATE_UNCHANGED</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;_key_name&#39;</span><span class="p">,</span> <span class="s">&#39;_key&#39;</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity</span>

  <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes this model instance to the datastore.</span>

<span class="sd">    If this instance is new, we add an entity to the datastore.</span>
<span class="sd">    Otherwise, we update this instance, and the key will remain the</span>
<span class="sd">    same.</span>

<span class="sd">    Args:</span>
<span class="sd">      config: datastore_rpc.Configuration to use for this request.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The key of the instance (either the existing key or a new key).</span>

<span class="sd">    Raises:</span>
<span class="sd">      TransactionFailedError if the data could not be committed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_populate_internal_entity</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_entity</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>



  <span class="n">save</span> <span class="o">=</span> <span class="n">put</span>

  <span class="k">def</span> <span class="nf">_populate_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_entity_class</span><span class="o">=</span><span class="n">datastore</span><span class="o">.</span><span class="n">Entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper -- Populate self._entity or create a new one</span>
<span class="sd">    if that one does not exist.  Does not change any state of the instance</span>
<span class="sd">    other than the internal state of the entity.</span>

<span class="sd">    This method is separate from _populate_internal_entity so that it is</span>
<span class="sd">    possible to call to_xml without changing the state of an unsaved entity</span>
<span class="sd">    to saved.</span>

<span class="sd">    Returns:</span>
<span class="sd">      self._entity or a new Entity which is not stored on the instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_saved</span><span class="p">():</span>
      <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">kwds</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;_app&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">,</span> <span class="s">&#39;namespace&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__namespace</span><span class="p">,</span>
              <span class="s">&#39;unindexed_properties&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unindexed_properties</span><span class="p">}</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">id</span><span class="p">():</span>
          <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">parent</span><span class="p">():</span>
          <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_entity</span>
      <span class="n">entity</span> <span class="o">=</span> <span class="n">_entity_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_to_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entity</span>

  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deletes this entity from the datastore.</span>

<span class="sd">    Args:</span>
<span class="sd">      config: datastore_rpc.Configuration to use for this request.</span>

<span class="sd">    Raises:</span>
<span class="sd">      TransactionFailedError if the data could not be committed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datastore</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_key_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_entity</span> <span class="o">=</span> <span class="bp">None</span>



  <span class="k">def</span> <span class="nf">is_saved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine if entity is persisted in the datastore.</span>

<span class="sd">    New instances of Model do not start out saved in the data.  Objects which</span>
<span class="sd">    are saved to or loaded from the Datastore will have a True saved state.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if object has been persisted to the datastore, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine if this model instance has a complete key.</span>

<span class="sd">    When not using a fully self-assigned Key, ids are not assigned until the</span>
<span class="sd">    data is saved to the Datastore, but instances with a key name always have</span>
<span class="sd">    a full key.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the object has been persisted to the datastore or has a key</span>
<span class="sd">      or has a key_name, otherwise False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_saved</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_name</span>

  <span class="k">def</span> <span class="nf">dynamic_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a list of all dynamic properties defined for instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[]</span>


  <span class="k">def</span> <span class="nf">instance_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias for dyanmic_properties.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_properties</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the parent of the model instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Parent of contained entity or parent provided in constructor, None if</span>
<span class="sd">      instance has no parent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">parent_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_key</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">parent_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">parent_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>

  <span class="k">def</span> <span class="nf">parent_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the parent&#39;s key.</span>

<span class="sd">    This method is useful for avoiding a potential fetch from the datastore</span>
<span class="sd">    but still get information about the instances parent.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Parent key of entity, None if there is no parent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_key</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entity</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">to_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_entity_class</span><span class="o">=</span><span class="n">datastore</span><span class="o">.</span><span class="n">Entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate an XML representation of this model instance.</span>

<span class="sd">    atom and gd:namespace properties are converted to XML according to their</span>
<span class="sd">    respective schemas. For more information, see:</span>

<span class="sd">      http://www.atomenabled.org/developers/syndication/</span>
<span class="sd">      http://code.google.com/apis/gdata/common-elements.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate_entity</span><span class="p">(</span><span class="n">_entity_class</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">ToXml</span><span class="p">()</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch instance from the datastore of a specific Model type using key.</span>

<span class="sd">    We support Key objects and string keys (we convert them to Key objects</span>
<span class="sd">    automatically).</span>

<span class="sd">    Useful for ensuring that specific instance types are retrieved from the</span>
<span class="sd">    datastore.  It also helps that the source code clearly indicates what</span>
<span class="sd">    kind of object is being retreived.  Example:</span>

<span class="sd">      story = Story.get(story_key)</span>

<span class="sd">    Args:</span>
<span class="sd">      keys: Key within datastore entity collection to find; or string key;</span>
<span class="sd">        or list of Keys or string keys.</span>
<span class="sd">      config: datastore_rpc.Configuration to use for this request.</span>

<span class="sd">    Returns:</span>
<span class="sd">      If a single key was given: a Model instance associated with key</span>
<span class="sd">      for the provided class if it exists in the datastore, otherwise</span>
<span class="sd">      None. If a list of keys was given: a list where list[i] is the</span>
<span class="sd">      Model instance for keys[i], or None if no instance exists.</span>

<span class="sd">    Raises:</span>
<span class="sd">      KindError if any of the retreived objects are not instances of the</span>
<span class="sd">      type associated with call to &#39;get&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
      <span class="n">instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">results</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">instances</span> <span class="o">=</span> <span class="n">results</span>

    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">instance</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cls</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;Kind </span><span class="si">%r</span><span class="s"> is not a subclass of kind </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">cls</span><span class="o">.</span><span class="n">kind</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">results</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">get_by_key_name</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key_names</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get instance of Model class by its key&#39;s name.</span>

<span class="sd">    Args:</span>
<span class="sd">      key_names: A single key-name or a list of key-names.</span>
<span class="sd">      parent: Parent of instances to get.  Can be a model or key.</span>
<span class="sd">      config: datastore_rpc.Configuration to use for this request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">parent</span> <span class="o">=</span> <span class="n">_coerce_to_key</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BadKeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>

      <span class="k">raise</span> <span class="n">BadArgumentError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="n">key_names</span><span class="p">,</span> <span class="n">multiple</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">NormalizeAndTypeCheck</span><span class="p">(</span><span class="n">key_names</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">datastore</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">key_names</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">multiple</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get instance of Model class by id.</span>

<span class="sd">    Args:</span>
<span class="sd">      key_names: A single id or a list of ids.</span>
<span class="sd">      parent: Parent of instances to get.  Can be a model or key.</span>
<span class="sd">      config: datastore_rpc.Configuration to use for this request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
      <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
    <span class="n">ids</span><span class="p">,</span> <span class="n">multiple</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">NormalizeAndTypeCheck</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">))</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">datastore</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="nb">id</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">multiple</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>




  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">get_or_insert</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transactionally retrieve or create an instance of Model class.</span>

<span class="sd">    This acts much like the Python dictionary setdefault() method, where we</span>
<span class="sd">    first try to retrieve a Model instance with the given key name and parent.</span>
<span class="sd">    If it&#39;s not present, then we create a new instance (using the *kwds</span>
<span class="sd">    supplied) and insert that with the supplied key name.</span>

<span class="sd">    Subsequent calls to this method with the same key_name and parent will</span>
<span class="sd">    always yield the same entity (though not the same actual object instance),</span>
<span class="sd">    regardless of the *kwds supplied. If the specified entity has somehow</span>
<span class="sd">    been deleted separately, then the next call will create a new entity and</span>
<span class="sd">    return it.</span>

<span class="sd">    If the &#39;parent&#39; keyword argument is supplied, it must be a Model instance.</span>
<span class="sd">    It will be used as the parent of the new instance of this Model class if</span>
<span class="sd">    one is created.</span>

<span class="sd">    This method is especially useful for having just one unique entity for</span>
<span class="sd">    a specific identifier. Insertion/retrieval is done transactionally, which</span>
<span class="sd">    guarantees uniqueness.</span>

<span class="sd">    Example usage:</span>

<span class="sd">      class WikiTopic(db.Model):</span>
<span class="sd">        creation_date = db.DatetimeProperty(auto_now_add=True)</span>
<span class="sd">        body = db.TextProperty(required=True)</span>

<span class="sd">      # The first time through we&#39;ll create the new topic.</span>
<span class="sd">      wiki_word = &#39;CommonIdioms&#39;</span>
<span class="sd">      topic = WikiTopic.get_or_insert(wiki_word,</span>
<span class="sd">                                      body=&#39;This topic is totally new!&#39;)</span>
<span class="sd">      assert topic.key().name() == &#39;CommonIdioms&#39;</span>
<span class="sd">      assert topic.body == &#39;This topic is totally new!&#39;</span>

<span class="sd">      # The second time through will just retrieve the entity.</span>
<span class="sd">      overwrite_topic = WikiTopic.get_or_insert(wiki_word,</span>
<span class="sd">                                      body=&#39;A totally different message!&#39;)</span>
<span class="sd">      assert topic.key().name() == &#39;CommonIdioms&#39;</span>
<span class="sd">      assert topic.body == &#39;This topic is totally new!&#39;</span>

<span class="sd">    Args:</span>
<span class="sd">      key_name: Key name to retrieve or create.</span>
<span class="sd">      **kwds: Keyword arguments to pass to the constructor of the model class</span>
<span class="sd">        if an instance for the specified key name does not already exist. If</span>
<span class="sd">        an instance with the supplied key_name and parent already exists, the</span>
<span class="sd">        rest of these arguments will be discarded.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Existing instance of Model class with the specified key_name and parent</span>
<span class="sd">      or a new one that has just been created.</span>

<span class="sd">    Raises:</span>
<span class="sd">      TransactionFailedError if the specified Model instance could not be</span>
<span class="sd">      retrieved or created transactionally (due to high contention, etc).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">txn</span><span class="p">():</span>
      <span class="n">entity</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">get_by_key_name</span><span class="p">(</span><span class="n">key_name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;parent&#39;</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">key_name</span><span class="o">=</span><span class="n">key_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">entity</span>
    <span class="k">return</span> <span class="n">run_in_transaction</span><span class="p">(</span><span class="n">txn</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a query over all instances of this model from the datastore.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Query that will retrieve all instances from entity collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Query</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">gql</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a query using GQL query string.</span>

<span class="sd">    See appengine/ext/gql for more information about GQL.</span>

<span class="sd">    Args:</span>
<span class="sd">      query_string: properly formatted GQL query string with the</span>
<span class="sd">        &#39;SELECT * FROM &lt;entity&gt;&#39; part omitted</span>
<span class="sd">      *args: rest of the positional arguments used to bind numeric references</span>
<span class="sd">        in the query.</span>
<span class="sd">      **kwds: dictionary-based arguments (for named parameters).</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">return</span> <span class="n">GqlQuery</span><span class="p">(</span><span class="s">&#39;SELECT * FROM </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">query_string</span><span class="p">),</span>
                    <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_load_entity_values</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load dynamic properties from entity.</span>

<span class="sd">    Loads attributes which are not defined as part of the entity in</span>
<span class="sd">    to the model instance.</span>

<span class="sd">    Args:</span>
<span class="sd">      entity: Entity which contain values to search dyanmic properties for.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entity_values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">value</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

          <span class="n">entity_values</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">is_projection</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">make_value_from_datastore_index_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">make_value_from_datastore</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
          <span class="n">entity_values</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


    <span class="k">return</span> <span class="n">entity_values</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">from_entity</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts the entity representation of this model to an instance.</span>

<span class="sd">    Converts datastore.Entity instance to an instance of cls.</span>

<span class="sd">    Args:</span>
<span class="sd">      entity: Entity loaded directly from datastore.</span>

<span class="sd">    Raises:</span>
<span class="sd">      KindError when cls is incorrect model for entity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="o">!=</span> <span class="n">entity</span><span class="o">.</span><span class="n">kind</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;Class </span><span class="si">%s</span><span class="s"> cannot handle kind </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">cls</span><span class="p">),</span> <span class="n">entity</span><span class="o">.</span><span class="n">kind</span><span class="p">()))</span>

    <span class="n">entity_values</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_load_entity_values</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">has_id_or_name</span><span class="p">():</span>
      <span class="n">entity_values</span><span class="p">[</span><span class="s">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">_from_entity</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span> <span class="o">**</span><span class="n">entity_values</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">kind</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the datastore kind we use for this model.</span>

<span class="sd">    We just use the name of the model for now, ignoring potential collisions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">entity_type</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Soon to be removed alias for kind.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a dictionary of all the properties defined for this model.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">fields</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Soon to be removed alias for properties.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_rpc</span><span class="p">(</span><span class="n">deadline</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">read_policy</span><span class="o">=</span><span class="n">STRONG_CONSISTENCY</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create an rpc for use in configuring datastore calls.</span>

<span class="sd">  NOTE: This functions exists for backwards compatibility.  Please use</span>
<span class="sd">  create_config() instead.  NOTE: the latter uses &#39;on_completion&#39;,</span>
<span class="sd">  which is a function taking an argument, wherease create_rpc uses</span>
<span class="sd">  &#39;callback&#39; which is a function without arguments.</span>

<span class="sd">  Args:</span>
<span class="sd">    deadline: float, deadline for calls in seconds.</span>
<span class="sd">    callback: callable, a callback triggered when this rpc completes,</span>
<span class="sd">      accepts one argument: the returned rpc.</span>
<span class="sd">    read_policy: flag, set to EVENTUAL_CONSISTENCY to enable eventually</span>
<span class="sd">      consistent reads</span>

<span class="sd">  Returns:</span>
<span class="sd">    A datastore.DatastoreRPC instance.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">datastore</span><span class="o">.</span><span class="n">CreateRPC</span><span class="p">(</span>
      <span class="n">deadline</span><span class="o">=</span><span class="n">deadline</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">read_policy</span><span class="o">=</span><span class="n">read_policy</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_async</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asynchronously fetch the specified Model instance(s) from the datastore.</span>

<span class="sd">  Identical to db.get() except returns an asynchronous object. Call</span>
<span class="sd">  get_result() on the return value to block on the call and get the results.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">keys</span><span class="p">,</span> <span class="n">multiple</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">NormalizeAndTypeCheckKeys</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">extra_hook</span><span class="p">(</span><span class="n">entities</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">multiple</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entities</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

    <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">cls1</span> <span class="o">=</span> <span class="n">class_for_kind</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">cls1</span><span class="o">.</span><span class="n">from_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
      <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">multiple</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">models</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">datastore</span><span class="o">.</span><span class="n">GetAsync</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">extra_hook</span><span class="o">=</span><span class="n">extra_hook</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Fetch the specific Model instance with the given key from the datastore.</span>

<span class="sd">  We support Key objects and string keys (we convert them to Key objects</span>
<span class="sd">  automatically).</span>

<span class="sd">  Args:</span>
<span class="sd">    keys: Key within datastore entity collection to find; or string key;</span>
<span class="sd">      or list of Keys or string keys.</span>
<span class="sd">    config: datastore_rpc.Configuration to use for this request, must be</span>
<span class="sd">      specified as a keyword argument.</span>

<span class="sd">    Returns:</span>
<span class="sd">      If a single key was given: a Model instance associated with key</span>
<span class="sd">      if it exists in the datastore, otherwise None. If a list of keys was</span>
<span class="sd">      given: a list where list[i] is the Model instance for keys[i], or</span>
<span class="sd">      None if no instance exists.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">get_async</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">put_async</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asynchronously store one or more Model instances.</span>

<span class="sd">  Identical to db.put() except returns an asynchronous object. Call</span>
<span class="sd">  get_result() on the return value to block on the call and get the results.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">models</span><span class="p">,</span> <span class="n">multiple</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">NormalizeAndTypeCheck</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>
  <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">_populate_internal_entity</span><span class="p">()</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">extra_hook</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">multiple</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">keys</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">datastore</span><span class="o">.</span><span class="n">PutAsync</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">extra_hook</span><span class="o">=</span><span class="n">extra_hook</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Store one or more Model instances.</span>

<span class="sd">  Args:</span>
<span class="sd">    models: Model instance or list of Model instances.</span>
<span class="sd">    config: datastore_rpc.Configuration to use for this request, must be</span>
<span class="sd">      specified as a keyword argument.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A Key if models is an instance, a list of Keys in the same order</span>
<span class="sd">    as models if models is a list.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TransactionFailedError if the data could not be committed.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">put_async</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>




<span class="n">save</span> <span class="o">=</span> <span class="n">put</span>


<span class="k">def</span> <span class="nf">delete_async</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asynchronous version of delete one or more Model instances.</span>

<span class="sd">  Identical to db.delete() except returns an asynchronous object. Call</span>
<span class="sd">  get_result() on the return value to block on the call.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="p">(</span><span class="nb">basestring</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Key</span><span class="p">)):</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">models</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
      <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="p">]</span>
  <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">_coerce_to_key</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">datastore</span><span class="o">.</span><span class="n">DeleteAsync</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Delete one or more Model instances.</span>

<span class="sd">  Args:</span>
<span class="sd">    models: Model instance, key, key string or iterable thereof.</span>
<span class="sd">    config: datastore_rpc.Configuration to use for this request, must be</span>
<span class="sd">      specified as a keyword argument.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TransactionFailedError if the data could not be committed.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">delete_async</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">allocate_ids_async</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asynchronously allocates a range of IDs.</span>

<span class="sd">  Identical to allocate_ids() except returns an asynchronous object. Call</span>
<span class="sd">  get_result() on the return value to block on the call and return the result.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">datastore</span><span class="o">.</span><span class="n">AllocateIdsAsync</span><span class="p">(</span><span class="n">_coerce_to_key</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">allocate_ids</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Allocates a range of IDs of size for the model_key defined by model.</span>

<span class="sd">  Allocates a range of IDs in the datastore such that those IDs will not</span>
<span class="sd">  be automatically assigned to new entities. You can only allocate IDs</span>
<span class="sd">  for model keys from your app. If there is an error, raises a subclass of</span>
<span class="sd">  datastore_errors.Error.</span>

<span class="sd">  Args:</span>
<span class="sd">    model: Model instance, Key or string to serve as a template specifying the</span>
<span class="sd">      ID sequence in which to allocate IDs. Returned ids should only be used</span>
<span class="sd">      in entities with the same parent (if any) and kind as this key.</span>
<span class="sd">    size: Number of IDs to allocate.</span>
<span class="sd">    config: datastore_rpc.Configuration to use for this request.</span>

<span class="sd">  Returns:</span>
<span class="sd">    (start, end) of the allocated range, inclusive.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">allocate_ids_async</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">allocate_id_range</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Allocates a range of IDs with specific endpoints.</span>

<span class="sd">  Once these IDs have been allocated they may be provided manually to</span>
<span class="sd">  newly created entities.</span>

<span class="sd">  Since the datastore&#39;s automatic ID allocator will never assign</span>
<span class="sd">  a key to a new entity that will cause an existing entity to be</span>
<span class="sd">  overwritten, entities written to the given key range will never be</span>
<span class="sd">  overwritten. However, writing entities with manually assigned keys in this</span>
<span class="sd">  range may overwrite existing entities (or new entities written by a</span>
<span class="sd">  separate request) depending on the key range state returned.</span>

<span class="sd">  This method should only be used if you have an existing numeric id</span>
<span class="sd">  range that you want to reserve, e.g. bulk loading entities that already</span>
<span class="sd">  have IDs. If you don&#39;t care about which IDs you receive, use allocate_ids</span>
<span class="sd">  instead.</span>

<span class="sd">  Args:</span>
<span class="sd">    model: Model instance, Key or string to serve as a template specifying the</span>
<span class="sd">      ID sequence in which to allocate IDs. Allocated ids should only be used</span>
<span class="sd">      in entities with the same parent (if any) and kind as this key.</span>
<span class="sd">    start: first id of the range to allocate, inclusive.</span>
<span class="sd">    end: last id of the range to allocate, inclusive.</span>
<span class="sd">    config: datastore_rpc.Configuration to use for this request.</span>

<span class="sd">  Returns:</span>
<span class="sd">    One of (KEY_RANGE_EMPTY, KEY_RANGE_CONTENTION, KEY_RANGE_COLLISION). If not</span>
<span class="sd">    KEY_RANGE_EMPTY, this represents a potential issue with using the allocated</span>
<span class="sd">    key range.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">key</span> <span class="o">=</span> <span class="n">_coerce_to_key</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
  <span class="n">datastore</span><span class="o">.</span><span class="n">NormalizeAndTypeCheck</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">BadArgumentError</span><span class="p">(</span><span class="s">&#39;Start </span><span class="si">%d</span><span class="s"> and end </span><span class="si">%d</span><span class="s"> must both be &gt; 0.&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">BadArgumentError</span><span class="p">(</span><span class="s">&#39;Range end </span><span class="si">%d</span><span class="s"> cannot be less than start </span><span class="si">%d</span><span class="s">.&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>

  <span class="n">safe_start</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">AllocateIds</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>



  <span class="n">race_condition</span> <span class="o">=</span> <span class="n">safe_start</span> <span class="o">&gt;</span> <span class="n">start</span>







  <span class="n">start_key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">start</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span>
                            <span class="n">_app</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">app</span><span class="p">(),</span> <span class="n">namespace</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">namespace</span><span class="p">())</span>
  <span class="n">end_key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">kind</span><span class="p">(),</span> <span class="n">end</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span>
                          <span class="n">_app</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">app</span><span class="p">(),</span> <span class="n">namespace</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">namespace</span><span class="p">())</span>
  <span class="n">collision</span> <span class="o">=</span> <span class="p">(</span><span class="n">Query</span><span class="p">(</span><span class="n">keys_only</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">namespace</span><span class="p">(),</span> <span class="n">_app</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">app</span><span class="p">())</span>
                   <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;__key__ &gt;=&#39;</span><span class="p">,</span> <span class="n">start_key</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&#39;__key__ &lt;=&#39;</span><span class="p">,</span> <span class="n">end_key</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">collision</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">KEY_RANGE_COLLISION</span>
  <span class="k">elif</span> <span class="n">race_condition</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">KEY_RANGE_CONTENTION</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">KEY_RANGE_EMPTY</span>


<span class="k">def</span> <span class="nf">_index_converter</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">Index</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">Id</span><span class="p">(),</span>
               <span class="n">index</span><span class="o">.</span><span class="n">Kind</span><span class="p">(),</span>
               <span class="n">index</span><span class="o">.</span><span class="n">HasAncestor</span><span class="p">(),</span>
               <span class="n">index</span><span class="o">.</span><span class="n">Properties</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">get_indexes_async</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asynchronously retrieves the application indexes and their states.</span>

<span class="sd">  Identical to get_indexes() except returns an asynchronous object. Call</span>
<span class="sd">  get_result() on the return value to block on the call and get the results.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">extra_hook</span><span class="p">(</span><span class="n">indexes</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">_index_converter</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">state</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">datastore</span><span class="o">.</span><span class="n">GetIndexesAsync</span><span class="p">(</span><span class="n">extra_hook</span><span class="o">=</span><span class="n">extra_hook</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Retrieves the application indexes and their states.</span>

<span class="sd">  Args:</span>
<span class="sd">    config: datastore_rpc.Configuration to use for this request, must be</span>
<span class="sd">      specified as a keyword argument.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A list of (Index, Index.[BUILDING|SERVING|DELETING|ERROR]) tuples.</span>
<span class="sd">    An index can be in the following states:</span>
<span class="sd">      Index.BUILDING: Index is being built and therefore can not serve queries</span>
<span class="sd">      Index.SERVING: Index is ready to service queries</span>
<span class="sd">      Index.DELETING: Index is being deleted</span>
<span class="sd">      Index.ERROR: Index encounted an error in the BUILDING state</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">get_indexes_async</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Expando</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Dynamically expandable model.</span>

<span class="sd">  An Expando does not require (but can still benefit from) the definition</span>
<span class="sd">  of any properties before it can be used to store information in the</span>
<span class="sd">  datastore.  Properties can be added to an expando object by simply</span>
<span class="sd">  performing an assignment.  The assignment of properties is done on</span>
<span class="sd">  an instance by instance basis, so it is possible for one object of an</span>
<span class="sd">  expando type to have different properties from another or even the same</span>
<span class="sd">  properties with different types.  It is still possible to define</span>
<span class="sd">  properties on an expando, allowing those properties to behave the same</span>
<span class="sd">  as on any other model.</span>

<span class="sd">  Example:</span>
<span class="sd">    import datetime</span>

<span class="sd">    class Song(db.Expando):</span>
<span class="sd">      title = db.StringProperty()</span>

<span class="sd">    crazy = Song(title=&#39;Crazy like a diamond&#39;,</span>
<span class="sd">                 author=&#39;Lucy Sky&#39;,</span>
<span class="sd">                 publish_date=&#39;yesterday&#39;,</span>
<span class="sd">                 rating=5.0)</span>

<span class="sd">    hoboken = Song(title=&#39;The man from Hoboken&#39;,</span>
<span class="sd">                   author=[&#39;Anthony&#39;, &#39;Lou&#39;],</span>
<span class="sd">                   publish_date=datetime.datetime(1977, 5, 3))</span>

<span class="sd">    crazy.last_minute_note=db.Text(&#39;Get a train to the station.&#39;)</span>

<span class="sd">  Possible Uses:</span>

<span class="sd">    One use of an expando is to create an object without any specific</span>
<span class="sd">    structure and later, when your application mature and it in the right</span>
<span class="sd">    state, change it to a normal model object and define explicit properties.</span>

<span class="sd">  Additional exceptions for expando:</span>

<span class="sd">    Protected attributes (ones whose names begin with &#39;_&#39;) cannot be used</span>
<span class="sd">    as dynamic properties.  These are names that are reserved for protected</span>
<span class="sd">    transient (non-persisted) attributes.</span>

<span class="sd">  Order of lookup:</span>

<span class="sd">    When trying to set or access an attribute value, any other defined</span>
<span class="sd">    properties, such as methods and other values in __dict__ take precedence</span>
<span class="sd">    over values in the datastore.</span>

<span class="sd">    1 - Because it is not possible for the datastore to know what kind of</span>
<span class="sd">        property to store on an undefined expando value, setting a property to</span>
<span class="sd">        None is the same as deleting it from the expando.</span>

<span class="sd">    2 - Persistent variables on Expando must not begin with &#39;_&#39;.  These</span>
<span class="sd">        variables considered to be &#39;protected&#39; in Python, and are used</span>
<span class="sd">        internally.</span>

<span class="sd">    3 - Expando&#39;s dynamic properties are not able to store empty lists.</span>
<span class="sd">        Attempting to assign an empty list to a dynamic property will raise</span>
<span class="sd">        ValueError.  Static properties on Expando can still support empty</span>
<span class="sd">        lists but like normal Model properties is restricted from using</span>
<span class="sd">        None.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_dynamic_properties</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">_app</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new instance of this expando model.</span>

<span class="sd">    Args:</span>
<span class="sd">      parent: Parent instance for this instance or None, indicating a top-</span>
<span class="sd">        level instance.</span>
<span class="sd">      key_name: Name for new model instance.</span>
<span class="sd">      _app: Intentionally undocumented.</span>
<span class="sd">      args: Keyword arguments mapping to properties of model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">key_name</span><span class="p">,</span> <span class="n">_app</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwds</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_properties</span> <span class="ow">and</span> <span class="n">prop</span> <span class="o">!=</span> <span class="s">&#39;key&#39;</span><span class="p">:</span>



        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">prop</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="s">&#39;__set__&#39;</span><span class="p">)):</span>
          <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">check_reserved_word</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dynamically set field values that are not defined.</span>

<span class="sd">    Tries to set the value on the object normally, but failing that</span>
<span class="sd">    sets the value on the contained entity.</span>

<span class="sd">    Args:</span>
<span class="sd">      key: Name of attribute.</span>
<span class="sd">      value: Value to set for attribute.  Must be compatible with</span>
<span class="sd">        datastore.</span>

<span class="sd">    Raises:</span>
<span class="sd">      ValueError on attempt to assign empty list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check_reserved_word</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;_&#39;</span> <span class="ow">and</span>



        <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="s">&#39;__set__&#39;</span><span class="p">)):</span>
      <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Cannot store empty list to dynamic property </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                         <span class="n">key</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_ALLOWED_EXPANDO_PROPERTY_TYPES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Expando cannot accept values of type &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get attribute from expando.</span>

<span class="sd">    Must be overridden to allow dynamic properties to obscure class attributes.</span>
<span class="sd">    Since all attributes are stored in self._dynamic_properties, the normal</span>
<span class="sd">    __getattribute__ does not attempt to access it until __setattr__ is called.</span>
<span class="sd">    By then, the static attribute being overwritten has already been located</span>
<span class="sd">    and returned from the call.</span>

<span class="sd">    This method short circuits the usual __getattribute__ call when finding a</span>
<span class="sd">    dynamic property and returns it to the user via __getattr__.  __getattr__</span>
<span class="sd">    is called to preserve backward compatibility with older Expando models</span>
<span class="sd">    that may have overridden the original __getattr__.</span>

<span class="sd">    NOTE: Access to properties defined by Python descriptors are not obscured</span>
<span class="sd">    because setting those attributes are done through the descriptor and does</span>
<span class="sd">    not place those attributes in self._dynamic_properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>
      <span class="n">dynamic_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span>
      <span class="k">if</span> <span class="n">dynamic_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dynamic_properties</span><span class="p">:</span>



        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>



  <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If no explicit attribute defined, retrieve value from entity.</span>

<span class="sd">    Tries to get the value on the object normally, but failing that</span>
<span class="sd">    retrieves value from contained entity.</span>

<span class="sd">    Args:</span>
<span class="sd">      key: Name of attribute.</span>

<span class="sd">    Raises:</span>
<span class="sd">      AttributeError when there is no attribute for key on object or</span>
<span class="sd">        contained entity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_dynamic_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span>
    <span class="k">if</span> <span class="n">_dynamic_properties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_dynamic_properties</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">_dynamic_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">),</span> <span class="n">key</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove attribute from expando.</span>

<span class="sd">    Expando is not like normal entities in that undefined fields</span>
<span class="sd">    can be removed.</span>

<span class="sd">    Args:</span>
<span class="sd">      key: Dynamic property to be deleted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span><span class="p">:</span>
      <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">object</span><span class="o">.</span><span class="n">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">dynamic_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine which properties are particular to instance of entity.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Set of names which correspond only to the dynamic properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_to_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store to entity, deleting dynamic properties that no longer exist.</span>

<span class="sd">    When the expando is saved, it is possible that a given property no longer</span>
<span class="sd">    exists.  In this case, the property will be removed from the saved instance.</span>

<span class="sd">    Args:</span>
<span class="sd">      entity: Entity which will receive dynamic properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_to_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="n">entity</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">all_properties</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_properties</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">())</span>
    <span class="n">all_properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_properties</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_properties</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">entity</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_load_entity_values</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load dynamic properties from entity.</span>

<span class="sd">    Expando needs to do a second pass to add the entity values which were</span>
<span class="sd">    ignored by Model because they didn&#39;t have an corresponding predefined</span>
<span class="sd">    property on the model.</span>

<span class="sd">    Args:</span>
<span class="sd">      entity: Entity which contain values to search dyanmic properties for.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entity_values</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">_load_entity_values</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity_values</span><span class="p">:</span>

        <span class="n">entity_values</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">entity_values</span>


<span class="k">class</span> <span class="nc">_BaseQuery</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Base class for both Query and GqlQuery.&quot;&quot;&quot;</span>

  <span class="n">_last_raw_query</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_last_index_list</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_cursor</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_end_cursor</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      model_class: Model class from which entities are constructed.</span>
<span class="sd">      keys_only: Whether the query should return full entities or only keys.</span>
<span class="sd">      compile: Whether the query should also return a compiled query.</span>
<span class="sd">      cursor: A compiled query from which to resume.</span>
<span class="sd">      namespace: The namespace to query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span> <span class="o">=</span> <span class="n">model_class</span>

  <span class="k">def</span> <span class="nf">is_keys_only</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns whether this query is keys only.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if this query returns keys, False if it returns entities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

  <span class="k">def</span> <span class="nf">projection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the tuple of properties in the projection or None.</span>

<span class="sd">    Projected results differ from normal results in multiple ways:</span>
<span class="sd">    - they only contain a portion of the original entity and cannot be put;</span>
<span class="sd">    - properties defined on the model, but not included in the projections will</span>
<span class="sd">      have a value of None, even if the property is required or has a default</span>
<span class="sd">      value;</span>
<span class="sd">    - multi-valued properties (such as a ListProperty) will only contain a single</span>
<span class="sd">      value.</span>
<span class="sd">    - dynamic properties not included in the projection will not appear</span>
<span class="sd">      on the model instance.</span>
<span class="sd">    - dynamic properties included in the projection are deserialized into</span>
<span class="sd">      their indexed type. Specifically one of str, bool, long, float, GeoPt, Key</span>
<span class="sd">      or User. If the original type is known, it can be restored using</span>
<span class="sd">      datastore_types.RestoreFromIndexValue.</span>

<span class="sd">    However, projection queries are significantly faster than normal queries.</span>

<span class="sd">    Projection queries on entities with multi-valued properties will return the</span>
<span class="sd">    same entity multiple times, once for each unique combination of values for</span>
<span class="sd">    properties included in the order, an inequaly property, or the projected</span>
<span class="sd">    properties.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The list of properties in the projection, or None if no projection is</span>
<span class="sd">      set on this query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

  <span class="k">def</span> <span class="nf">is_distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns true if the projection query should be distinct.</span>

<span class="sd">    This is equivalent to the SQL syntax: SELECT DISTINCT. It is only available</span>
<span class="sd">    for projection queries, it is not valid to specify distinct without also</span>
<span class="sd">    specifying projection properties.</span>

<span class="sd">    Distinct projection queries on entities with multi-valued properties will</span>
<span class="sd">    return the same entity multiple times, once for each unique combination of</span>
<span class="sd">    properties included in the projection.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if this projection query is distinct.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

  <span class="k">def</span> <span class="nf">_get_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclass must override (and not call their super method).</span>

<span class="sd">    Returns:</span>
<span class="sd">      A datastore.Query instance representing the query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator for this query.</span>

<span class="sd">    If you know the number of results you need, use run(limit=...) instead,</span>
<span class="sd">    or use a GQL query with a LIMIT clause. It&#39;s more efficient. If you want</span>
<span class="sd">    all results use run(batch_size=&lt;large number&gt;).</span>

<span class="sd">    Args:</span>
<span class="sd">      kwargs: Any keyword arguments accepted by datastore_query.QueryOptions().</span>

<span class="sd">    Returns:</span>
<span class="sd">      Iterator for this query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raw_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_query</span><span class="p">()</span>
    <span class="n">iterator</span> <span class="o">=</span> <span class="n">raw_query</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_last_raw_query</span> <span class="o">=</span> <span class="n">raw_query</span>

    <span class="n">keys_only</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;keys_only&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keys_only</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">keys_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_keys_only</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">keys_only</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">iterator</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">_QueryIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">,</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterator</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator for this query.</span>

<span class="sd">    If you know the number of results you need, consider fetch() instead,</span>
<span class="sd">    or use a GQL query with a LIMIT clause. It&#39;s more efficient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">state</span><span class="p">[</span><span class="s">&#39;_last_raw_query&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">state</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get first result from this.</span>

<span class="sd">    Beware: get() ignores the LIMIT clause on GQL queries.</span>

<span class="sd">    Args:</span>
<span class="sd">      kwargs: Any keyword arguments accepted by datastore_query.QueryOptions().</span>

<span class="sd">    Returns:</span>
<span class="sd">      First result from running the query if there are any, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Number of entities this query fetches.</span>

<span class="sd">    Beware: count() ignores the LIMIT clause on GQL queries.</span>

<span class="sd">    Args:</span>
<span class="sd">      limit: A number. If there are more results than this, stop short and</span>
<span class="sd">        just return this number. Providing this argument makes the count</span>
<span class="sd">        operation more efficient.</span>
<span class="sd">      kwargs: Any keyword arguments accepted by datastore_query.QueryOptions().</span>

<span class="sd">    Returns:</span>
<span class="sd">      Number of entities this query fetches.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raw_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_query</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">raw_query</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_last_raw_query</span> <span class="o">=</span> <span class="n">raw_query</span>

    <span class="k">return</span> <span class="n">result</span>

  <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of items selected using SQL-like limit and offset.</span>

<span class="sd">    Always use run(limit=...) instead of fetch() when iterating over a query.</span>

<span class="sd">    Beware: offset must read and discard all skipped entities. Use</span>
<span class="sd">    cursor()/with_cursor() instead.</span>

<span class="sd">    Args:</span>
<span class="sd">      limit: Maximum number of results to return.</span>
<span class="sd">      offset: Optional number of results to skip first; default zero.</span>
<span class="sd">      kwargs: Any keyword arguments accepted by datastore_query.QueryOptions().</span>

<span class="sd">    Returns:</span>
<span class="sd">      A list of db.Model instances.  There may be fewer than &#39;limit&#39;</span>
<span class="sd">      results if there aren&#39;t enough results to satisfy the request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;batch_size&#39;</span><span class="p">,</span> <span class="n">datastore</span><span class="o">.</span><span class="n">_MAX_INT_32</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">index_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the index list for an already executed query.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A list of indexes used by the query.</span>

<span class="sd">    Raises:</span>
<span class="sd">      AssertionError: If the query has not been executed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_raw_query</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;No index list because query has not been run.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_index_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">raw_index_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_raw_query</span><span class="o">.</span><span class="n">GetIndexList</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_last_index_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_index_converter</span><span class="p">(</span><span class="n">raw_index</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">raw_index</span> <span class="ow">in</span> <span class="n">raw_index_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_index_list</span>

  <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a serialized cursor for an already executed query.</span>

<span class="sd">    The returned cursor effectively lets a future invocation of a similar</span>
<span class="sd">    query to begin fetching results immediately after the last returned</span>
<span class="sd">    result from this query invocation.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A base64-encoded serialized cursor.</span>

<span class="sd">    Raises:</span>
<span class="sd">      AssertionError: If the query has not been executed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_raw_query</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;No cursor available.&#39;</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_raw_query</span><span class="o">.</span><span class="n">GetCursor</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">websafe_encode_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">with_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_cursor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">end_cursor</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the start and end of this query using serialized cursors.</span>

<span class="sd">    Conceptually cursors point to the position between the last result returned</span>
<span class="sd">    and the next result so running a query with each of the following cursors</span>
<span class="sd">    combinations will return all results in four chunks with no duplicate</span>
<span class="sd">    results:</span>

<span class="sd">      query.with_cursor(end_cursor=cursor1)</span>
<span class="sd">      query.with_cursors(cursor1, cursor2)</span>
<span class="sd">      query.with_cursors(cursor2, cursor3)</span>
<span class="sd">      query.with_cursors(start_cursor=cursor3)</span>

<span class="sd">    For example if the cursors pointed to:</span>
<span class="sd">      cursor:    1   2   3</span>
<span class="sd">      result: a b c d e f g h</span>

<span class="sd">    The results returned by these queries would be [a, b], [c, d], [e, f],</span>
<span class="sd">    [g, h] respectively.</span>

<span class="sd">    Cursors are pinned to the position just after the previous result (last</span>
<span class="sd">    result, exclusive), so if results are inserted or deleted between the time</span>
<span class="sd">    the cursor was made and these queries are executed, the cursors stay pinned</span>
<span class="sd">    to these positions. For example:</span>

<span class="sd">      delete(b, f, g, h)</span>
<span class="sd">      put(a1, b1, c1, d1)</span>
<span class="sd">      cursor:     1(b)      2(d)   3(f)</span>
<span class="sd">      result: a a1 b1 c c1 d d1 e</span>

<span class="sd">    The results returned by these queries would now be: [a, a1], [b1, c, c1, d],</span>
<span class="sd">    [d1, e], [] respectively.</span>

<span class="sd">    Args:</span>
<span class="sd">      start_cursor: The cursor position at which to start or None</span>
<span class="sd">      end_cursor: The cursor position at which to end or None</span>

<span class="sd">    Returns:</span>
<span class="sd">      This Query instance, for chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError when cursor is not valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">start_cursor</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="n">websafe_decode_cursor</span><span class="p">(</span><span class="n">start_cursor</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">end_cursor</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_end_cursor</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_end_cursor</span> <span class="o">=</span> <span class="n">websafe_decode_cursor</span><span class="p">(</span><span class="n">end_cursor</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Support for query[index] and query[start:stop].</span>

<span class="sd">    Beware: this ignores the LIMIT clause on GQL queries.</span>

<span class="sd">    Args:</span>
<span class="sd">      arg: Either a single integer, corresponding to the query[index]</span>
<span class="sd">        syntax, or a Python slice object, corresponding to the</span>
<span class="sd">        query[start:stop] or query[start:stop:step] syntax.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A single Model instance when the argument is a single integer.</span>
<span class="sd">      A list of Model instances when the argument is a slice.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
      <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">step</span>
      <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Open-ended slices are not supported&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">step</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s">&#39;Only slices with start&gt;=0, stop&gt;=0, step==1 are supported&#39;</span><span class="p">)</span>
      <span class="n">limit</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
      <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
      <span class="k">if</span> <span class="n">arg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Only indices &gt;= 0 are supported&#39;</span><span class="p">)</span>
      <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;The query returned fewer than </span><span class="si">%d</span><span class="s"> results&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Only integer indices and slices are supported&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_QueryIterator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Wraps the datastore iterator to return Model instances.</span>

<span class="sd">  The datastore returns entities. We wrap the datastore iterator to</span>
<span class="sd">  return Model instances instead.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">datastore_iterator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator constructor</span>

<span class="sd">    Args:</span>
<span class="sd">      model_class: Model class from which entities are constructed.</span>
<span class="sd">      datastore_iterator: Underlying datastore iterator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__model_class</span> <span class="o">=</span> <span class="n">model_class</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__iterator</span> <span class="o">=</span> <span class="n">datastore_iterator</span>

  <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator on self.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Self.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get next Model instance in query results.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Next model instance.</span>

<span class="sd">    Raises:</span>
<span class="sd">      StopIteration when there are no more results in query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__model_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__model_class</span><span class="o">.</span><span class="n">from_entity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__iterator</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__iterator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">model_class</span> <span class="o">=</span> <span class="n">class_for_kind</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">KindError</span><span class="p">:</span>

          <span class="k">if</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">RESERVED_PROPERTY_NAME</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">kind</span><span class="p">()):</span>
            <span class="k">continue</span>
          <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">model_class</span><span class="o">.</span><span class="n">from_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_normalize_query_parameter</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Make any necessary type conversions to a query parameter.</span>

<span class="sd">  The following conversions are made:</span>
<span class="sd">    - Model instances are converted to Key instances.  This is necessary so</span>
<span class="sd">      that querying reference properties will work.</span>
<span class="sd">    - datetime.date objects are converted to datetime.datetime objects (see</span>
<span class="sd">      _date_to_datetime for details on this conversion).  This is necessary so</span>
<span class="sd">      that querying date properties with date objects will work.</span>
<span class="sd">    - datetime.time objects are converted to datetime.datetime objects (see</span>
<span class="sd">      _time_to_datetime for details on this conversion).  This is necessary so</span>
<span class="sd">      that querying time properties with time objects will work.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: The query parameter value.</span>

<span class="sd">  Returns:</span>
<span class="sd">    The input value, or a converted value if value matches one of the</span>
<span class="sd">    conversions specified above.</span>
<span class="sd">  &quot;&quot;&quot;</span>



  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="ow">and</span>
      <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">_date_to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">_time_to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="n">_BaseQuery</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Query instance queries over instances of Models.</span>

<span class="sd">  You construct a query with a model class, like this:</span>

<span class="sd">     class Story(db.Model):</span>
<span class="sd">       title = db.StringProperty()</span>
<span class="sd">       date = db.DateTimeProperty()</span>

<span class="sd">     query = Query(Story)</span>

<span class="sd">  You modify a query with filters and orders like this:</span>

<span class="sd">     query.filter(&#39;title =&#39;, &#39;Foo&#39;)</span>
<span class="sd">     query.order(&#39;-date&#39;)</span>
<span class="sd">     query.ancestor(key_or_model_instance)</span>

<span class="sd">  Every query can return an iterator, so you access the results of a query</span>
<span class="sd">  by iterating over it:</span>

<span class="sd">     for story in query:</span>
<span class="sd">       print story.title</span>

<span class="sd">  For convenience, all of the filtering and ordering methods return &quot;self&quot;,</span>
<span class="sd">  so the easiest way to use the query interface is to cascade all filters and</span>
<span class="sd">  orders in the iterator line like this:</span>

<span class="sd">     for story in Query(story).filter(&#39;title =&#39;, &#39;Foo&#39;).order(&#39;-date&#39;):</span>
<span class="sd">       print story.title</span>
<span class="sd">  &quot;&quot;&quot;</span>


  <span class="n">_keys_only</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">_distinct</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">_projection</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_namespace</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_app</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">__ancestor</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">keys_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">namespace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">_app</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructs a query over instances of the given Model.</span>

<span class="sd">    Args:</span>
<span class="sd">      model_class: Model class to build query for.</span>
<span class="sd">      keys_only: Whether the query should return full entities or only keys.</span>
<span class="sd">      projection: A tuple of strings representing the property names to include</span>
<span class="sd">        in the projection this query should produce or None. Setting a</span>
<span class="sd">        projection is similar to specifying &#39;SELECT prop1, prop2, ...&#39; in SQL.</span>
<span class="sd">        See _BaseQuery.projection for details on projection queries.</span>
<span class="sd">      distinct: A boolean, true if the projection should be distinct.</span>
<span class="sd">        See _BaseQuery.is_distinct for details on distinct queries.</span>
<span class="sd">      cursor: A compiled query from which to resume.</span>
<span class="sd">      namespace: The namespace to use for this query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">keys_only</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_keys_only</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_projection</span> <span class="o">=</span> <span class="n">projection</span>
    <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">=</span> <span class="n">namespace</span>
    <span class="k">if</span> <span class="n">_app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_app</span> <span class="o">=</span> <span class="n">_app</span>
    <span class="k">if</span> <span class="n">distinct</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__query_sets</span> <span class="o">=</span> <span class="p">[{}]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">with_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">is_keys_only</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys_only</span>

  <span class="k">def</span> <span class="nf">projection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projection</span>

  <span class="k">def</span> <span class="nf">is_distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span>

  <span class="k">def</span> <span class="nf">_get_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">_query_class</span><span class="o">=</span><span class="n">datastore</span><span class="o">.</span><span class="n">Query</span><span class="p">,</span>
                 <span class="n">_multi_query_class</span><span class="o">=</span><span class="n">datastore</span><span class="o">.</span><span class="n">MultiQuery</span><span class="p">):</span>






    <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">query_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query_sets</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">query</span> <span class="o">=</span> <span class="n">_query_class</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span>
                           <span class="n">query_set</span><span class="p">,</span>
                           <span class="n">keys_only</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys_only</span><span class="p">,</span>
                           <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">,</span>
                           <span class="n">distinct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span><span class="p">,</span>
                           <span class="nb">compile</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                           <span class="n">cursor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="p">,</span>
                           <span class="n">end_cursor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_cursor</span><span class="p">,</span>
                           <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">,</span>
                           <span class="n">_app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>
      <span class="n">query</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span><span class="p">)</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ancestor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">query</span><span class="o">.</span><span class="n">Ancestor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__ancestor</span><span class="p">)</span>
      <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">_query_class</span> <span class="o">!=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Query</span> <span class="ow">and</span>
        <span class="n">_multi_query_class</span> <span class="o">==</span> <span class="n">datastore</span><span class="o">.</span><span class="n">MultiQuery</span><span class="p">):</span>



      <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
          <span class="s">&#39;Custom _query_class specified without corresponding custom&#39;</span>
          <span class="s">&#39; _query_multi_class. Things will break if you use queries with&#39;</span>
          <span class="s">&#39; the &quot;IN&quot; or &quot;!=&quot; operators.&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&#39;Query requires multiple subqueries to satisfy. If _query_class&#39;</span>
            <span class="s">&#39; is overridden, _multi_query_class must also be overridden.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">_query_class</span> <span class="o">==</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Query</span> <span class="ow">and</span>
          <span class="n">_multi_query_class</span> <span class="o">!=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">MultiQuery</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadArgumentError</span><span class="p">(</span><span class="s">&#39;_query_class must also be overridden if&#39;</span>
                             <span class="s">&#39; _multi_query_class is overridden.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">queries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">_multi_query_class</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__filter_disjunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a disjunction of several filters and several values to the query.</span>

<span class="sd">    This is implemented by duplicating queries and combining the</span>
<span class="sd">    results later.</span>

<span class="sd">    Args:</span>
<span class="sd">      operations: a string or list of strings. Each string contains a</span>
<span class="sd">        property name and an operator to filter by. The operators</span>
<span class="sd">        themselves must not require multiple queries to evaluate</span>
<span class="sd">        (currently, this means that &#39;in&#39; and &#39;!=&#39; are invalid).</span>

<span class="sd">      values: a value or list of filter values, normalized by</span>
<span class="sd">        _normalize_query_parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operations</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
      <span class="n">operations</span> <span class="o">=</span> <span class="p">[</span><span class="n">operations</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
      <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>

    <span class="n">new_query_sets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>


      <span class="k">if</span> <span class="n">operation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;in&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">operation</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;!=&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">BadQueryError</span><span class="p">(</span><span class="s">&#39;Cannot use &quot;in&quot; or &quot;!=&quot; in a disjunction.&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">query_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query_sets</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>



          <span class="n">new_query_set</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">query_set</span><span class="p">)</span>
          <span class="n">datastore</span><span class="o">.</span><span class="n">_AddOrAppend</span><span class="p">(</span><span class="n">new_query_set</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
          <span class="n">new_query_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_query_set</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__query_sets</span> <span class="o">=</span> <span class="n">new_query_sets</span>

  <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">property_operator</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add filter to query.</span>

<span class="sd">    Args:</span>
<span class="sd">      property_operator: string with the property and operator to filter by.</span>
<span class="sd">      value: the filter value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Self to support method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">      PropertyError if invalid property is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">_FILTER_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">property_operator</span><span class="p">)</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">operator</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">operator</span> <span class="o">=</span> <span class="s">&#39;==&#39;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">prop</span> <span class="o">!=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadQueryError</span><span class="p">(</span>
            <span class="s">&#39;Only </span><span class="si">%s</span><span class="s"> filters are allowed on kindless queries.&#39;</span> <span class="o">%</span>
            <span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="n">_unindexed_properties</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">PropertyError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is not indexed&#39;</span> <span class="o">%</span> <span class="n">prop</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">operator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;in&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys_only</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadQueryError</span><span class="p">(</span><span class="s">&#39;Keys only queries do not support IN filters.&#39;</span><span class="p">)</span>
      <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Argument to the &quot;in&quot; operator must be a list&#39;</span><span class="p">)</span>
      <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">_normalize_query_parameter</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__filter_disjunction</span><span class="p">(</span><span class="n">prop</span> <span class="o">+</span> <span class="s">&#39; =&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Filtering on lists is not supported&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">operator</span> <span class="o">==</span> <span class="s">&#39;!=&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys_only</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">BadQueryError</span><span class="p">(</span><span class="s">&#39;Keys only queries do not support != filters.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__filter_disjunction</span><span class="p">([</span><span class="n">prop</span> <span class="o">+</span> <span class="s">&#39; &lt;&#39;</span><span class="p">,</span> <span class="n">prop</span> <span class="o">+</span> <span class="s">&#39; &gt;&#39;</span><span class="p">],</span>
                                  <span class="n">_normalize_query_parameter</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">_normalize_query_parameter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">query_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__query_sets</span><span class="p">:</span>
          <span class="n">datastore</span><span class="o">.</span><span class="n">_AddOrAppend</span><span class="p">(</span><span class="n">query_set</span><span class="p">,</span> <span class="n">property_operator</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set order of query result.</span>

<span class="sd">    To use descending order, prepend &#39;-&#39; (minus) to the property</span>
<span class="sd">    name, e.g., &#39;-date&#39; rather than &#39;date&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">      property: Property to sort on.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Self to support method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">      PropertyError if invalid property is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>



    <span class="k">if</span> <span class="nb">property</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
      <span class="nb">property</span> <span class="o">=</span> <span class="nb">property</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
      <span class="n">order</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Query</span><span class="o">.</span><span class="n">DESCENDING</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">order</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Query</span><span class="o">.</span><span class="n">ASCENDING</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">property</span> <span class="o">!=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span> <span class="ow">or</span>
          <span class="n">order</span> <span class="o">!=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Query</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">BadQueryError</span><span class="p">(</span>
            <span class="s">&#39;Only </span><span class="si">%s</span><span class="s"> ascending orders are supported on kindless queries&#39;</span> <span class="o">%</span>
            <span class="n">datastore_types</span><span class="o">.</span><span class="n">KEY_SPECIAL_PROPERTY</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="p">,</span> <span class="n">Expando</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">property</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="n">_all_properties</span> <span class="ow">and</span>
            <span class="nb">property</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_SPECIAL_PROPERTIES</span><span class="p">):</span>
          <span class="k">raise</span> <span class="n">PropertyError</span><span class="p">(</span><span class="s">&#39;Invalid property name </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">property</span><span class="p">)</span>

      <span class="k">if</span> <span class="nb">property</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_class</span><span class="o">.</span><span class="n">_unindexed_properties</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PropertyError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is not indexed&#39;</span> <span class="o">%</span> <span class="nb">property</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">__orderings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">property</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="nf">ancestor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ancestor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets an ancestor for this query.</span>

<span class="sd">    This restricts the query to only return results that descend from</span>
<span class="sd">    a given model instance. In other words, all of the results will</span>
<span class="sd">    have the ancestor as their parent, or parent&#39;s parent, etc.  The</span>
<span class="sd">    ancestor itself is also a possible result!</span>

<span class="sd">    Args:</span>
<span class="sd">      ancestor: Model or Key (that has already been saved)</span>

<span class="sd">    Returns:</span>
<span class="sd">      Self to support method chaining.</span>

<span class="sd">    Raises:</span>
<span class="sd">      TypeError if the argument isn&#39;t a Key or Model; NotSavedError</span>
<span class="sd">      if it is, but isn&#39;t saved yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">has_id_or_name</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ancestor</span> <span class="o">=</span> <span class="n">ancestor</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotSavedError</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">has_key</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__ancestor</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">key</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotSavedError</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;ancestor should be Key or Model&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">GqlQuery</span><span class="p">(</span><span class="n">_BaseQuery</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Query class that uses GQL query syntax instead of .filter() etc.&quot;&quot;&quot;</span>



  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      query_string: Properly formatted GQL query string.</span>
<span class="sd">      *args: Positional arguments used to bind numeric references in the query.</span>
<span class="sd">      **kwds: Dictionary-based arguments for named references.</span>

<span class="sd">    Raises:</span>
<span class="sd">      PropertyError if the query filters or sorts on a property that&#39;s not</span>
<span class="sd">      indexed.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">gql</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_app&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadArgumentError</span><span class="p">(</span><span class="s">&#39;_app must have 2 values if type is tuple.&#39;</span><span class="p">)</span>
      <span class="n">app</span><span class="p">,</span> <span class="n">namespace</span> <span class="o">=</span> <span class="n">app</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span> <span class="o">=</span> <span class="n">gql</span><span class="o">.</span><span class="n">GQL</span><span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">_app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">_kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">model_class</span> <span class="o">=</span> <span class="n">class_for_kind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">_kind</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">model_class</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nb">super</span><span class="p">(</span><span class="n">GqlQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

      <span class="k">for</span> <span class="nb">property</span><span class="p">,</span> <span class="n">unused</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">filters</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">orderings</span><span class="p">()):</span>
        <span class="k">if</span> <span class="nb">property</span> <span class="ow">in</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_unindexed_properties</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">PropertyError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s"> is not indexed&#39;</span> <span class="o">%</span> <span class="nb">property</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">is_keys_only</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">_keys_only</span>

  <span class="k">def</span> <span class="nf">projection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">projection</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">is_distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">is_distinct</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bind arguments (positional or keyword) to the query.</span>

<span class="sd">    Note that you can also pass arguments directly to the query</span>
<span class="sd">    constructor.  Each time you call bind() the previous set of</span>
<span class="sd">    arguments is replaced with the new set.  This is useful because</span>
<span class="sd">    the hard work in in parsing the query; so if you expect to be</span>
<span class="sd">    using the same query with different sets of arguments, you should</span>
<span class="sd">    hold on to the GqlQuery() object and call bind() on it each time.</span>

<span class="sd">    Args:</span>
<span class="sd">      *args: Positional arguments used to bind numeric references in the query.</span>
<span class="sd">      **kwds: Dictionary-based arguments for named references.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_normalize_query_parameter</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_kwds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kwds</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_kwds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_normalize_query_parameter</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterator for this query that handles the LIMIT clause property.</span>

<span class="sd">    If the GQL query string contains a LIMIT clause, this function fetches</span>
<span class="sd">    all results before returning an iterator. Otherwise results are retrieved</span>
<span class="sd">    in batches by the iterator.</span>

<span class="sd">    Args:</span>
<span class="sd">      kwargs: Any keyword arguments accepted by datastore_query.QueryOptions().</span>

<span class="sd">    Returns:</span>
<span class="sd">      Iterator for this query.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">limit</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;limit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">limit</span><span class="p">())</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;offset&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">offset</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">_BaseQuery</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proto_query</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwds</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_cursor</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UnindexedProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property that isn&#39;t indexed by either built-in or composite indices.</span>

<span class="sd">  TextProperty and BlobProperty derive from this class.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct property. See the Property class for details.</span>

<span class="sd">    Raises:</span>
<span class="sd">      ConfigurationError if indexed=True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_require_parameter</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;indexed&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>



    <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;indexed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">UnindexedProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate property.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if property is not an instance of data_type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>



        <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be convertible &#39;</span>
                            <span class="s">&#39;to a </span><span class="si">%s</span><span class="s"> instance (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UnindexedProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be a </span><span class="si">%s</span><span class="s"> instance&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">TextProperty</span><span class="p">(</span><span class="n">UnindexedProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A string that can be longer than 500 bytes.&quot;&quot;&quot;</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">Text</span>


<span class="k">class</span> <span class="nc">StringProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A textual property, which can be multi- or single-line.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">multiline</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct string property.</span>

<span class="sd">    Args:</span>
<span class="sd">      verbose_name: Verbose name is always first parameter.</span>
<span class="sd">      multi-line: Carriage returns permitted in property.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">StringProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">verbose_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">multiline</span> <span class="o">=</span> <span class="n">multiline</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate string property.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if property is not multi-line but value is.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">StringProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span>
          <span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be a str or unicode instance, not a </span><span class="si">%s</span><span class="s">&#39;</span>
          <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiline</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> is not multi-line&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LENGTH</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span>
          <span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> is </span><span class="si">%d</span><span class="s"> characters long; it must be </span><span class="si">%d</span><span class="s"> or less.&#39;</span>
          <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LENGTH</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">500</span>
  <span class="n">data_type</span> <span class="o">=</span> <span class="nb">basestring</span>


<span class="k">class</span> <span class="nc">_CoercingProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property subclass that extends validate() to coerce to self.data_type.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Coerce values (except None) to self.data_type.</span>

<span class="sd">    Args:</span>
<span class="sd">      value: The value to be validated and coerced.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The coerced and validated value.  It is guaranteed that this is</span>
<span class="sd">      either None or an instance of self.data_type; otherwise an exception</span>
<span class="sd">      is raised.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if the value could not be validated or coerced.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">_CoercingProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">):</span>

      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">CategoryProperty</span><span class="p">(</span><span class="n">_CoercingProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property whose values are Category instances.&quot;&quot;&quot;</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">Category</span>


<span class="k">class</span> <span class="nc">LinkProperty</span><span class="p">(</span><span class="n">_CoercingProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property whose values are Link instances.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">LinkProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>


      <span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">scheme</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">netloc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be a full URL (</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">)&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">Link</span>

<span class="n">URLProperty</span> <span class="o">=</span> <span class="n">LinkProperty</span>


<span class="k">class</span> <span class="nc">EmailProperty</span><span class="p">(</span><span class="n">_CoercingProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property whose values are Email instances.&quot;&quot;&quot;</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">Email</span>


<span class="k">class</span> <span class="nc">GeoPtProperty</span><span class="p">(</span><span class="n">_CoercingProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property whose values are GeoPt instances.&quot;&quot;&quot;</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">GeoPt</span>


<span class="k">class</span> <span class="nc">IMProperty</span><span class="p">(</span><span class="n">_CoercingProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property whose values are IM instances.&quot;&quot;&quot;</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">IM</span>


<span class="k">class</span> <span class="nc">PhoneNumberProperty</span><span class="p">(</span><span class="n">_CoercingProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property whose values are PhoneNumber instances.&quot;&quot;&quot;</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">PhoneNumber</span>


<span class="k">class</span> <span class="nc">PostalAddressProperty</span><span class="p">(</span><span class="n">_CoercingProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property whose values are PostalAddress instances.&quot;&quot;&quot;</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">PostalAddress</span>


<span class="k">class</span> <span class="nc">BlobProperty</span><span class="p">(</span><span class="n">UnindexedProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A byte string that can be longer than 500 bytes.&quot;&quot;&quot;</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">Blob</span>


<span class="k">class</span> <span class="nc">ByteStringProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A short (&lt;=500 bytes) byte string.</span>

<span class="sd">  This type should be used for short binary values that need to be indexed. If</span>
<span class="sd">  you do not require indexing (regardless of length), use BlobProperty instead.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate ByteString property.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if property is not instance of &#39;ByteString&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ByteString</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">ByteString</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be convertible &#39;</span>
                            <span class="s">&#39;to a ByteString instance (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ByteStringProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ByteString</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be a ByteString instance&#39;</span>
                          <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LENGTH</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span>
          <span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> is </span><span class="si">%d</span><span class="s"> bytes long; it must be </span><span class="si">%d</span><span class="s"> or less.&#39;</span>
          <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_LENGTH</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">500</span>
  <span class="n">data_type</span> <span class="o">=</span> <span class="n">ByteString</span>


<span class="k">class</span> <span class="nc">DateTimeProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The base class of all of our date/time properties.</span>

<span class="sd">  We handle common operations, like converting between time tuples and</span>
<span class="sd">  datetime instances.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">auto_now</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct a DateTimeProperty</span>

<span class="sd">    Args:</span>
<span class="sd">      verbose_name: Verbose name is always first parameter.</span>
<span class="sd">      auto_now: Date/time property is updated with the current time every time</span>
<span class="sd">        it is saved to the datastore.  Useful for properties that want to track</span>
<span class="sd">        the modification time of an instance.</span>
<span class="sd">      auto_now_add: Date/time is set to the when its instance is created.</span>
<span class="sd">        Useful for properties that record the creation time of an entity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">DateTimeProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">verbose_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auto_now</span> <span class="o">=</span> <span class="n">auto_now</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auto_now_add</span> <span class="o">=</span> <span class="n">auto_now_add</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate datetime.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if property is not instance of &#39;datetime&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DateTimeProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be a </span><span class="si">%s</span><span class="s">, but was </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default value for datetime.</span>

<span class="sd">    Returns:</span>
<span class="sd">      value of now() as appropriate to the date-time instance if auto_now</span>
<span class="sd">      or auto_now_add is set, else user configured default value implementation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_now</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_now_add</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Property</span><span class="o">.</span><span class="n">default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">get_updated_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get new value for property to send to datastore.</span>

<span class="sd">    Returns:</span>
<span class="sd">      now() as appropriate to the date-time instance in the odd case where</span>
<span class="sd">      auto_now is set to True, else AUTO_UPDATE_UNCHANGED.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_now</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">AUTO_UPDATE_UNCHANGED</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get now as a full datetime value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      &#39;now&#39; as a whole timestamp, including both time and date.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_date_to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convert a date to a datetime for datastore storage.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A datetime.date object.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A datetime object with time set to 0:00.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_time_to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convert a time to a datetime for datastore storage.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A datetime.time object.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A datetime object with date set to 1970-01-01.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">value</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                           <span class="n">value</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DateProperty</span><span class="p">(</span><span class="n">DateTimeProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A date property, which stores a date without a time.&quot;&quot;&quot;</span>








  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get now as a date datetime value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      &#39;date&#39; part of &#39;now&#39; only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate date.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if property is not instance of &#39;date&#39;,</span>
<span class="sd">      or if it is an instance of &#39;datetime&#39; (which is a subclass</span>
<span class="sd">      of &#39;date&#39;, but for all practical purposes a different type).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DateProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be a </span><span class="si">%s</span><span class="s">, not a datetime&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">get_updated_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get new value for property to send to datastore.</span>

<span class="sd">    Returns:</span>
<span class="sd">      now() as appropriate to the date instance in the odd case where</span>
<span class="sd">      auto_now is set to True, else AUTO_UPDATE_UNCHANGED.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_now</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">_date_to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">AUTO_UPDATE_UNCHANGED</span>

  <span class="k">def</span> <span class="nf">get_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get value from property to send to datastore.</span>

<span class="sd">    We retrieve a datetime.date from the model instance and return a</span>
<span class="sd">    datetime.datetime instance with the time set to zero.</span>

<span class="sd">    See base class method documentation for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DateProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">_date_to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">make_value_from_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Native representation of this property.</span>

<span class="sd">    We receive a datetime.datetime retrieved from the entity and return</span>
<span class="sd">    a datetime.date instance representing its date portion.</span>

<span class="sd">    See base class method documentation for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span>


<span class="k">class</span> <span class="nc">TimeProperty</span><span class="p">(</span><span class="n">DateTimeProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A time property, which stores a time without a date.&quot;&quot;&quot;</span>








  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get now as a time datetime value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      &#39;time&#39; part of &#39;now&#39; only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Is time property empty.</span>

<span class="sd">    &quot;0:0&quot; (midnight) is not an empty value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if value is None, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">get_updated_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get new value for property to send to datastore.</span>

<span class="sd">    Returns:</span>
<span class="sd">      now() as appropriate to the time instance in the odd case where</span>
<span class="sd">      auto_now is set to True, else AUTO_UPDATE_UNCHANGED.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_now</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">_time_to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">AUTO_UPDATE_UNCHANGED</span>

  <span class="k">def</span> <span class="nf">get_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get value from property to send to datastore.</span>

<span class="sd">    We retrieve a datetime.time from the model instance and return a</span>
<span class="sd">    datetime.datetime instance with the date set to 1/1/1970.</span>

<span class="sd">    See base class method documentation for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TimeProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">_time_to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">make_value_from_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Native representation of this property.</span>

<span class="sd">    We receive a datetime.datetime retrieved from the entity and return</span>
<span class="sd">    a datetime.date instance representing its time portion.</span>

<span class="sd">    See base class method documentation for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span>


<span class="k">class</span> <span class="nc">IntegerProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;An integer property.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate integer property.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if value is not an integer or long instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IntegerProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span>





    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be an int or long, not a </span><span class="si">%s</span><span class="s">&#39;</span>
                          <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mh">0x8000000000000000</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mh">0x7fffffffffffffff</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must fit in 64 bits&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="nb">int</span>

  <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Is integer property empty.</span>

<span class="sd">    0 is not an empty value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if value is None, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">RatingProperty</span><span class="p">(</span><span class="n">_CoercingProperty</span><span class="p">,</span> <span class="n">IntegerProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property whose values are Rating instances.&quot;&quot;&quot;</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">Rating</span>


<span class="k">class</span> <span class="nc">FloatProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A float property.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate float.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if property is not instance of &#39;float&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FloatProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be a float&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="nb">float</span>

  <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Is float property empty.</span>

<span class="sd">    0.0 is not an empty value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if value is None, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">BooleanProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A boolean property.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate boolean.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if property is not instance of &#39;bool&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BooleanProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be a bool&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="nb">bool</span>

  <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Is boolean property empty.</span>

<span class="sd">    False is not an empty value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if value is None, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">UserProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A user property.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">validator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">choices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">auto_current_user</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">auto_current_user_add</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">indexed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initializes this Property with the given options.</span>

<span class="sd">    Note: this does *not* support the &#39;default&#39; keyword argument.</span>
<span class="sd">    Use auto_current_user_add=True instead.</span>

<span class="sd">    Args:</span>
<span class="sd">      verbose_name: User friendly name of property.</span>
<span class="sd">      name: Storage name for property.  By default, uses attribute name</span>
<span class="sd">        as it is assigned in the Model sub-class.</span>
<span class="sd">      required: Whether property is required.</span>
<span class="sd">      validator: User provided method used for validation.</span>
<span class="sd">      choices: User provided set of valid property values.</span>
<span class="sd">      auto_current_user: If true, the value is set to the current user</span>
<span class="sd">        each time the entity is written to the datastore.</span>
<span class="sd">      auto_current_user_add: If true, the value is set to the current user</span>
<span class="sd">        the first time the entity is written to the datastore.</span>
<span class="sd">      indexed: Whether property is indexed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">UserProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">verbose_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                       <span class="n">required</span><span class="o">=</span><span class="n">required</span><span class="p">,</span>
                                       <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
                                       <span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">,</span>
                                       <span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auto_current_user</span> <span class="o">=</span> <span class="n">auto_current_user</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">auto_current_user_add</span> <span class="o">=</span> <span class="n">auto_current_user_add</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate user.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if property is not instance of &#39;User&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UserProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">User</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be a User&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default value for user.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Value of users.get_current_user() if auto_current_user or</span>
<span class="sd">      auto_current_user_add is set; else None. (But *not* the default</span>
<span class="sd">      implementation, since we don&#39;t support the &#39;default&#39; keyword</span>
<span class="sd">      argument.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_current_user</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_current_user_add</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">get_updated_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get new value for property to send to datastore.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Value of users.get_current_user() if auto_current_user is set;</span>
<span class="sd">      else AUTO_UPDATE_UNCHANGED.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_current_user</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">AUTO_UPDATE_UNCHANGED</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">User</span>


<span class="k">class</span> <span class="nc">ListProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property that stores a list of things.</span>

<span class="sd">  This is a parameterized property; the parameter must be a valid</span>
<span class="sd">  non-list data type, and all items must conform to this type.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item_type</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct ListProperty.</span>

<span class="sd">    Args:</span>
<span class="sd">      item_type: Type for the list items; must be one of the allowed property</span>
<span class="sd">        types.</span>
<span class="sd">      verbose_name: Optional verbose name.</span>
<span class="sd">      default: Optional default value; if omitted, an empty list is used.</span>
<span class="sd">      **kwds: Optional additional keyword arguments, passed to base class.</span>

<span class="sd">    Note that the only permissible value for &#39;required&#39; is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">item_type</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
      <span class="n">item_type</span> <span class="o">=</span> <span class="nb">basestring</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Item type should be a type object&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">item_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_ALLOWED_PROPERTY_TYPES</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Item type </span><span class="si">%s</span><span class="s"> is not acceptable&#39;</span> <span class="o">%</span> <span class="n">item_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">item_type</span><span class="p">,</span> <span class="p">(</span><span class="n">Blob</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_require_parameter</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;indexed&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>



      <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;indexed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_require_parameter</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;required&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">default</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">item_type</span> <span class="o">=</span> <span class="n">item_type</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ListProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">verbose_name</span><span class="p">,</span>
                                       <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                                       <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate list.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if property is not a list whose items are instances of</span>
<span class="sd">      the item_type given to the constructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ListProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be a list&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_list_contents</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
      <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ListProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">validate_list_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validates that all items in the list are of the correct type.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The validated list.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if the list has items are not instances of the</span>
<span class="sd">      item_type given to the constructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_type</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">):</span>
      <span class="n">item_type</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">item_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_type</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">item_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item_type</span> <span class="o">==</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">):</span>
          <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Items in the </span><span class="si">%s</span><span class="s"> list must all be integers.&#39;</span> <span class="o">%</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span>
              <span class="s">&#39;Items in the </span><span class="si">%s</span><span class="s"> list must all be </span><span class="si">%s</span><span class="s"> instances&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Is list property empty.</span>

<span class="sd">    [] is not an empty value.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if value is None, else false.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span>

  <span class="n">data_type</span> <span class="o">=</span> <span class="nb">list</span>

  <span class="k">def</span> <span class="nf">default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default value for list.</span>

<span class="sd">    Because the property supplied to &#39;default&#39; is a static value,</span>
<span class="sd">    that value must be shallow copied to prevent all fields with</span>
<span class="sd">    default values from sharing the same instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Copy of the default value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">ListProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">default_value</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">get_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get value from property to send to datastore.</span>

<span class="sd">    Returns:</span>
<span class="sd">      validated list appropriate to save in the datastore.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ListProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_list_contents</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>









    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_type</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">_date_to_datetime</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_type</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">_time_to_datetime</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">make_value_from_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Native representation of this property.</span>

<span class="sd">    If this list is a list of datetime.date or datetime.time, we convert</span>
<span class="sd">    the list of datetime.datetime retrieved from the entity into</span>
<span class="sd">    datetime.date or datetime.time.</span>

<span class="sd">    See base class method documentation for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_type</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_type</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">make_value_from_datastore_index_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_value</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">datastore_types</span><span class="o">.</span><span class="n">RestoreFromIndexValue</span><span class="p">(</span><span class="n">index_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_type</span><span class="p">)]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_value_from_datastore</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">StringListProperty</span><span class="p">(</span><span class="n">ListProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property that stores a list of strings.</span>

<span class="sd">  A shorthand for the most common type of ListProperty.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct StringListProperty.</span>

<span class="sd">    Args:</span>
<span class="sd">      verbose_name: Optional verbose name.</span>
<span class="sd">      default: Optional default value; if omitted, an empty list is used.</span>
<span class="sd">      **kwds: Optional additional keyword arguments, passed to ListProperty().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">StringListProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="nb">basestring</span><span class="p">,</span>
                                             <span class="n">verbose_name</span><span class="o">=</span><span class="n">verbose_name</span><span class="p">,</span>
                                             <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                                             <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ReferenceProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property that represents a many-to-one reference to another model.</span>

<span class="sd">  For example, a reference property in model A that refers to model B forms</span>
<span class="sd">  a many-to-one relationship from A to B: every instance of A refers to a</span>
<span class="sd">  single B instance, and every B instance can have many A instances refer</span>
<span class="sd">  to it.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">reference_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">collection_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="o">**</span><span class="n">attrs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct ReferenceProperty.</span>

<span class="sd">    Args:</span>
<span class="sd">      reference_class: Which model class this property references.</span>
<span class="sd">      verbose_name: User friendly name of property.</span>
<span class="sd">      collection_name: If provided, alternate name of collection on</span>
<span class="sd">        reference_class to store back references.  Use this to allow</span>
<span class="sd">        a Model to have multiple fields which refer to the same class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ReferenceProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">verbose_name</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>

    <span class="k">if</span> <span class="n">reference_class</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">reference_class</span> <span class="o">=</span> <span class="n">Model</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">reference_class</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span>
             <span class="nb">issubclass</span><span class="p">(</span><span class="n">reference_class</span><span class="p">,</span> <span class="n">Model</span><span class="p">))</span> <span class="ow">or</span>
            <span class="n">reference_class</span> <span class="ow">is</span> <span class="n">_SELF_REFERENCE</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;reference_class must be Model or _SELF_REFERENCE&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">reference_class</span>

  <span class="k">def</span> <span class="nf">make_value_from_datastore_index_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_value</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">RestoreFromIndexValue</span><span class="p">(</span><span class="n">index_value</span><span class="p">,</span> <span class="n">Key</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_value_from_datastore</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__property_config__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">property_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads all of the references that point to this model.</span>

<span class="sd">    We need to do this to create the ReverseReferenceProperty properties for</span>
<span class="sd">    this model and create the &lt;reference&gt;_set attributes on the referenced</span>
<span class="sd">    model, e.g.:</span>

<span class="sd">       class Story(db.Model):</span>
<span class="sd">         title = db.StringProperty()</span>
<span class="sd">       class Comment(db.Model):</span>
<span class="sd">         story = db.ReferenceProperty(Story)</span>
<span class="sd">       story = Story.get(id)</span>
<span class="sd">       print [c for c in story.comment_set]</span>

<span class="sd">    In this example, the comment_set property was created based on the reference</span>
<span class="sd">    from Comment to Story (which is inherently one to many).</span>

<span class="sd">    Args:</span>
<span class="sd">      model_class: Model class which will have its reference properties</span>
<span class="sd">        initialized.</span>
<span class="sd">      property_name: Name of property being configured.</span>

<span class="sd">    Raises:</span>
<span class="sd">      DuplicatePropertyError if referenced class already has the provided</span>
<span class="sd">        collection name as a property.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ReferenceProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__property_config__</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span>
                                                       <span class="n">property_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span> <span class="ow">is</span> <span class="n">_SELF_REFERENCE</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">model_class</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_set&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model_class</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="n">existing_prop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">existing_prop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>






      <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">existing_prop</span><span class="p">,</span> <span class="n">_ReverseReferenceProperty</span><span class="p">)</span> <span class="ow">and</span>
              <span class="n">existing_prop</span><span class="o">.</span><span class="n">_prop_name</span> <span class="o">==</span> <span class="n">property_name</span> <span class="ow">and</span>
              <span class="n">existing_prop</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="n">model_class</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">and</span>
              <span class="n">existing_prop</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="n">model_class</span><span class="o">.</span><span class="n">__module__</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DuplicatePropertyError</span><span class="p">(</span><span class="s">&#39;Class </span><span class="si">%s</span><span class="s"> already has property </span><span class="si">%s</span><span class="s"> &#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">))</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
            <span class="n">_ReverseReferenceProperty</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">property_name</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get reference object.</span>

<span class="sd">    This method will fetch unresolved entities from the datastore if</span>
<span class="sd">    they are not already loaded.</span>

<span class="sd">    Returns:</span>
<span class="sd">      ReferenceProperty to Model object if property is set, else None.</span>

<span class="sd">    Raises:</span>
<span class="sd">      ReferencePropertyResolveError: if the referenced model does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span>


    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id_attr_name</span><span class="p">()):</span>
      <span class="n">reference_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id_attr_name</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">reference_id</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">reference_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">resolved</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolved_attr_name</span><span class="p">())</span>
      <span class="k">if</span> <span class="n">resolved</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">resolved</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">reference_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">ReferencePropertyResolveError</span><span class="p">(</span>
              <span class="s">&#39;ReferenceProperty failed to be resolved: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
              <span class="n">reference_id</span><span class="o">.</span><span class="n">to_path</span><span class="p">())</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolved_attr_name</span><span class="p">(),</span> <span class="n">instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set reference.&quot;&quot;&quot;</span>



    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id_attr_name</span><span class="p">(),</span> <span class="n">value</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolved_attr_name</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id_attr_name</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolved_attr_name</span><span class="p">(),</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">setattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id_attr_name</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
      <span class="nb">setattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__resolved_attr_name</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">get_value_for_datastore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get key of reference rather than reference itself.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id_attr_name</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate reference.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError for the following reasons:</span>
<span class="sd">        - Value is not saved.</span>
<span class="sd">        - Object not of correct model type for reference.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">has_key</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span>
          <span class="s">&#39;</span><span class="si">%s</span><span class="s"> instance must have a complete key before it can be stored as a &#39;</span>
          <span class="s">&#39;reference&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span>

    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ReferenceProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be an instance of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="o">.</span><span class="n">kind</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">__id_attr_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get attribute of referenced id.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Attribute where to store id of referenced entity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_name</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__resolved_attr_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get attribute of resolved attribute.</span>

<span class="sd">    The resolved attribute is where the actual loaded reference instance is</span>
<span class="sd">    stored on the referring model instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Attribute name of where to store resolved reference model instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s">&#39;_RESOLVED&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_name</span><span class="p">()</span>



<span class="n">Reference</span> <span class="o">=</span> <span class="n">ReferenceProperty</span>


<span class="k">def</span> <span class="nf">SelfReferenceProperty</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create a self reference.</span>

<span class="sd">  Function for declaring a self referencing property on a model.</span>

<span class="sd">  Example:</span>
<span class="sd">    class HtmlNode(db.Model):</span>
<span class="sd">      parent = db.SelfReferenceProperty(&#39;Parent&#39;, &#39;children&#39;)</span>

<span class="sd">  Args:</span>
<span class="sd">    verbose_name: User friendly name of property.</span>
<span class="sd">    collection_name: Name of collection on model.</span>

<span class="sd">  Raises:</span>
<span class="sd">    ConfigurationError if reference_class provided as parameter.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="s">&#39;reference_class&#39;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
        <span class="s">&#39;Do not provide reference_class to self-reference.&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">ReferenceProperty</span><span class="p">(</span><span class="n">_SELF_REFERENCE</span><span class="p">,</span>
                           <span class="n">verbose_name</span><span class="p">,</span>
                           <span class="n">collection_name</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>



<span class="n">SelfReference</span> <span class="o">=</span> <span class="n">SelfReferenceProperty</span>


<span class="k">class</span> <span class="nc">_ReverseReferenceProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The inverse of the Reference property above.</span>

<span class="sd">  We construct reverse references automatically for the model to which</span>
<span class="sd">  the Reference property is pointing to create the one-to-many property for</span>
<span class="sd">  that model.  For example, if you put a Reference property in model A that</span>
<span class="sd">  refers to model B, we automatically create a _ReverseReference property in</span>
<span class="sd">  B called a_set that can fetch all of the model A instances that refer to</span>
<span class="sd">  that instance of model B.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor for reverse reference.</span>

<span class="sd">    Constructor does not take standard values of other property types.</span>

<span class="sd">    Args:</span>
<span class="sd">      model: Model class that this property is a collection of.</span>
<span class="sd">      property: Name of foreign property on referred model that points back</span>
<span class="sd">        to this properties entity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__property</span> <span class="o">=</span> <span class="n">prop</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to access the model class, read-only.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__model</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">_prop_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to access the property name, read-only.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__property</span>

  <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetches collection of model instances of this collection property.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__model</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__property</span> <span class="o">+</span> <span class="s">&#39; =&#39;</span><span class="p">,</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Not possible to set a new collection.&quot;&quot;&quot;</span>

    <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Virtual property is read-only&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ComputedProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Property used for creating properties derived from other values.</span>

<span class="sd">  Certain attributes should never be set by users but automatically</span>
<span class="sd">  calculated at run-time from other values of the same entity.  These</span>
<span class="sd">  values are implemented as persistent properties because they provide</span>
<span class="sd">  useful search keys.</span>

<span class="sd">  A computed property behaves the same as normal properties except that</span>
<span class="sd">  you may not set values on them.  Attempting to do so raises</span>
<span class="sd">  db.DerivedPropertyError which db.Model knows to ignore during entity</span>
<span class="sd">  loading time.  Whenever getattr is used for the property</span>
<span class="sd">  the value is recaclulated.  This happens when the model calls</span>
<span class="sd">  get_value_for_datastore on the property.</span>

<span class="sd">  Example:</span>

<span class="sd">    import string</span>

<span class="sd">    class Person(Model):</span>

<span class="sd">      name = StringProperty(required=True)</span>

<span class="sd">      @db.ComputedProperty</span>
<span class="sd">      def lower_case_name(self):</span>
<span class="sd">        return self.name.lower()</span>

<span class="sd">    # Find all people regardless of case used in name.</span>
<span class="sd">    Person.gql(&#39;WHERE lower_case_name=:1&#39; % name_to_search_for.lower())</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value_function</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      value_function: Callable f(model_instance) -&gt; value used to derive</span>
<span class="sd">        persistent property value for storage in datastore.</span>
<span class="sd">      indexed: Whether or not the attribute should be indexed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ComputedProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__value_function</span> <span class="o">=</span> <span class="n">value_function</span>

  <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Disallow setting this value.</span>

<span class="sd">    Raises:</span>
<span class="sd">      DerivedPropertyError when developer attempts to set attribute manually.</span>
<span class="sd">      Model knows to ignore this exception when getting from datastore.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="n">DerivedPropertyError</span><span class="p">(</span>
        <span class="s">&#39;Computed property </span><span class="si">%s</span><span class="s"> cannot be set.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Derive property value.</span>

<span class="sd">    Args:</span>
<span class="sd">      model_instance: Instance to derive property for in bound method case,</span>
<span class="sd">        else None.</span>
<span class="sd">      model_class: Model class associated with this property descriptor.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Result of calling self.__value_funcion as provided by property</span>
<span class="sd">      constructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__value_function</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="n">dictionary</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convert model to dictionary.</span>

<span class="sd">  Args:</span>
<span class="sd">    model_instance: Model instance for which to make dictionary.</span>
<span class="sd">    dictionary: dict instance or compatible to receive model values.</span>
<span class="sd">      The dictionary is not cleared of original values.  Similar to using</span>
<span class="sd">      dictionary.update.  If dictionary is None, a new dictionary instance is</span>
<span class="sd">      created and returned.</span>

<span class="sd">    Returns:</span>
<span class="sd">      New dictionary appropriate populated with model instances values</span>
<span class="sd">      if entity is None, else entity.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">dictionary</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="n">model_instance</span><span class="o">.</span><span class="n">_to_entity</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">dictionary</span>




<span class="n">run_in_transaction</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">RunInTransaction</span>
<span class="n">run_in_transaction_custom_retries</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">RunInTransactionCustomRetries</span>
<span class="n">run_in_transaction_options</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">RunInTransactionOptions</span>



<span class="n">RunInTransaction</span> <span class="o">=</span> <span class="n">run_in_transaction</span>
<span class="n">RunInTransactionCustomRetries</span> <span class="o">=</span> <span class="n">run_in_transaction_custom_retries</span>
<span class="n">websafe_encode_cursor</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">Cursor</span><span class="o">.</span><span class="n">to_websafe_string</span>
<span class="n">websafe_decode_cursor</span> <span class="o">=</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">Cursor</span><span class="o">.</span><span class="n">from_websafe_string</span>


<span class="n">is_in_transaction</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">IsInTransaction</span>


<span class="n">transactional</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Transactional</span>
<span class="n">non_transactional</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">NonTransactional</span>


<span class="n">create_config</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">CreateConfig</span>
<span class="n">create_transaction_options</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">CreateTransactionOptions</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Google, Inc.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1.4.12',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>