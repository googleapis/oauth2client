

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>google.appengine.ext.ndb.model &mdash; oauth2client 1.4.11 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="oauth2client 1.4.11 documentation" href="../../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../../../../index.html" class="fa fa-home"> oauth2client</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/modules.html">oauth2client</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../source/oauth2client.html">oauth2client package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing.html">Contributor License Agreements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing.html#before-writing-code-file-an-issue">Before writing code, file an issue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing.html#fork-oauth2client">Fork oauth2client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing.html#include-tests">Include tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing.html#make-the-pull-request">Make the pull request</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../../index.html">oauth2client</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
      
    <li>google.appengine.ext.ndb.model</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <h1>Source code for google.appengine.ext.ndb.model</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;Model and Property classes and associated stuff.</span>

<span class="sd">A model class represents the structure of entities stored in the</span>
<span class="sd">datastore.  Applications define model classes to indicate the</span>
<span class="sd">structure of their entities, then instantiate those model classes</span>
<span class="sd">to create entities.</span>

<span class="sd">All model classes must inherit (directly or indirectly) from Model.</span>
<span class="sd">Through the magic of metaclasses, straightforward assignments in the</span>
<span class="sd">model class definition can be used to declare the model&#39;s structure:</span>

<span class="sd">  class Person(Model):</span>
<span class="sd">    name = StringProperty()</span>
<span class="sd">    age = IntegerProperty()</span>

<span class="sd">We can now create a Person entity and write it to the datastore:</span>

<span class="sd">  p = Person(name=&#39;Arthur Dent&#39;, age=42)</span>
<span class="sd">  k = p.put()</span>

<span class="sd">The return value from put() is a Key (see the documentation for</span>
<span class="sd">ndb/key.py), which can be used to retrieve the same entity later:</span>

<span class="sd">  p2 = k.get()</span>
<span class="sd">  p2 == p  # Returns True</span>

<span class="sd">To update an entity, simple change its attributes and write it back</span>
<span class="sd">(note that this doesn&#39;t change the key):</span>

<span class="sd">  p2.name = &#39;Arthur Philip Dent&#39;</span>
<span class="sd">  p2.put()</span>

<span class="sd">We can also delete an entity (by using the key):</span>

<span class="sd">  k.delete()</span>

<span class="sd">The property definitions in the class body tell the system the names</span>
<span class="sd">and the types of the fields to be stored in the datastore, whether</span>
<span class="sd">they must be indexed, their default value, and more.</span>

<span class="sd">Many different Property types exist.  Most are indexed by default, the</span>
<span class="sd">exceptions indicated in the list below:</span>

<span class="sd">- StringProperty: a short text string, limited to 500 bytes</span>

<span class="sd">- TextProperty: an unlimited text string; unindexed</span>

<span class="sd">- BlobProperty: an unlimited byte string; unindexed</span>

<span class="sd">- IntegerProperty: a 64-bit signed integer</span>

<span class="sd">- FloatProperty: a double precision floating point number</span>

<span class="sd">- BooleanProperty: a bool value</span>

<span class="sd">- DateTimeProperty: a datetime object.  Note: App Engine always uses</span>
<span class="sd">  UTC as the timezone</span>

<span class="sd">- DateProperty: a date object</span>

<span class="sd">- TimeProperty: a time object</span>

<span class="sd">- GeoPtProperty: a geographical location, i.e. (latitude, longitude)</span>

<span class="sd">- KeyProperty: a datastore Key value, optionally constrained to</span>
<span class="sd">  referring to a specific kind</span>

<span class="sd">- UserProperty: a User object (for backwards compatibility only)</span>

<span class="sd">- StructuredProperty: a field that is itself structured like an</span>
<span class="sd">  entity; see below for more details</span>

<span class="sd">- LocalStructuredProperty: like StructuredProperty but the on-disk</span>
<span class="sd">  representation is an opaque blob; unindexed</span>

<span class="sd">- ComputedProperty: a property whose value is computed from other</span>
<span class="sd">  properties by a user-defined function.  The property value is</span>
<span class="sd">  written to the datastore so that it can be used in queries, but the</span>
<span class="sd">  value from the datastore is not used when the entity is read back</span>

<span class="sd">- GenericProperty: a property whose type is not constrained; mostly</span>
<span class="sd">  used by the Expando class (see below) but also usable explicitly</span>

<span class="sd">- JsonProperty: a property whose value is any object that can be</span>
<span class="sd">  serialized using JSON; the value written to the datastore is a JSON</span>
<span class="sd">  representation of that object</span>

<span class="sd">- PickleProperty: a property whose value is any object that can be</span>
<span class="sd">  serialized using Python&#39;s pickle protocol; the value written to the</span>
<span class="sd">  datastore is the pickled representation of that object, using the</span>
<span class="sd">  highest available pickle protocol</span>

<span class="sd">Most Property classes have similar constructor signatures.  They</span>
<span class="sd">accept several optional keyword arguments:</span>

<span class="sd">- name=&lt;string&gt;: the name used to store the property value in the</span>
<span class="sd">  datastore.  Unlike the following options, this may also be given as</span>
<span class="sd">  a positional argument</span>

<span class="sd">- indexed=&lt;bool&gt;: indicates whether the property should be indexed</span>
<span class="sd">  (allowing queries on this property&#39;s value)</span>

<span class="sd">- repeated=&lt;bool&gt;: indicates that this property can have multiple</span>
<span class="sd">  values in the same entity.</span>

<span class="sd">- required=&lt;bool&gt;: indicates that this property must be given a value</span>

<span class="sd">- default=&lt;value&gt;: a default value if no explicit value is given</span>

<span class="sd">- choices=&lt;list of values&gt;: a list or tuple of allowable values</span>

<span class="sd">- validator=&lt;function&gt;: a general-purpose validation function.  It</span>
<span class="sd">  will be called with two arguments (prop, value) and should either</span>
<span class="sd">  return the validated value or raise an exception.  It is also</span>
<span class="sd">  allowed for the function to modify the value, but calling it again</span>
<span class="sd">  on the modified value should not modify the value further.  (For</span>
<span class="sd">  example: a validator that returns value.strip() or value.lower() is</span>
<span class="sd">  fine, but one that returns value + &#39;$&#39; is not.)</span>

<span class="sd">- verbose_name=&lt;value&gt;: A human readable name for this property.  This</span>
<span class="sd">  human readable name can be used for html form labels.</span>

<span class="sd">The repeated and required/default options are mutually exclusive: a</span>
<span class="sd">repeated property cannot be required nor can it specify a default</span>
<span class="sd">value (the default is always an empty list and an empty list is always</span>
<span class="sd">an allowed value), but a required property can have a default.</span>

<span class="sd">Some property types have additional arguments.  Some property types</span>
<span class="sd">do not support all options.</span>

<span class="sd">Repeated properties are always represented as Python lists; if there</span>
<span class="sd">is only one value, the list has only one element.  When a new list is</span>
<span class="sd">assigned to a repeated property, all elements of the list are</span>
<span class="sd">validated.  Since it is also possible to mutate lists in place,</span>
<span class="sd">repeated properties are re-validated before they are written to the</span>
<span class="sd">datastore.</span>

<span class="sd">No validation happens when an entity is read from the datastore;</span>
<span class="sd">however property values read that have the wrong type (e.g. a string</span>
<span class="sd">value for an IntegerProperty) are ignored.</span>

<span class="sd">For non-repeated properties, None is always a possible value, and no</span>
<span class="sd">validation is called when the value is set to None.  However for</span>
<span class="sd">required properties, writing the entity to the datastore requires</span>
<span class="sd">the value to be something other than None (and valid).</span>

<span class="sd">The StructuredProperty is different from most other properties; it</span>
<span class="sd">lets you define a sub-structure for your entities.  The substructure</span>
<span class="sd">itself is defined using a model class, and the attribute value is an</span>
<span class="sd">instance of that model class.  However it is not stored in the</span>
<span class="sd">datastore as a separate entity; instead, its attribute values are</span>
<span class="sd">included in the parent entity using a naming convention (the name of</span>
<span class="sd">the structured attribute followed by a dot followed by the name of the</span>
<span class="sd">subattribute).  For example:</span>

<span class="sd">  class Address(Model):</span>
<span class="sd">    street = StringProperty()</span>
<span class="sd">    city = StringProperty()</span>

<span class="sd">  class Person(Model):</span>
<span class="sd">    name = StringProperty()</span>
<span class="sd">    address = StructuredProperty(Address)</span>

<span class="sd">  p = Person(name=&#39;Harry Potter&#39;,</span>
<span class="sd">             address=Address(street=&#39;4 Privet Drive&#39;,</span>
<span class="sd">                             city=&#39;Little Whinging&#39;))</span>
<span class="sd">  k.put()</span>

<span class="sd">This would write a single &#39;Person&#39; entity with three attributes (as</span>
<span class="sd">you could verify using the Datastore Viewer in the Admin Console):</span>

<span class="sd">  name = &#39;Harry Potter&#39;</span>
<span class="sd">  address.street = &#39;4 Privet Drive&#39;</span>
<span class="sd">  address.city = &#39;Little Whinging&#39;</span>

<span class="sd">Structured property types can be nested arbitrarily deep, but in a</span>
<span class="sd">hierarchy of nested structured property types, only one level can have</span>
<span class="sd">the repeated flag set.  It is fine to have multiple structured</span>
<span class="sd">properties referencing the same model class.</span>

<span class="sd">It is also fine to use the same model class both as a top-level entity</span>
<span class="sd">class and as for a structured property; however queries for the model</span>
<span class="sd">class will only return the top-level entities.</span>

<span class="sd">The LocalStructuredProperty works similar to StructuredProperty on the</span>
<span class="sd">Python side.  For example:</span>

<span class="sd">  class Address(Model):</span>
<span class="sd">    street = StringProperty()</span>
<span class="sd">    city = StringProperty()</span>

<span class="sd">  class Person(Model):</span>
<span class="sd">    name = StringProperty()</span>
<span class="sd">    address = LocalStructuredProperty(Address)</span>

<span class="sd">  p = Person(name=&#39;Harry Potter&#39;,</span>
<span class="sd">             address=Address(street=&#39;4 Privet Drive&#39;,</span>
<span class="sd">                             city=&#39;Little Whinging&#39;))</span>
<span class="sd">  k.put()</span>

<span class="sd">However the data written to the datastore is different; it writes a</span>
<span class="sd">&#39;Person&#39; entity with a &#39;name&#39; attribute as before and a single</span>
<span class="sd">&#39;address&#39; attribute whose value is a blob which encodes the Address</span>
<span class="sd">value (using the standard&quot;protocol buffer&quot; encoding).</span>

<span class="sd">Sometimes the set of properties is not known ahead of time.  In such</span>
<span class="sd">cases you can use the Expando class.  This is a Model subclass that</span>
<span class="sd">creates properties on the fly, both upon assignment and when loading</span>
<span class="sd">an entity from the datastore.  For example:</span>

<span class="sd">  class SuperPerson(Expando):</span>
<span class="sd">    name = StringProperty()</span>
<span class="sd">    superpower = StringProperty()</span>

<span class="sd">  razorgirl = SuperPerson(name=&#39;Molly Millions&#39;,</span>
<span class="sd">                          superpower=&#39;bionic eyes, razorblade hands&#39;,</span>
<span class="sd">                          rasta_name=&#39;Steppin\&#39; Razor&#39;,</span>
<span class="sd">                          alt_name=&#39;Sally Shears&#39;)</span>
<span class="sd">  elastigirl = SuperPerson(name=&#39;Helen Parr&#39;,</span>
<span class="sd">                           superpower=&#39;stretchable body&#39;)</span>
<span class="sd">  elastigirl.max_stretch = 30  # Meters</span>

<span class="sd">You can inspect the properties of an expando instance using the</span>
<span class="sd">_properties attribute:</span>

<span class="sd">  &gt;&gt;&gt; print razorgirl._properties.keys()</span>
<span class="sd">  [&#39;rasta_name&#39;, &#39;name&#39;, &#39;superpower&#39;, &#39;alt_name&#39;]</span>
<span class="sd">  &gt;&gt;&gt; print elastigirl._properties</span>
<span class="sd">  {&#39;max_stretch&#39;: GenericProperty(&#39;max_stretch&#39;),</span>
<span class="sd">   &#39;name&#39;: StringProperty(&#39;name&#39;),</span>
<span class="sd">   &#39;superpower&#39;: StringProperty(&#39;superpower&#39;)}</span>

<span class="sd">Note: this property exists for plain Model instances too; it is just</span>
<span class="sd">not as interesting for those.</span>

<span class="sd">The Model class offers basic query support.  You can create a Query</span>
<span class="sd">object by calling the query() class method.  Iterating over a Query</span>
<span class="sd">object returns the entities matching the query one at a time.</span>

<span class="sd">Query objects are fully described in the docstring for query.py, but</span>
<span class="sd">there is one handy shortcut that is only available through</span>
<span class="sd">Model.query(): positional arguments are interpreted as filter</span>
<span class="sd">expressions which are combined through an AND operator.  For example:</span>

<span class="sd">  Person.query(Person.name == &#39;Harry Potter&#39;, Person.age &gt;= 11)</span>

<span class="sd">is equivalent to:</span>

<span class="sd">  Person.query().filter(Person.name == &#39;Harry Potter&#39;, Person.age &gt;= 11)</span>

<span class="sd">Keyword arguments passed to .query() are passed along to the Query()</span>
<span class="sd">constructor.</span>

<span class="sd">It is possible to query for field values of stuctured properties.  For</span>
<span class="sd">example:</span>

<span class="sd">  qry = Person.query(Person.address.city == &#39;London&#39;)</span>

<span class="sd">A number of top-level functions also live in this module:</span>

<span class="sd">- transaction() runs a function inside a transaction</span>
<span class="sd">- get_multi() reads multiple entities at once</span>
<span class="sd">- put_multi() writes multiple entities at once</span>
<span class="sd">- delete_multi() deletes multiple entities at once</span>

<span class="sd">All these have a corresponding *_async() variant as well.</span>
<span class="sd">The *_multi_async() functions return a list of Futures.</span>

<span class="sd">And finally these (without async variants):</span>

<span class="sd">- in_transaction() tests whether you are currently running in a transaction</span>
<span class="sd">- @transactional decorates functions that should be run in a transaction</span>

<span class="sd">There are many other interesting features.  For example, Model</span>
<span class="sd">subclasses may define pre-call and post-call hooks for most operations</span>
<span class="sd">(get, put, delete, allocate_ids), and Property classes may be</span>
<span class="sd">subclassed to suit various needs.  Documentation for writing a</span>
<span class="sd">Property subclass is in the docstring for the Property class.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;guido@google.com (Guido van Rossum)&#39;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">zlib</span>

<span class="kn">from</span> <span class="nn">.google_imports</span> <span class="kn">import</span> <span class="n">datastore</span>
<span class="kn">from</span> <span class="nn">.google_imports</span> <span class="kn">import</span> <span class="n">datastore_errors</span>
<span class="kn">from</span> <span class="nn">.google_imports</span> <span class="kn">import</span> <span class="n">datastore_query</span>
<span class="kn">from</span> <span class="nn">.google_imports</span> <span class="kn">import</span> <span class="n">datastore_rpc</span>
<span class="kn">from</span> <span class="nn">.google_imports</span> <span class="kn">import</span> <span class="n">datastore_types</span>
<span class="kn">from</span> <span class="nn">.google_imports</span> <span class="kn">import</span> <span class="n">users</span>
<span class="kn">from</span> <span class="nn">.google_imports</span> <span class="kn">import</span> <span class="n">entity_pb</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">key</span> <span class="k">as</span> <span class="n">key_module</span>  <span class="c"># NOTE: &#39;key&#39; is a common local variable name.</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="n">Key</span> <span class="o">=</span> <span class="n">key_module</span><span class="o">.</span><span class="n">Key</span>  <span class="c"># For export.</span>

<span class="c"># NOTE: Property and Error classes are added later.</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Key&#39;</span><span class="p">,</span> <span class="s">&#39;BlobKey&#39;</span><span class="p">,</span> <span class="s">&#39;GeoPt&#39;</span><span class="p">,</span> <span class="s">&#39;Rollback&#39;</span><span class="p">,</span>
           <span class="s">&#39;Index&#39;</span><span class="p">,</span> <span class="s">&#39;IndexState&#39;</span><span class="p">,</span> <span class="s">&#39;IndexProperty&#39;</span><span class="p">,</span>
           <span class="s">&#39;ModelAdapter&#39;</span><span class="p">,</span> <span class="s">&#39;ModelAttribute&#39;</span><span class="p">,</span>
           <span class="s">&#39;ModelKey&#39;</span><span class="p">,</span> <span class="s">&#39;MetaModel&#39;</span><span class="p">,</span> <span class="s">&#39;Model&#39;</span><span class="p">,</span> <span class="s">&#39;Expando&#39;</span><span class="p">,</span>
           <span class="s">&#39;transaction&#39;</span><span class="p">,</span> <span class="s">&#39;transaction_async&#39;</span><span class="p">,</span> <span class="s">&#39;in_transaction&#39;</span><span class="p">,</span>
           <span class="s">&#39;transactional&#39;</span><span class="p">,</span> <span class="s">&#39;transactional_async&#39;</span><span class="p">,</span> <span class="s">&#39;transactional_tasklet&#39;</span><span class="p">,</span>
           <span class="s">&#39;non_transactional&#39;</span><span class="p">,</span>
           <span class="s">&#39;get_multi&#39;</span><span class="p">,</span> <span class="s">&#39;get_multi_async&#39;</span><span class="p">,</span>
           <span class="s">&#39;put_multi&#39;</span><span class="p">,</span> <span class="s">&#39;put_multi_async&#39;</span><span class="p">,</span>
           <span class="s">&#39;delete_multi&#39;</span><span class="p">,</span> <span class="s">&#39;delete_multi_async&#39;</span><span class="p">,</span>
           <span class="s">&#39;get_indexes&#39;</span><span class="p">,</span> <span class="s">&#39;get_indexes_async&#39;</span><span class="p">,</span>
           <span class="s">&#39;make_connection&#39;</span><span class="p">,</span>
           <span class="p">]</span>


<span class="n">BlobKey</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">BlobKey</span>
<span class="n">GeoPt</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">GeoPt</span>

<span class="n">Rollback</span> <span class="o">=</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">Rollback</span>


<span class="k">class</span> <span class="nc">KindError</span><span class="p">(</span><span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when an implementation for a kind can&#39;t be found.</span>

<span class="sd">  Also raised when the Kind is not an 8-bit string.</span>
<span class="sd">  &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">InvalidPropertyError</span><span class="p">(</span><span class="n">datastore_errors</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when a property is not applicable to a given use.</span>

<span class="sd">  For example, a property must exist and be indexed to be used in a query&#39;s</span>
<span class="sd">  projection or group by clause.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<span class="c"># Mapping for legacy support.</span>
<span class="n">BadProjectionError</span> <span class="o">=</span> <span class="n">InvalidPropertyError</span>


<span class="k">class</span> <span class="nc">UnprojectedPropertyError</span><span class="p">(</span><span class="n">datastore_errors</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when getting a property value that&#39;s not in the projection.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ReadonlyPropertyError</span><span class="p">(</span><span class="n">datastore_errors</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when attempting to set a property value that is read-only.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ComputedPropertyError</span><span class="p">(</span><span class="n">ReadonlyPropertyError</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Raised when attempting to set a value to or delete a computed property.&quot;&quot;&quot;</span>


<span class="c"># Various imported limits.</span>
<span class="n">_MAX_LONG</span> <span class="o">=</span> <span class="n">key_module</span><span class="o">.</span><span class="n">_MAX_LONG</span>
<span class="n">_MAX_STRING_LENGTH</span> <span class="o">=</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">_MAX_STRING_LENGTH</span>

<span class="c"># Map index directions to human-readable strings.</span>
<span class="n">_DIR_MAP</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">entity_pb</span><span class="o">.</span><span class="n">Index_Property</span><span class="o">.</span><span class="n">ASCENDING</span><span class="p">:</span> <span class="s">&#39;asc&#39;</span><span class="p">,</span>
  <span class="n">entity_pb</span><span class="o">.</span><span class="n">Index_Property</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">:</span> <span class="s">&#39;desc&#39;</span><span class="p">,</span>
  <span class="p">}</span>

<span class="c"># Map index states to human-readable strings.</span>
<span class="n">_STATE_MAP</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">entity_pb</span><span class="o">.</span><span class="n">CompositeIndex</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
  <span class="n">entity_pb</span><span class="o">.</span><span class="n">CompositeIndex</span><span class="o">.</span><span class="n">DELETED</span><span class="p">:</span> <span class="s">&#39;deleting&#39;</span><span class="p">,</span>
  <span class="n">entity_pb</span><span class="o">.</span><span class="n">CompositeIndex</span><span class="o">.</span><span class="n">READ_WRITE</span><span class="p">:</span> <span class="s">&#39;serving&#39;</span><span class="p">,</span>
  <span class="n">entity_pb</span><span class="o">.</span><span class="n">CompositeIndex</span><span class="o">.</span><span class="n">WRITE_ONLY</span><span class="p">:</span> <span class="s">&#39;building&#39;</span><span class="p">,</span>
  <span class="p">}</span>


<span class="k">class</span> <span class="nc">_NotEqualMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Mix-in class that implements __ne__ in terms of __eq__.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implement self != other as not(self == other).&quot;&quot;&quot;</span>
    <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">eq</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">eq</span>


<span class="k">class</span> <span class="nc">_NestedCounter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; A recursive counter for StructuredProperty deserialization.</span>

<span class="sd">  Deserialization has some complicated rules to handle StructuredPropertys</span>
<span class="sd">  that may or may not be empty. The simplest case is a leaf counter, where</span>
<span class="sd">  the counter will return the index of the repeated value that last had this</span>
<span class="sd">  leaf property written. When a non-leaf counter requested, this will return</span>
<span class="sd">  the max of all its leaf values. This is due to the fact that the next index</span>
<span class="sd">  that a full non-leaf property may be written to comes after all indices that</span>
<span class="sd">  have part of that property written (otherwise, a partial entity would be</span>
<span class="sd">  overwritten.</span>

<span class="sd">  Consider an evaluation of the following structure:</span>
<span class="sd">    class B(model.Model):</span>
<span class="sd">      c = model.IntegerProperty()</span>
<span class="sd">      d = model.IntegerProperty()</span>

<span class="sd">    class A(model.Model):</span>
<span class="sd">      b = model.StructuredProperty(B)</span>

<span class="sd">    class Foo(model.Model):</span>
<span class="sd">      # top-level model</span>
<span class="sd">      a = model.StructuredProperty(A, repeated=True)</span>

<span class="sd">    Foo(a=[A(b=None),</span>
<span class="sd">           A(b=B(c=1)),</span>
<span class="sd">           A(b=None),</span>
<span class="sd">           A(b=B(c=2, d=3))])</span>

<span class="sd">  This will result in a serialized structure:</span>

<span class="sd">  1) a.b   = None</span>
<span class="sd">  2) a.b.c = 1</span>
<span class="sd">  3) a.b.d = None</span>
<span class="sd">  4) a.b   = None</span>
<span class="sd">  5) a.b.c = 2</span>
<span class="sd">  6) a.b.d = 3</span>

<span class="sd">  The counter state should be the following:</span>
<span class="sd">     a | a.b | a.b.c | a.b.d</span>
<span class="sd">  0) -    -      -       -</span>
<span class="sd">  1) @1   1      -       -</span>
<span class="sd">  2) @2   @2     2       -</span>
<span class="sd">  3) @2   @2     2       2</span>
<span class="sd">  4) @3   @3     3       3</span>
<span class="sd">  5) @4   @4     4       3</span>
<span class="sd">  6) @4   @4     4       4</span>

<span class="sd">  Here, @ indicates that this counter value is actually a calculated value.</span>
<span class="sd">  It is equal to the MAX of its sub-counters.</span>

<span class="sd">  Counter values may get incremented multiple times while deserializing a</span>
<span class="sd">  property. This will happen if a child counter falls behind,</span>
<span class="sd">  for example in steps 2 and 3.</span>

<span class="sd">  During an increment of a parent node, all child nodes values are incremented</span>
<span class="sd">  to match that of the parent, for example in step 4.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__sub_counters</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">_NestedCounter</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">parts</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sub_counters</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_parent_node</span><span class="p">():</span>
      <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sub_counters</span><span class="o">.</span><span class="n">itervalues</span><span class="p">())</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__counter</span>

  <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">parts</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__make_parent_node</span><span class="p">()</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sub_counters</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_parent_node</span><span class="p">():</span>
      <span class="c"># Move all children forward</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__counter</span>

  <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates all descendants to a specified value.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_parent_node</span><span class="p">():</span>
      <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sub_counters</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
        <span class="n">child</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__counter</span> <span class="o">=</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_absolute_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Used only for testing.</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__counter</span>

  <span class="k">def</span> <span class="nf">__is_parent_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__counter</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

  <span class="k">def</span> <span class="nf">__make_parent_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__counter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>


<span class="k">class</span> <span class="nc">IndexProperty</span><span class="p">(</span><span class="n">_NotEqualMixin</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Immutable object representing a single property in an index.&quot;&quot;&quot;</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__direction</span> <span class="o">=</span> <span class="n">direction</span>
    <span class="k">return</span> <span class="n">obj</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The property name being indexed, a string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__name</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">direction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The direction in the index for this property, &#39;asc&#39; or &#39;desc&#39;.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__direction</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a string representation.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(name=</span><span class="si">%r</span><span class="s">, direction=</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare two index properties for equality.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">IndexProperty</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">direction</span>

  <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="n">_NotEqualMixin</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Immutable object representing an index.&quot;&quot;&quot;</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">ancestor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__kind</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__properties</span> <span class="o">=</span> <span class="n">properties</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__ancestor</span> <span class="o">=</span> <span class="n">ancestor</span>
    <span class="k">return</span> <span class="n">obj</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">kind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The kind being indexed, a string.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kind</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A list of PropertyIndex objects giving the properties being indexed.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__properties</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">ancestor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Whether this is an ancestor index, a bool.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ancestor</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a string representation.&quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;kind=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;properties=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;ancestor=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare two indexes.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Index</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">kind</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">properties</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ancestor</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ancestor</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">IndexState</span><span class="p">(</span><span class="n">_NotEqualMixin</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Immutable object representing and index and its state.&quot;&quot;&quot;</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__definition</span> <span class="o">=</span> <span class="n">definition</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__state</span> <span class="o">=</span> <span class="n">state</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">__id</span> <span class="o">=</span> <span class="nb">id</span>
    <span class="k">return</span> <span class="n">obj</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Index object describing the index.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__definition</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The index state, a string.</span>

<span class="sd">    Possible values are &#39;error&#39;, &#39;deleting&#39;, &#39;serving&#39; or &#39;building&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__state</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The index ID, an integer.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__id</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a string representation.&quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;definition=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;state=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;id=</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare two index states.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">IndexState</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">definition</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">state</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">ModelAdapter</span><span class="p">(</span><span class="n">datastore_rpc</span><span class="o">.</span><span class="n">AbstractAdapter</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Conversions between &#39;our&#39; Key and Model classes and protobufs.</span>

<span class="sd">  This is needed to construct a Connection object, which in turn is</span>
<span class="sd">  needed to construct a Context object.</span>

<span class="sd">  See the base class docstring for more info about the signatures.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_model</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      default_model: If an implementation for the kind cannot be found, use</span>
<span class="sd">        this model class.  If none is specified, an exception will be thrown</span>
<span class="sd">        (default).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span> <span class="o">=</span> <span class="n">default_model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">want_pbs</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c"># Make this a context manager to request setting _orig_pb.</span>
  <span class="c"># Used in query.py by _MultiQuery.run_to_queue().</span>

  <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">want_pbs</span> <span class="o">+=</span> <span class="mi">1</span>

  <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">unused_args</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">want_pbs</span> <span class="o">-=</span> <span class="mi">1</span>

  <span class="k">def</span> <span class="nf">pb_to_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Key</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">pb</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">key_to_pb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">reference</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">pb_to_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element_size</span><span class="p">():</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span>
    <span class="n">modelclass</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_lookup_model</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">)</span>
    <span class="n">entity</span> <span class="o">=</span> <span class="n">modelclass</span><span class="o">.</span><span class="n">_from_pb</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">set_key</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">want_pbs</span><span class="p">:</span>
      <span class="n">entity</span><span class="o">.</span><span class="n">_orig_pb</span> <span class="o">=</span> <span class="n">pb</span>
    <span class="k">return</span> <span class="n">entity</span>

  <span class="k">def</span> <span class="nf">entity_to_pb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ent</span><span class="p">):</span>
    <span class="n">pb</span> <span class="o">=</span> <span class="n">ent</span><span class="o">.</span><span class="n">_to_pb</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pb</span>

  <span class="k">def</span> <span class="nf">pb_to_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
    <span class="n">index_def</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">definition</span><span class="p">()</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="p">[</span><span class="n">IndexProperty</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">prop</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
                                <span class="n">direction</span><span class="o">=</span><span class="n">_DIR_MAP</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">direction</span><span class="p">()])</span>
                  <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">index_def</span><span class="o">.</span><span class="n">property_list</span><span class="p">()]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">Index</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">index_def</span><span class="o">.</span><span class="n">entity_type</span><span class="p">(),</span>
                  <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
                  <span class="n">ancestor</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">index_def</span><span class="o">.</span><span class="n">ancestor</span><span class="p">()),</span>
                  <span class="p">)</span>
    <span class="n">index_state</span> <span class="o">=</span> <span class="n">IndexState</span><span class="p">(</span><span class="n">definition</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                             <span class="n">state</span><span class="o">=</span><span class="n">_STATE_MAP</span><span class="p">[</span><span class="n">pb</span><span class="o">.</span><span class="n">state</span><span class="p">()],</span>
                             <span class="nb">id</span><span class="o">=</span><span class="n">pb</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span>
                             <span class="p">)</span>
    <span class="k">return</span> <span class="n">index_state</span>


<span class="k">def</span> <span class="nf">make_connection</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default_model</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create a new Connection object with the right adapter.</span>

<span class="sd">  Optionally you can pass in a datastore_rpc.Configuration object.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">Connection</span><span class="p">(</span>
      <span class="n">adapter</span><span class="o">=</span><span class="n">ModelAdapter</span><span class="p">(</span><span class="n">default_model</span><span class="p">),</span>
      <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ModelAttribute</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Base class signifying the presence of a _fix_up() method.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_fix_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">code_name</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">_BaseValue</span><span class="p">(</span><span class="n">_NotEqualMixin</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A marker object wrapping a &#39;base type&#39; value.</span>

<span class="sd">  This is used to be able to tell whether ent._values[name] is a</span>
<span class="sd">  user value (i.e. of a type that the Python code understands) or a</span>
<span class="sd">  base value (i.e of a type that serialization understands).</span>
<span class="sd">  User values are unwrapped; base values are wrapped in a</span>
<span class="sd">  _BaseValue instance.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;b_val&#39;</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.  Argument is the base value to be wrapped.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">b_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b_val</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">b_val</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">b_val</span> <span class="o">=</span> <span class="n">b_val</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;_BaseValue(</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_val</span><span class="p">,)</span>

  <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_val</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">b_val</span>

  <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;_BaseValue is not immutable&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Property</span><span class="p">(</span><span class="n">ModelAttribute</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A class describing a typed, persisted attribute of a datastore entity.</span>

<span class="sd">  Not to be confused with Python&#39;s &#39;property&#39; built-in.</span>

<span class="sd">  This is just a base class; there are specific subclasses that</span>
<span class="sd">  describe Properties of various types (and GenericProperty which</span>
<span class="sd">  describes a dynamically typed Property).</span>

<span class="sd">  All special Property attributes, even those considered &#39;public&#39;,</span>
<span class="sd">  have names starting with an underscore, because StructuredProperty</span>
<span class="sd">  uses the non-underscore attribute namespace to refer to nested</span>
<span class="sd">  Property names; this is essential for specifying queries on</span>
<span class="sd">  subproperties (see the module docstring).</span>

<span class="sd">  The Property class and its predefined subclasses allow easy</span>
<span class="sd">  subclassing using composable (or stackable) validation and</span>
<span class="sd">  conversion APIs.  These require some terminology definitions:</span>

<span class="sd">  - A &#39;user value&#39; is a value such as would be set and accessed by the</span>
<span class="sd">    application code using standard attributes on the entity.</span>

<span class="sd">  - A &#39;base value&#39; is a value such as would be serialized to</span>
<span class="sd">    and deserialized from the datastore.</span>

<span class="sd">  The values stored in ent._values[name] and accessed by</span>
<span class="sd">  _store_value() and _retrieve_value() can be either user values or</span>
<span class="sd">  base values.  To retrieve user values, use</span>
<span class="sd">  _get_user_value().  To retrieve base values, use</span>
<span class="sd">  _get_base_value().  In particular, _get_value() calls</span>
<span class="sd">  _get_user_value(), and _serialize() effectively calls</span>
<span class="sd">  _get_base_value().</span>

<span class="sd">  To store a user value, just call _store_value().  To store a</span>
<span class="sd">  base value, wrap the value in a _BaseValue() and then</span>
<span class="sd">  call _store_value().</span>

<span class="sd">  A Property subclass that wants to implement a specific</span>
<span class="sd">  transformation between user values and serialiazble values should</span>
<span class="sd">  implement two methods, _to_base_type() and _from_base_type().</span>
<span class="sd">  These should *NOT* call their super() method; super calls are taken</span>
<span class="sd">  care of by _call_to_base_type() and _call_from_base_type().</span>
<span class="sd">  This is what is meant by composable (or stackable) APIs.</span>

<span class="sd">  The API supports &#39;stacking&#39; classes with ever more sophisticated</span>
<span class="sd">  user&lt;--&gt;base conversions: the user--&gt;base conversion</span>
<span class="sd">  goes from more sophisticated to less sophisticated, while the</span>
<span class="sd">  base--&gt;user conversion goes from less sophisticated to more</span>
<span class="sd">  sophisticated.  For example, see the relationship between</span>
<span class="sd">  BlobProperty, TextProperty and StringProperty.</span>

<span class="sd">  In addition to _to_base_type() and _from_base_type(), the</span>
<span class="sd">  _validate() method is also a composable API.</span>

<span class="sd">  The validation API distinguishes between &#39;lax&#39; and &#39;strict&#39; user</span>
<span class="sd">  values.  The set of lax values is a superset of the set of strict</span>
<span class="sd">  values.  The _validate() method takes a lax value and if necessary</span>
<span class="sd">  converts it to a strict value.  This means that when setting the</span>
<span class="sd">  property value, lax values are accepted, while when getting the</span>
<span class="sd">  property value, only strict values will be returned.  If no</span>
<span class="sd">  conversion is needed, _validate() may return None.  If the argument</span>
<span class="sd">  is outside the set of accepted lax values, _validate() should raise</span>
<span class="sd">  an exception, preferably TypeError or</span>
<span class="sd">  datastore_errors.BadValueError.</span>

<span class="sd">  Example/boilerplate:</span>

<span class="sd">  def _validate(self, value):</span>
<span class="sd">    &#39;Lax user value to strict user value.&#39;</span>
<span class="sd">    if not isinstance(value, &lt;top type&gt;):</span>
<span class="sd">      raise TypeError(...)  # Or datastore_errors.BadValueError(...).</span>

<span class="sd">  def _to_base_type(self, value):</span>
<span class="sd">    &#39;(Strict) user value to base value.&#39;</span>
<span class="sd">    if isinstance(value, &lt;user type&gt;):</span>
<span class="sd">      return &lt;base type&gt;(value)</span>

<span class="sd">  def _from_base_type(self, value):</span>
<span class="sd">    &#39;base value to (strict) user value.&#39;</span>
<span class="sd">    if not isinstance(value, &lt;base type&gt;):</span>
<span class="sd">      return &lt;user type&gt;(value)</span>

<span class="sd">  Things that _validate(), _to_base_type() and _from_base_type()</span>
<span class="sd">  do *not* need to handle:</span>

<span class="sd">  - None: They will not be called with None (and if they return None,</span>
<span class="sd">    this means that the value does not need conversion).</span>

<span class="sd">  - Repeated values: The infrastructure (_get_user_value() and</span>
<span class="sd">    _get_base_value()) takes care of calling</span>
<span class="sd">    _from_base_type() or _to_base_type() for each list item in a</span>
<span class="sd">    repeated value.</span>

<span class="sd">  - Wrapping values in _BaseValue(): The wrapping and unwrapping is</span>
<span class="sd">    taken care of by the infrastructure that calls the composable APIs.</span>

<span class="sd">  - Comparisons: The comparison operations call _to_base_type() on</span>
<span class="sd">    their operand.</span>

<span class="sd">  - Distinguishing between user and base values: the</span>
<span class="sd">    infrastructure guarantees that _from_base_type() will be called</span>
<span class="sd">    with an (unwrapped) base value, and that</span>
<span class="sd">    _to_base_type() will be called with a user value.</span>

<span class="sd">  - Returning the original value: if any of these return None, the</span>
<span class="sd">    original value is kept.  (Returning a differen value not equal to</span>
<span class="sd">    None will substitute the different value.)</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c"># TODO: Separate &#39;simple&#39; properties from base Property class</span>

  <span class="n">_code_name</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_name</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_indexed</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">_repeated</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">_required</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">_default</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_choices</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_validator</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_verbose_name</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="n">__creation_counter_global</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_name&#39;</span><span class="p">,</span> <span class="s">&#39;_indexed&#39;</span><span class="p">,</span> <span class="s">&#39;_repeated&#39;</span><span class="p">,</span> <span class="s">&#39;_required&#39;</span><span class="p">,</span> <span class="s">&#39;_default&#39;</span><span class="p">,</span>
                 <span class="s">&#39;_choices&#39;</span><span class="p">,</span> <span class="s">&#39;_validator&#39;</span><span class="p">,</span> <span class="s">&#39;_verbose_name&#39;</span><span class="p">]</span>
  <span class="n">_positional</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># Only name is a positional argument.</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">_positional</span><span class="p">)</span>  <span class="c"># Add 1 for self.</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">repeated</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">required</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">validator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.  For arguments see the module docstring.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Name </span><span class="si">%r</span><span class="s"> is not a string&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
      <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Name </span><span class="si">%r</span><span class="s"> cannot contain period characters&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">if</span> <span class="n">indexed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="o">=</span> <span class="n">indexed</span>
    <span class="k">if</span> <span class="n">repeated</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="o">=</span> <span class="n">repeated</span>
    <span class="k">if</span> <span class="n">required</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_required</span> <span class="o">=</span> <span class="n">required</span>
    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c"># TODO: Call _validate() on default?</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">if</span> <span class="n">verbose_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_verbose_name</span> <span class="o">=</span> <span class="n">verbose_name</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_required</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;repeated is incompatible with required or default&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">choices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;choices must be a list, tuple or set; received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                        <span class="n">choices</span><span class="p">)</span>
      <span class="c"># TODO: Call _validate() on each choice?</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_choices</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c"># The validator is called as follows:</span>
      <span class="c">#   value = validator(prop, value)</span>
      <span class="c"># It should return the value to be used, or raise an exception.</span>
      <span class="c"># It should be idempotent, i.e. calling it a second time should</span>
      <span class="c"># not further modify the value.  So a validator that returns e.g.</span>
      <span class="c"># value.lower() or value.strip() is fine, but one that returns</span>
      <span class="c"># value + &#39;$&#39; is not.</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;validator must be callable or None; received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                        <span class="n">validator</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="o">=</span> <span class="n">validator</span>
    <span class="c"># Keep a unique creation counter.</span>
    <span class="n">Property</span><span class="o">.</span><span class="n">__creation_counter_global</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_creation_counter</span> <span class="o">=</span> <span class="n">Property</span><span class="o">.</span><span class="n">__creation_counter_global</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a compact unambiguous string representation of a property.&quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="p">):</span>
      <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
          <span class="n">s</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">s</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_positional</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
          <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">s</span>

  <span class="k">def</span> <span class="nf">_datastore_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal hook used by property filters.</span>

<span class="sd">    Sometimes the low-level query interface needs a specific data type</span>
<span class="sd">    in order for the right filter to be constructed.  See _comparison().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper for comparison operators.</span>

<span class="sd">    Args:</span>
<span class="sd">      op: The operator (&#39;=&#39;, &#39;&lt;&#39; etc.).</span>

<span class="sd">    Returns:</span>
<span class="sd">      A FilterNode instance representing the requested comparison.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># NOTE: This is also used by query.gql().</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
        <span class="s">&#39;Cannot query for unindexed property </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">FilterNode</span>  <span class="c"># Import late to avoid circular imports.</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_to_base_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datastore_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">FilterNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="c"># Comparison operators on Property instances don&#39;t compare the</span>
  <span class="c"># properties; instead they return FilterNode instances that can be</span>
  <span class="c"># used in queries.  See the module docstrings above and in query.py</span>
  <span class="c"># for details on how these can be used.</span>

  <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a FilterNode instance representing the &#39;=&#39; comparison.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a FilterNode instance representing the &#39;!=&#39; comparison.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s">&#39;!=&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a FilterNode instance representing the &#39;&lt;&#39; comparison.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a FilterNode instance representing the &#39;&lt;=&#39; comparison.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a FilterNode instance representing the &#39;&gt;&#39; comparison.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a FilterNode instance representing the &#39;&gt;=&#39; comparison.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_IN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Comparison operator for the &#39;in&#39; comparison operator.</span>

<span class="sd">    The Python &#39;in&#39; operator cannot be overloaded in the way we want</span>
<span class="sd">    to, so we define a method.  For example:</span>

<span class="sd">      Employee.query(Employee.rank.IN([4, 5, 6]))</span>

<span class="sd">    Note that the method is called ._IN() but may normally be invoked</span>
<span class="sd">    as .IN(); ._IN() is provided for the case you have a</span>
<span class="sd">    StructuredProperty with a model that has a Property named IN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
        <span class="s">&#39;Cannot query for unindexed property </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">FilterNode</span>  <span class="c"># Import late to avoid circular imports.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
        <span class="s">&#39;Expected list, tuple or set, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_validate</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_to_base_type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datastore_type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
      <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">FilterNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
  <span class="n">IN</span> <span class="o">=</span> <span class="n">_IN</span>

  <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a descending sort order on this Property.</span>

<span class="sd">    For example:</span>

<span class="sd">      Employee.query().order(-Employee.rank)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyOrder</span><span class="p">(</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyOrder</span><span class="o">.</span><span class="n">DESCENDING</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__pos__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an ascending sort order on this Property.</span>

<span class="sd">    Note that this is redundant but provided for consistency with</span>
<span class="sd">    __neg__.  For example, the following two are equivalent:</span>

<span class="sd">      Employee.query().order(+Employee.rank)</span>
<span class="sd">      Employee.query().order(Employee.rank)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datastore_query</span><span class="o">.</span><span class="n">PropertyOrder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_do_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call all validations on the value.</span>

<span class="sd">    This calls the most derived _validate() method(s), then the custom</span>
<span class="sd">    validator function, and then checks the choices.  It returns the</span>
<span class="sd">    value, possibly modified in an idempotent way, or raises an</span>
<span class="sd">    exception.</span>

<span class="sd">    Note that this does not call all composable _validate() methods.</span>
<span class="sd">    It only calls _validate() methods up to but not including the</span>
<span class="sd">    first _to_base_type() method, when the MRO is traversed looking</span>
<span class="sd">    for _validate() and _to_base_type() methods.  (IOW if a class</span>
<span class="sd">    defines both _validate() and _to_base_type(), its _validate()</span>
<span class="sd">    is called and then the search is aborted.)</span>

<span class="sd">    Note that for a repeated Property this function should be called</span>
<span class="sd">    for each item in the list, not for the list as a whole.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_shallow_validation</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">newvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">newvalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">newvalue</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choices</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
          <span class="s">&#39;Value </span><span class="si">%r</span><span class="s"> for property </span><span class="si">%s</span><span class="s"> is not an allowed choice&#39;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_fix_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">code_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper called to tell the property its name.</span>

<span class="sd">    This is called by _fix_up_properties() which is called by</span>
<span class="sd">    MetaModel when finishing the construction of a Model subclass.</span>
<span class="sd">    The name passed in is the name of the class attribute to which the</span>
<span class="sd">    Property is assigned (a.k.a. the code name).  Note that this means</span>
<span class="sd">    that each Property instance must be assigned to (at most) one</span>
<span class="sd">    class attribute.  E.g. to declare three strings, you must call</span>
<span class="sd">    StringProperty() three times, you cannot write</span>

<span class="sd">      foo = bar = baz = StringProperty()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_code_name</span> <span class="o">=</span> <span class="n">code_name</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">code_name</span>

  <span class="k">def</span> <span class="nf">_store_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to store a value in an entity for a Property.</span>

<span class="sd">    This assumes validation has already taken place.  For a repeated</span>
<span class="sd">    Property the value should be a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entity</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to set a value in an entity for a Property.</span>

<span class="sd">    This performs validation first.  For a repeated Property the value</span>
<span class="sd">    should be a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">ReadonlyPropertyError</span><span class="p">(</span>
        <span class="s">&#39;You cannot set property values of a projection entity&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected list or tuple, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                             <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
      <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_do_validate</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_has_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">unused_rest</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to ask if the entity has a value for this Property.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_values</span>

  <span class="k">def</span> <span class="nf">_retrieve_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to retrieve the value for this Property from an entity.</span>

<span class="sd">    This returns None if no value is set, or the default argument if</span>
<span class="sd">    given.  For a repeated Property this returns a list if a value is</span>
<span class="sd">    set, otherwise None.  No additional transformations are applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_user_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the user value for this property of the given entity.</span>

<span class="sd">    This implies removing the _BaseValue() wrapper if present, and</span>
<span class="sd">    if it is, calling all _from_base_type() methods, in the reverse</span>
<span class="sd">    method resolution order of the property&#39;s class.  It also handles</span>
<span class="sd">    default values and repeated properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_to_values</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt_call_from_base_type</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_base_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the base value for this property of the given entity.</span>

<span class="sd">    This implies calling all _to_base_type() methods, in the method</span>
<span class="sd">    resolution order of the property&#39;s class, and adding a</span>
<span class="sd">    _BaseValue() wrapper, if one is not already present.  (If one</span>
<span class="sd">    is present, no work is done.)  It also handles default values and</span>
<span class="sd">    repeated properties.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_to_values</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt_call_to_base_type</span><span class="p">)</span>

  <span class="c"># TODO: Invent a shorter name for this.</span>
  <span class="k">def</span> <span class="nf">_get_base_value_unwrapped_as_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Like _get_base_value(), but always returns a list.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A new list of unwrapped base values.  For an unrepeated</span>
<span class="sd">      property, if the value is missing or None, returns [None]; for a</span>
<span class="sd">      repeated property, if the original value is missing or None or</span>
<span class="sd">      empty, returns [].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">wrapped</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
      <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">b_val</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wrapped</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">wrapped</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
      <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">wrapped</span><span class="o">.</span><span class="n">b_val</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">_opt_call_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call _from_base_type() if necessary.</span>

<span class="sd">    If the value is a _BaseValue instance, unwrap it and call all</span>
<span class="sd">    _from_base_type() methods.  Otherwise, return the value</span>
<span class="sd">    unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">):</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_from_base_type</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">b_val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_value_to_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn a value (base or not) into its repr().</span>

<span class="sd">    This exists so that property classes can override it separately.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Manually apply _from_base_type() so as not to have a side</span>
    <span class="c"># effect on what&#39;s contained in the entity.  Printing a value</span>
    <span class="c"># should not change it!</span>
    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt_call_from_base_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_opt_call_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call _to_base_type() if necessary.</span>

<span class="sd">    If the value is a _BaseValue instance, return it unchanged.</span>
<span class="sd">    Otherwise, call all _validate() and _to_base_type() methods and</span>
<span class="sd">    wrap it in a _BaseValue instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">):</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">_BaseValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_call_to_base_type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_call_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call all _from_base_type() methods on the value.</span>

<span class="sd">    This calls the methods in the reverse method resolution order of</span>
<span class="sd">    the property&#39;s class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_methods</span><span class="p">(</span><span class="s">&#39;_from_base_type&#39;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_list</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">call</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_call_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call all _validate() and _to_base_type() methods on the value.</span>

<span class="sd">    This calls the methods in the method resolution order of the</span>
<span class="sd">    property&#39;s class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_methods</span><span class="p">(</span><span class="s">&#39;_validate&#39;</span><span class="p">,</span> <span class="s">&#39;_to_base_type&#39;</span><span class="p">)</span>
    <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_list</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">call</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_call_shallow_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call the initial set of _validate() methods.</span>

<span class="sd">    This is similar to _call_to_base_type() except it only calls</span>
<span class="sd">    those _validate() methods that can be called without needing to</span>
<span class="sd">    call _to_base_type().</span>

<span class="sd">    An example: suppose the class hierarchy is A -&gt; B -&gt; C -&gt;</span>
<span class="sd">    Property, and suppose A defines _validate() only, but B and C</span>
<span class="sd">    define _validate() and _to_base_type().  The full list of</span>
<span class="sd">    methods called by _call_to_base_type() is:</span>

<span class="sd">      A._validate()</span>
<span class="sd">      B._validate()</span>
<span class="sd">      B._to_base_type()</span>
<span class="sd">      C._validate()</span>
<span class="sd">      C._to_base_type()</span>

<span class="sd">    This method will call A._validate() and B._validate() but not the</span>
<span class="sd">    others.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_methods</span><span class="p">(</span><span class="s">&#39;_validate&#39;</span><span class="p">,</span> <span class="s">&#39;_to_base_type&#39;</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">__name__</span> <span class="o">!=</span> <span class="s">&#39;_validate&#39;</span><span class="p">:</span>
        <span class="k">break</span>
      <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="n">call</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_list</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">call</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_find_methods</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute a list of composable methods.</span>

<span class="sd">    Because this is a common operation and the class hierarchy is</span>
<span class="sd">    static, the outcome is cached (assuming that for a particular list</span>
<span class="sd">    of names the reversed flag is either always on, or always off).</span>

<span class="sd">    Args:</span>
<span class="sd">      *names: One or more method names.</span>
<span class="sd">      reverse: Optional flag, default False; if True, the list is</span>
<span class="sd">        reversed.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A list of callable class method objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reverse</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;reverse&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">kwds</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_find_methods_cache&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
      <span class="n">hit</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">hit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hit</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">cls</span><span class="o">.</span><span class="n">_find_methods_cache</span> <span class="o">=</span> <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">__mro__</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
      <span class="n">methods</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">names</span><span class="p">]</span> <span class="o">=</span> <span class="n">methods</span>
    <span class="k">return</span> <span class="n">methods</span>

  <span class="k">def</span> <span class="nf">_apply_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methods</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a single callable that applies a list of methods to a value.</span>

<span class="sd">    If a method returns None, the last value is kept; if it returns</span>
<span class="sd">    some other value, that replaces the last value.  Exceptions are</span>
<span class="sd">    not caught.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
        <span class="n">newvalue</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">newvalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">value</span> <span class="o">=</span> <span class="n">newvalue</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">call</span>

  <span class="k">def</span> <span class="nf">_apply_to_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply a function to the property value/values of a given entity.</span>

<span class="sd">    This retrieves the property value, applies the function, and then</span>
<span class="sd">    stores the value back.  For a repeated property, the function is</span>
<span class="sd">    applied separately to each of the values in the list.  The</span>
<span class="sd">    resulting value or list of values is both stored back in the</span>
<span class="sd">    entity and returned from this method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span><span class="p">[:]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">newvalue</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">newvalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">newvalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">newvalue</span><span class="p">)</span>
          <span class="n">value</span> <span class="o">=</span> <span class="n">newvalue</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to get the value for this Property from an entity.</span>

<span class="sd">    For a repeated Property this initializes the value to an empty</span>
<span class="sd">    list if it is not set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnprojectedPropertyError</span><span class="p">(</span>
          <span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> is not in the projection&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_delete_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to delete the value for this Property from an entity.</span>

<span class="sd">    Note that if no value exists this is a no-op; deleted values will</span>
<span class="sd">    not be serialized but requesting their value will return None (or</span>
<span class="sd">    an empty list in the case of a repeated Property).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_values</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">entity</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">_is_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to ask if the entity has a value for this Property.</span>

<span class="sd">    This returns False if a value is stored but it is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_required</span> <span class="ow">or</span>
            <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">unused_cls</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Descriptor protocol: get the value from the entity.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span>  <span class="c"># __get__ called on class</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Descriptor protocol: set the value on the entity.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Descriptor protocol: delete the value from the entity.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_delete_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">parent_repeated</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">projection</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to serialize this property to a protocol buffer.</span>

<span class="sd">    Subclasses may override this method.</span>

<span class="sd">    Args:</span>
<span class="sd">      entity: The entity, a Model (subclass) instance.</span>
<span class="sd">      pb: The protocol buffer, an EntityProto instance.</span>
<span class="sd">      prefix: Optional name prefix used for StructuredProperty</span>
<span class="sd">        (if present, must end in &#39;.&#39;).</span>
<span class="sd">      parent_repeated: True if the parent (or an earlier ancestor)</span>
<span class="sd">        is a repeated Property.</span>
<span class="sd">      projection: A list or tuple of strings representing the projection for</span>
<span class="sd">        the model instance, or None if the instance is not a projection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_value_unwrapped_as_list</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
      <span class="k">if</span> <span class="n">projection</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">projection</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">add_property</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">add_raw_property</span><span class="p">()</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_multiple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="ow">or</span> <span class="n">parent_repeated</span><span class="p">)</span>
      <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">mutable_value</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_set_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
          <span class="c"># Projected properties have the INDEX_VALUE meaning and only contain</span>
          <span class="c"># the original property&#39;s name and value.</span>
          <span class="n">new_p</span> <span class="o">=</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="p">()</span>
          <span class="n">new_p</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
          <span class="n">new_p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">INDEX_VALUE</span><span class="p">)</span>
          <span class="n">new_p</span><span class="o">.</span><span class="n">set_multiple</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
          <span class="n">new_p</span><span class="o">.</span><span class="n">mutable_value</span><span class="p">()</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
          <span class="n">p</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">new_p</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">unused_depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to deserialize this property from a protocol buffer.</span>

<span class="sd">    Subclasses may override this method.</span>

<span class="sd">    Args:</span>
<span class="sd">      entity: The entity, a Model (subclass) instance.</span>
<span class="sd">      p: A Property Message object (a protocol buffer).</span>
<span class="sd">      depth: Optional nesting depth, default 1 (unused here, but used</span>
<span class="sd">        by some subclasses that override this method).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_get_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">_BaseValue</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">val</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">_check_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">require_indexed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to check this property for specific requirements.</span>

<span class="sd">    Called by Model._check_properties().</span>

<span class="sd">    Args:</span>
<span class="sd">      rest: Optional subproperty to check, of the form &#39;name1.name2...nameN&#39;.</span>

<span class="sd">    Raises:</span>
<span class="sd">      InvalidPropertyError if this property does not meet the given</span>
<span class="sd">      requirements or if a subproperty is specified.  (StructuredProperty</span>
<span class="sd">      overrides this method to handle subproperties.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">require_indexed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">InvalidPropertyError</span><span class="p">(</span><span class="s">&#39;Property is unindexed </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rest</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">InvalidPropertyError</span><span class="p">(</span><span class="s">&#39;Referencing subproperty </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> &#39;</span>
                                 <span class="s">&#39;but </span><span class="si">%s</span><span class="s"> is not a structured property&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">rest</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_get_for_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve the value like _get_value(), processed for _to_dict().</span>

<span class="sd">    Property subclasses can override this if they want the dictionary</span>
<span class="sd">    returned by entity._to_dict() to contain a different value.  The</span>
<span class="sd">    main use case is StructuredProperty and LocalStructuredProperty.</span>

<span class="sd">    NOTES:</span>

<span class="sd">    - If you override _get_for_dict() to return a different type, you</span>
<span class="sd">      must override _validate() to accept values of that type and</span>
<span class="sd">      convert them back to the original type.</span>

<span class="sd">    - If you override _get_for_dict(), you must handle repeated values</span>
<span class="sd">      and None correctly.  (See _StructuredGetForDictMixin for an</span>
<span class="sd">      example.)  However, _validate() does not need to handle these.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_validate_key</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
    <span class="c"># TODO: BadKeyError.</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected Key, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">entity</span> <span class="ow">and</span> <span class="n">entity</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Expando</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="o">!=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;Expected Key kind to be </span><span class="si">%s</span><span class="s">; received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span><span class="p">()))</span>
  <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">ModelKey</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Special property to store the Model key.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ModelKey</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s">&#39;__key__&#39;</span>

  <span class="k">def</span> <span class="nf">_datastore_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">urlsafe</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ModelKey</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
        <span class="s">&quot;__key__ filter query can&#39;t be compared to None&quot;</span><span class="p">)</span>

  <span class="c"># TODO: Support IN().</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_validate_key</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setter for key attribute.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">_validate_key</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="n">entity</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_validate_key</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">entity</span><span class="o">.</span><span class="n">_entity_key</span> <span class="o">=</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Getter for key attribute.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">_entity_key</span>

  <span class="k">def</span> <span class="nf">_delete_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deleter for key attribute.&quot;&quot;&quot;</span>
    <span class="n">entity</span><span class="o">.</span><span class="n">_entity_key</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">BooleanProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a Python bool.&quot;&quot;&quot;</span>
  <span class="c"># TODO: Allow int/long values equal to 0 or 1?</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected bool, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;BooleanProperty </span><span class="si">%s</span><span class="s"> can only be set to bool values; &#39;</span>
                      <span class="s">&#39;received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">v</span><span class="o">.</span><span class="n">set_booleanvalue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">has_booleanvalue</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="c"># The booleanvalue field is an int32, so booleanvalue() returns an</span>
    <span class="c"># int, hence the conversion.</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">booleanvalue</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">IntegerProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a Python int or long (or bool).&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected integer, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;IntegerProperty </span><span class="si">%s</span><span class="s"> can only be set to integer values; &#39;</span>
                      <span class="s">&#39;received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">v</span><span class="o">.</span><span class="n">set_int64value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">has_int64value</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">int64value</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">FloatProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a Python float.</span>

<span class="sd">  Note: int, long and bool are also allowed.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected float, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;FloatProperty </span><span class="si">%s</span><span class="s"> can only be set to integer or float &#39;</span>
                      <span class="s">&#39;values; received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">v</span><span class="o">.</span><span class="n">set_doublevalue</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">has_doublevalue</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">doublevalue</span><span class="p">()</span>


<span class="c"># A custom &#39;meaning&#39; for compressed properties.</span>
<span class="n">_MEANING_URI_COMPRESSED</span> <span class="o">=</span> <span class="s">&#39;ZLIB&#39;</span>


<span class="k">class</span> <span class="nc">_CompressedValue</span><span class="p">(</span><span class="n">_NotEqualMixin</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A marker object wrapping compressed values.&quot;&quot;&quot;</span>

  <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;z_val&#39;</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.  Argument is a string returned by zlib.compress().&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">z_val</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">z_val</span> <span class="o">=</span> <span class="n">z_val</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;_CompressedValue(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_val</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_CompressedValue</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_val</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">z_val</span>

  <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;_CompressedValue is not immutable&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BlobProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a byte string.  It may be compressed.&quot;&quot;&quot;</span>

  <span class="n">_indexed</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">_compressed</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="n">_attributes</span> <span class="o">=</span> <span class="n">Property</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;_compressed&#39;</span><span class="p">]</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Property</span><span class="o">.</span><span class="n">_positional</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">BlobProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="o">=</span> <span class="n">compressed</span>
    <span class="k">if</span> <span class="n">compressed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
      <span class="c"># TODO: Allow this, but only allow == and IN comparisons?</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;BlobProperty </span><span class="si">%s</span><span class="s"> cannot be compressed and &#39;</span>
                                <span class="s">&#39;indexed at the same time.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_value_to_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">long_repr</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">BlobProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_value_to_repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="c"># Note that we may truncate even if the value is shorter than</span>
    <span class="c"># _MAX_STRING_LENGTH; e.g. if it contains many \xXX or \uUUUU</span>
    <span class="c"># escapes.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">long_repr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAX_STRING_LENGTH</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:</span>
      <span class="c"># Truncate, assuming the final character is the closing quote.</span>
      <span class="n">long_repr</span> <span class="o">=</span> <span class="n">long_repr</span><span class="p">[:</span><span class="n">_MAX_STRING_LENGTH</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;...&#39;</span> <span class="o">+</span> <span class="n">long_repr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">long_repr</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected str, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TextProperty</span><span class="p">)</span> <span class="ow">and</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
        <span class="s">&#39;Indexed value </span><span class="si">%s</span><span class="s"> must be at most </span><span class="si">%d</span><span class="s"> bytes&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">_CompressedValue</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_CompressedValue</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">z_val</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_datastore_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="c"># Since this is only used for queries, and queries imply an</span>
    <span class="c"># indexed property, always use ByteString.</span>
    <span class="k">return</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">ByteString</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_CompressedValue</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_db_set_compressed_meaning</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">z_val</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_db_set_uncompressed_meaning</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">v</span><span class="o">.</span><span class="n">set_stringvalue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_set_compressed_meaning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="c"># Use meaning_uri because setting meaning to something else that is not</span>
    <span class="c"># BLOB or BYTESTRING will cause the value to be decoded from utf-8 in</span>
    <span class="c"># datastore_types.FromPropertyPb. That would break the compressed string.</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_meaning_uri</span><span class="p">(</span><span class="n">_MEANING_URI_COMPRESSED</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">BLOB</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_set_uncompressed_meaning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">BYTESTRING</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">BLOB</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">has_stringvalue</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">stringvalue</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">meaning_uri</span><span class="p">()</span> <span class="o">==</span> <span class="n">_MEANING_URI_COMPRESSED</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">_CompressedValue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">TextProperty</span><span class="p">(</span><span class="n">BlobProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;An unindexed Property whose value is a text string of unlimited length.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="c"># Decode from UTF-8 -- if this fails, we can&#39;t write it.</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected valid UTF-8, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                             <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected string, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
        <span class="s">&#39;Indexed value </span><span class="si">%s</span><span class="s"> must be at most </span><span class="si">%d</span><span class="s"> characters&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="c"># Since older versions of NDB could write non-UTF-8 TEXT</span>
        <span class="c"># properties, we can&#39;t just reject these.  But _validate() now</span>
        <span class="c"># rejects these, so you can&#39;t write new non-UTF-8 TEXT</span>
        <span class="c"># properties.</span>
        <span class="c"># TODO: Eventually we should close this hole.</span>
        <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">_db_set_uncompressed_meaning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">StringProperty</span><span class="p">(</span><span class="n">TextProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;An indexed Property whose value is a text string of limited length.&quot;&quot;&quot;</span>

  <span class="n">_indexed</span> <span class="o">=</span> <span class="bp">True</span>


<span class="k">class</span> <span class="nc">GeoPtProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a GeoPt.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">GeoPt</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected GeoPt, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>

  <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">GeoPt</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;GeoPtProperty </span><span class="si">%s</span><span class="s"> can only be set to GeoPt values; &#39;</span>
                      <span class="s">&#39;received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">GEORSS_POINT</span><span class="p">)</span>
    <span class="n">pv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">mutable_pointvalue</span><span class="p">()</span>
    <span class="n">pv</span><span class="o">.</span><span class="n">set_x</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">pv</span><span class="o">.</span><span class="n">set_y</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">has_pointvalue</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="n">pv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">pointvalue</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">GeoPt</span><span class="p">(</span><span class="n">pv</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">pv</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_unpack_user</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Internal helper to unpack a User value from a protocol buffer.&quot;&quot;&quot;</span>
  <span class="n">uv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">uservalue</span><span class="p">()</span>
  <span class="n">email</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">uv</span><span class="o">.</span><span class="n">email</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
  <span class="n">auth_domain</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">uv</span><span class="o">.</span><span class="n">auth_domain</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
  <span class="n">obfuscated_gaiaid</span> <span class="o">=</span> <span class="n">uv</span><span class="o">.</span><span class="n">obfuscated_gaiaid</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
  <span class="n">obfuscated_gaiaid</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">obfuscated_gaiaid</span><span class="p">)</span>

  <span class="n">federated_identity</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">if</span> <span class="n">uv</span><span class="o">.</span><span class="n">has_federated_identity</span><span class="p">():</span>
    <span class="n">federated_identity</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span>
        <span class="n">uv</span><span class="o">.</span><span class="n">federated_identity</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>

  <span class="n">value</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
                     <span class="n">_auth_domain</span><span class="o">=</span><span class="n">auth_domain</span><span class="p">,</span>
                     <span class="n">_user_id</span><span class="o">=</span><span class="n">obfuscated_gaiaid</span><span class="p">,</span>
                     <span class="n">federated_identity</span><span class="o">=</span><span class="n">federated_identity</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">PickleProperty</span><span class="p">(</span><span class="n">BlobProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is any picklable Python object.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">JsonProperty</span><span class="p">(</span><span class="n">BlobProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A property whose value is any Json-encodable Python object.&quot;&quot;&quot;</span>

  <span class="n">_json_type</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">BlobProperty</span><span class="o">.</span><span class="n">_positional</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">json_type</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">JsonProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_json_type</span> <span class="o">=</span> <span class="n">json_type</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_type</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;JSON property must be a </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_type</span><span class="p">)</span>

  <span class="c"># Use late import so the dependency is optional.</span>

  <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">json</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">json</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UserProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a User object.</span>

<span class="sd">  Note: this exists for backwards compatibility with existing</span>
<span class="sd">  datastore schemas only; we do not recommend storing User objects</span>
<span class="sd">  directly in the datastore, but instead recommend storing the</span>
<span class="sd">  user.user_id() value.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_attributes</span> <span class="o">=</span> <span class="n">Property</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;_auto_current_user&#39;</span><span class="p">,</span>
                                        <span class="s">&#39;_auto_current_user_add&#39;</span><span class="p">]</span>

  <span class="n">_auto_current_user</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">_auto_current_user_add</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Property</span><span class="o">.</span><span class="n">_positional</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">auto_current_user</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">auto_current_user_add</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">UserProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="c"># TODO: Disallow combining auto_current_user* and default?</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">auto_current_user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;UserProperty could use auto_current_user and be &#39;</span>
                         <span class="s">&#39;repeated, but there would be no point.&#39;</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">auto_current_user_add</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;UserProperty could use auto_current_user_add and be &#39;</span>
                         <span class="s">&#39;repeated, but there would be no point.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_auto_current_user</span> <span class="o">=</span> <span class="n">auto_current_user</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_auto_current_user_add</span> <span class="o">=</span> <span class="n">auto_current_user_add</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">User</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected User, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>

  <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auto_current_user</span> <span class="ow">or</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auto_current_user_add</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">entity</span><span class="p">))):</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">datastore_types</span><span class="o">.</span><span class="n">PackUser</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">value</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">has_uservalue</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">_unpack_user</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">KeyProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a Key object.</span>

<span class="sd">  Optional keyword argument: kind=&lt;kind&gt;, to require that keys</span>
<span class="sd">  assigned to this property always have the indicated kind.  May be a</span>
<span class="sd">  string or a Model subclass.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_attributes</span> <span class="o">=</span> <span class="n">Property</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;_kind&#39;</span><span class="p">]</span>

  <span class="n">_kind</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Property</span><span class="o">.</span><span class="n">_positional</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="c"># Support several positional signatures:</span>
    <span class="c"># ()  =&gt;  name=None, kind from kwds</span>
    <span class="c"># (None)  =&gt;  name=None, kind from kwds</span>
    <span class="c"># (name)  =&gt;  name=arg 0, kind from kwds</span>
    <span class="c"># (kind)  =&gt;  name=None, kind=arg 0</span>
    <span class="c"># (name, kind)  =&gt; name=arg 0, kind=arg 1</span>
    <span class="c"># (kind, name)  =&gt; name=arg 1, kind=arg 0</span>
    <span class="c"># The positional kind must be a Model subclass; it cannot be a string.</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">kind</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;You can only specify one name&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">arg</span>
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;You can only specify one kind&#39;</span><span class="p">)</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">arg</span>
      <span class="k">elif</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Unexpected positional argument: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,))</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;You can only specify name once&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">kind</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;kind&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s">&#39;kind&#39;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;You can only specify kind once&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;kind must be a Model class or a string&#39;</span><span class="p">)</span>

    <span class="nb">super</span><span class="p">(</span><span class="n">KeyProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="o">=</span> <span class="n">kind</span>

  <span class="k">def</span> <span class="nf">_datastore_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">Key</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">urlsafe</span><span class="p">())</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected Key, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="c"># Reject incomplete keys.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected complete Key, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
          <span class="s">&#39;Expected Key with kind=</span><span class="si">%r</span><span class="s">, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kind</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;KeyProperty </span><span class="si">%s</span><span class="s"> can only be set to Key values; &#39;</span>
                      <span class="s">&#39;received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="c"># See datastore_types.PackKey</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">reference</span><span class="p">()</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">mutable_referencevalue</span><span class="p">()</span>  <span class="c"># A Reference</span>
    <span class="n">rv</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">app</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">has_name_space</span><span class="p">():</span>
      <span class="n">rv</span><span class="o">.</span><span class="n">set_name_space</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">name_space</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element_list</span><span class="p">():</span>
      <span class="n">rv</span><span class="o">.</span><span class="n">add_pathelement</span><span class="p">()</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">has_referencevalue</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">Reference</span><span class="p">()</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">referencevalue</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">has_app</span><span class="p">():</span>
      <span class="n">ref</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">app</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">has_name_space</span><span class="p">():</span>
      <span class="n">ref</span><span class="o">.</span><span class="n">set_name_space</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">name_space</span><span class="p">())</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">mutable_path</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">pathelement_list</span><span class="p">():</span>
      <span class="n">path</span><span class="o">.</span><span class="n">add_element</span><span class="p">()</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Key</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BlobKeyProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a BlobKey object.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">BlobKey</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected BlobKey, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>

  <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">BlobKey</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;BlobKeyProperty </span><span class="si">%s</span><span class="s"> can only be set to BlobKey values; &#39;</span>
                      <span class="s">&#39;received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">BLOBKEY</span><span class="p">)</span>
    <span class="n">v</span><span class="o">.</span><span class="n">set_stringvalue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">has_stringvalue</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">datastore_types</span><span class="o">.</span><span class="n">BlobKey</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">stringvalue</span><span class="p">())</span>


<span class="c"># The Epoch (a zero POSIX timestamp).</span>
<span class="n">_EPOCH</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DateTimeProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a datetime object.</span>

<span class="sd">  Note: Unlike Django, auto_now_add can be overridden by setting the</span>
<span class="sd">  value before writing the entity.  And unlike classic db, auto_now</span>
<span class="sd">  does not supply a default value.  Also unlike classic db, when the</span>
<span class="sd">  entity is written, the property values are updated to match what</span>
<span class="sd">  was written.  Finally, beware that this also updates the value in</span>
<span class="sd">  the in-process cache, *and* that auto_now_add may interact weirdly</span>
<span class="sd">  with transaction retries (a retry of a property with auto_now_add</span>
<span class="sd">  set will reuse the value that was set on the first try).</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_attributes</span> <span class="o">=</span> <span class="n">Property</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;_auto_now&#39;</span><span class="p">,</span> <span class="s">&#39;_auto_now_add&#39;</span><span class="p">]</span>

  <span class="n">_auto_now</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">_auto_now_add</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Property</span><span class="o">.</span><span class="n">_positional</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">auto_now</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">DateTimeProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="c"># TODO: Disallow combining auto_now* and default?</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">auto_now</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;DateTimeProperty </span><span class="si">%s</span><span class="s"> could use auto_now and be &#39;</span>
                         <span class="s">&#39;repeated, but there would be no point.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">auto_now_add</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;DateTimeProperty </span><span class="si">%s</span><span class="s"> could use auto_now_add and be &#39;</span>
                         <span class="s">&#39;repeated, but there would be no point.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_auto_now</span> <span class="o">=</span> <span class="n">auto_now</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_auto_now_add</span> <span class="o">=</span> <span class="n">auto_now_add</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected datetime, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>

  <span class="k">def</span> <span class="nf">_now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auto_now</span> <span class="ow">or</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auto_now_add</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">entity</span><span class="p">))):</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;DatetimeProperty </span><span class="si">%s</span><span class="s"> can only be set to datetime values; &#39;</span>
                      <span class="s">&#39;received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;DatetimeProperty </span><span class="si">%s</span><span class="s"> can only support UTC. &#39;</span>
                                <span class="s">&#39;Please derive a new Property to support &#39;</span>
                                <span class="s">&#39;alternative timezones.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="n">_EPOCH</span>
    <span class="n">ival</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">+</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
    <span class="n">v</span><span class="o">.</span><span class="n">set_int64value</span><span class="p">(</span><span class="n">ival</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">GD_WHEN</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">unused_p</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">has_int64value</span><span class="p">():</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="n">ival</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">int64value</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_EPOCH</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">microseconds</span><span class="o">=</span><span class="n">ival</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_date_to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convert a date to a datetime for datastore storage.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A datetime.date object.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A datetime object with time set to 0:00.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Cannot convert to datetime expected date value; &#39;</span>
                    <span class="s">&#39;received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_time_to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convert a time to a datetime for datastore storage.</span>

<span class="sd">  Args:</span>
<span class="sd">    value: A datetime.time object.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A datetime object with date set to 1970-01-01.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Cannot convert to datetime expected time value; &#39;</span>
                    <span class="s">&#39;received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">value</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                           <span class="n">value</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DateProperty</span><span class="p">(</span><span class="n">DateTimeProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a date object.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected date, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>

  <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_date_to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TimeProperty</span><span class="p">(</span><span class="n">DateTimeProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is a time object.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected time, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="n">value</span><span class="p">,))</span>

  <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_time_to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_StructuredGetForDictMixin</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Mixin class so *StructuredProperty can share _get_for_dict().</span>

<span class="sd">  The behavior here is that sub-entities are converted to dictionaries</span>
<span class="sd">  by calling to_dict() on them (also doing the right thing for</span>
<span class="sd">  repeated properties).</span>

<span class="sd">  NOTE: Even though the _validate() method in StructuredProperty and</span>
<span class="sd">  LocalStructuredProperty are identical, they cannot be moved into</span>
<span class="sd">  this shared base class.  The reason is subtle: _validate() is not a</span>
<span class="sd">  regular method, but treated specially by _call_to_base_type() and</span>
<span class="sd">  _call_shallow_validation(), and the class where it occurs matters</span>
<span class="sd">  if it also defines _to_base_type().</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_get_for_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">StructuredProperty</span><span class="p">(</span><span class="n">_StructuredGetForDictMixin</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is itself an entity.</span>

<span class="sd">  The values of the sub-entity are indexed and can be queried.</span>

<span class="sd">  See the module docstring for details.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_modelclass</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_modelclass&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">Property</span><span class="o">.</span><span class="n">_attributes</span>
  <span class="n">_positional</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">Property</span><span class="o">.</span><span class="n">_positional</span>  <span class="c"># Add modelclass as positional arg.</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">_positional</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelclass</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">StructuredProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">modelclass</span><span class="o">.</span><span class="n">_has_repeated</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;This StructuredProperty cannot use repeated=True &#39;</span>
                        <span class="s">&#39;because its model class (</span><span class="si">%s</span><span class="s">) contains repeated &#39;</span>
                        <span class="s">&#39;properties (directly or indirectly).&#39;</span> <span class="o">%</span>
                        <span class="n">modelclass</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span> <span class="o">=</span> <span class="n">modelclass</span>

  <span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Override _get_value() to *not* raise UnprojectedPropertyError.&quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
      <span class="c"># Invoke super _get_value() to raise the proper exception.</span>
      <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">StructuredProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dynamically get a subproperty.&quot;&quot;&quot;</span>
    <span class="c"># Optimistically try to use the dict key.</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>
    <span class="c"># We&#39;re done if we have a hit and _code_name matches.</span>
    <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span> <span class="o">!=</span> <span class="n">attrname</span><span class="p">:</span>
      <span class="c"># Otherwise, use linear search looking for a matching _code_name.</span>
      <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span> <span class="o">==</span> <span class="n">attrname</span><span class="p">:</span>
          <span class="k">break</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c"># This is executed when we never execute the above break.</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;Model subclass </span><span class="si">%s</span><span class="s"> has no attribute </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">attrname</span><span class="p">))</span>
    <span class="n">prop_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
    <span class="n">prop_copy</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">prop_copy</span><span class="o">.</span><span class="n">_name</span>
    <span class="c"># Cache the outcome, so subsequent requests for the same attribute</span>
    <span class="c"># name will get the copied property directly rather than going</span>
    <span class="c"># through the above motions all over again.</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">prop_copy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prop_copy</span>

  <span class="k">def</span> <span class="nf">_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">op</span> <span class="o">!=</span> <span class="s">&#39;=&#39;</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
        <span class="s">&#39;StructuredProperty filter can only use ==&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
        <span class="s">&#39;Cannot query for unindexed StructuredProperty </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    <span class="c"># Import late to avoid circular imports.</span>
    <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">ConjunctionNode</span><span class="p">,</span> <span class="n">PostFilterNode</span>
    <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">RepeatedStructuredPropertyPredicate</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">FilterNode</span>  <span class="c"># Import late to avoid circular imports.</span>
      <span class="k">return</span> <span class="n">FilterNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_to_base_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">match_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># TODO: Why not just iterate over value._values?</span>
    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
      <span class="n">vals</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_get_base_value_unwrapped_as_list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vals</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
            <span class="s">&#39;Cannot query for non-empty repeated property </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">prop</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">continue</span>
      <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">altprop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span><span class="p">)</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">altprop</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
        <span class="n">match_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">altprop</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadFilterError</span><span class="p">(</span>
        <span class="s">&#39;StructuredProperty filter without any values&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
      <span class="n">pb</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_to_pb</span><span class="p">(</span><span class="n">allow_partial</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
      <span class="n">pred</span> <span class="o">=</span> <span class="n">RepeatedStructuredPropertyPredicate</span><span class="p">(</span><span class="n">match_keys</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span><span class="p">)</span>
      <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PostFilterNode</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ConjunctionNode</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_IN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
        <span class="s">&#39;Expected list, tuple or set, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">DisjunctionNode</span><span class="p">,</span> <span class="n">FalseNode</span>
    <span class="c"># Expand to a series of == filters.</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_comparison</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
      <span class="c"># DisjunctionNode doesn&#39;t like an empty list of filters.</span>
      <span class="c"># Running the query will still fail, but this matches the</span>
      <span class="c"># behavior of IN for regular properties.</span>
      <span class="k">return</span> <span class="n">FalseNode</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">DisjunctionNode</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">)</span>
  <span class="n">IN</span> <span class="o">=</span> <span class="n">_IN</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="c"># A dict is assumed to be the result of a _to_dict() call.</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected </span><span class="si">%s</span><span class="s"> instance, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_has_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c"># rest: optional list of attribute names to check in addition.</span>
    <span class="c"># Basically, prop._has_value(self, ent, [&#39;x&#39;, &#39;y&#39;]) is similar to</span>
    <span class="c">#   (prop._has_value(ent) and</span>
    <span class="c">#    prop.x._has_value(ent.x) and</span>
    <span class="c">#    prop.x.y._has_value(ent.x.y))</span>
    <span class="c"># assuming prop.x and prop.x.y exist.</span>
    <span class="c"># NOTE: This is not particularly efficient if len(rest) &gt; 1,</span>
    <span class="c"># but that seems a rare case, so for now I don&#39;t care.</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">StructuredProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">rest</span><span class="p">:</span>
      <span class="n">lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_value_unwrapped_as_list</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Failed to retrieve sub-entity of StructuredProperty&#39;</span>
                           <span class="s">&#39; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
      <span class="n">subent</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">subent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
      <span class="n">subprop</span> <span class="o">=</span> <span class="n">subent</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">subprop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">subprop</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">subent</span><span class="p">,</span> <span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">ok</span>

  <span class="k">def</span> <span class="nf">_serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">parent_repeated</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">projection</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c"># entity -&gt; pb; pb is an EntityProto message</span>
    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_value_unwrapped_as_list</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># TODO: Avoid re-sorting for repeated values.</span>
        <span class="k">for</span> <span class="n">unused_name</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()):</span>
          <span class="n">prop</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span> <span class="ow">or</span> <span class="n">parent_repeated</span><span class="p">,</span>
                          <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c"># Serialize a single None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StructuredProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span>
          <span class="n">entity</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">parent_repeated</span><span class="o">=</span><span class="n">parent_repeated</span><span class="p">,</span>
          <span class="n">projection</span><span class="o">=</span><span class="n">projection</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
      <span class="n">subentity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">subentity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">subentity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">(</span><span class="n">subentity</span><span class="p">))</span>
      <span class="n">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subentity</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">):</span>
        <span class="c"># NOTE: It may not be a _BaseValue when we&#39;re deserializing a</span>
        <span class="c"># repeated structured property.</span>
        <span class="n">subentity</span> <span class="o">=</span> <span class="n">subentity</span><span class="o">.</span><span class="n">b_val</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subentity</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Cannot deserialize StructuredProperty </span><span class="si">%s</span><span class="s">; value &#39;</span>
                           <span class="s">&#39;retrieved not a </span><span class="si">%s</span><span class="s"> instance </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">subentity</span><span class="p">))</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="n">subentity</span><span class="o">.</span><span class="n">_get_property_for</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Special case: kill subentity after all.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="n">prop</span><span class="o">.</span><span class="n">_deserialize</span><span class="p">(</span><span class="n">subentity</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="c"># The repeated case is more complicated.</span>
    <span class="c"># TODO: Prove we won&#39;t get here for orphans.</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">depth</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;StructuredProperty </span><span class="si">%s</span><span class="s"> expected to find properties &#39;</span>
                         <span class="s">&#39;separated by periods at a depth of </span><span class="si">%i</span><span class="s">; received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">parts</span><span class="p">))</span>
    <span class="nb">next</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
    <span class="n">prop_is_fake</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c"># Synthesize a fake property.  (We can&#39;t use Model._fake_property()</span>
      <span class="c"># because we need the property before we can determine the subentity.)</span>
      <span class="k">if</span> <span class="n">rest</span><span class="p">:</span>
        <span class="c"># TODO: Handle this case, too.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Skipping unknown structured subproperty (</span><span class="si">%s</span><span class="s">) &#39;</span>
                     <span class="s">&#39;in repeated structured property (</span><span class="si">%s</span><span class="s"> of </span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span>
                     <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="c"># TODO: Figure out the value for indexed.  Unfortunately we&#39;d</span>
      <span class="c"># need this passed in from _from_pb(), which would mean a</span>
      <span class="c"># signature change for _deserialize(), which might break valid</span>
      <span class="c"># end-user code that overrides it.</span>
      <span class="n">compressed</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">meaning_uri</span><span class="p">()</span> <span class="o">==</span> <span class="n">_MEANING_URI_COMPRESSED</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="n">GenericProperty</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span>
      <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span> <span class="o">=</span> <span class="nb">next</span>
      <span class="n">prop_is_fake</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># Find the first subentity that doesn&#39;t have a value for this</span>
    <span class="c"># property yet.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s">&#39;_subentity_counter&#39;</span><span class="p">):</span>
      <span class="n">entity</span><span class="o">.</span><span class="n">_subentity_counter</span> <span class="o">=</span> <span class="n">_NestedCounter</span><span class="p">()</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">_subentity_counter</span>
    <span class="n">counter_path</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">next_index</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">counter_path</span><span class="p">)</span>
    <span class="n">subentity</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
      <span class="c"># If an entire subentity has been set to None, we have to loop</span>
      <span class="c"># to advance until we find the next partial entity.</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">next_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_value_size</span><span class="p">(</span><span class="n">entity</span><span class="p">)):</span>
        <span class="n">subentity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_value_at_index</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">next_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subentity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;sub-entities must be instances &#39;</span>
                          <span class="s">&#39;of their Model class.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prop</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="n">subentity</span><span class="p">,</span> <span class="n">rest</span><span class="p">):</span>
          <span class="k">break</span>
        <span class="n">next_index</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="n">counter_path</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">subentity</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># The current property is going to be populated, so advance the counter.</span>
    <span class="n">counter</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="n">counter_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">subentity</span><span class="p">:</span>
      <span class="c"># We didn&#39;t find one.  Add a new one to the underlying list of</span>
      <span class="c"># values.</span>
      <span class="n">subentity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="p">()</span>
      <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>
      <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_BaseValue</span><span class="p">(</span><span class="n">subentity</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">prop_is_fake</span><span class="p">:</span>
      <span class="c"># Add the synthetic property to the subentity&#39;s _properties</span>
      <span class="c"># dict, so that it will be correctly deserialized.</span>
      <span class="c"># (See Model._fake_property() for comparison.)</span>
      <span class="n">subentity</span><span class="o">.</span><span class="n">_clone_properties</span><span class="p">()</span>
      <span class="n">subentity</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">_deserialize</span><span class="p">(</span><span class="n">subentity</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_value_unwrapped_as_list</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">value</span><span class="o">.</span><span class="n">_prepare_for_put</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_check_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rest</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">require_indexed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Override for Property._check_property().</span>

<span class="sd">    Raises:</span>
<span class="sd">      InvalidPropertyError if no subproperty is specified or if something</span>
<span class="sd">      is wrong with the subproperty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rest</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">InvalidPropertyError</span><span class="p">(</span>
        <span class="s">&#39;Structured property </span><span class="si">%s</span><span class="s"> requires a subproperty&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="o">.</span><span class="n">_check_properties</span><span class="p">([</span><span class="n">rest</span><span class="p">],</span> <span class="n">require_indexed</span><span class="o">=</span><span class="n">require_indexed</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_base_value_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>
    <span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt_call_to_base_type</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">b_val</span>

  <span class="k">def</span> <span class="nf">_get_value_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LocalStructuredProperty</span><span class="p">(</span><span class="n">_StructuredGetForDictMixin</span><span class="p">,</span> <span class="n">BlobProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Substructure that is serialized to an opaque blob.</span>

<span class="sd">  This looks like StructuredProperty on the Python side, but is</span>
<span class="sd">  written like a BlobProperty in the datastore.  It is not indexed</span>
<span class="sd">  and you cannot query for subproperties.  On the other hand, the</span>
<span class="sd">  on-disk representation is more efficient and can be made even more</span>
<span class="sd">  efficient by passing compressed=True, which compresses the blob</span>
<span class="sd">  data using gzip.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_indexed</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">_modelclass</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_keep_keys</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="n">_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_modelclass&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">BlobProperty</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;_keep_keys&#39;</span><span class="p">]</span>
  <span class="n">_positional</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">BlobProperty</span><span class="o">.</span><span class="n">_positional</span>  <span class="c"># Add modelclass as positional.</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">_positional</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelclass</span><span class="p">,</span>
               <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">keep_keys</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">LocalStructuredProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                                  <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">,</span>
                                                  <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Cannot index LocalStructuredProperty </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span> <span class="o">=</span> <span class="n">modelclass</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_keep_keys</span> <span class="o">=</span> <span class="n">keep_keys</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="c"># A dict is assumed to be the result of a _to_dict() call.</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span><span class="s">&#39;Expected </span><span class="si">%s</span><span class="s"> instance, got </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="p">):</span>
      <span class="n">pb</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_to_pb</span><span class="p">(</span><span class="n">set_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_keep_keys</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">pb</span><span class="o">.</span><span class="n">SerializePartialToString</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="p">):</span>
      <span class="n">pb</span> <span class="o">=</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">EntityProto</span><span class="p">()</span>
      <span class="n">pb</span><span class="o">.</span><span class="n">MergePartialFromString</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_keys</span><span class="p">:</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">clear_key</span><span class="p">()</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelclass</span><span class="o">.</span><span class="n">_from_pb</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="c"># TODO: Using _get_user_value() here makes it impossible to</span>
    <span class="c"># subclass this class and add a _from_base_type().  But using</span>
    <span class="c"># _get_base_value() won&#39;t work, since that would return</span>
    <span class="c"># the serialized (and possibly compressed) serialized blob.</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">subent</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">subent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">subent</span><span class="o">.</span><span class="n">_prepare_for_put</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span><span class="o">.</span><span class="n">_prepare_for_put</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_db_set_uncompressed_meaning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">ENTITY_PROTO</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GenericProperty</span><span class="p">(</span><span class="n">Property</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value can be (almost) any basic type.</span>

<span class="sd">  This is mainly used for Expando and for orphans (values present in</span>
<span class="sd">  the datastore but not represented in the Model subclass) but can</span>
<span class="sd">  also be used explicitly for properties with dynamically-typed</span>
<span class="sd">  values.</span>

<span class="sd">  This supports compressed=True, which is only effective for str</span>
<span class="sd">  values (not for unicode), and implies indexed=False.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_compressed</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="n">_attributes</span> <span class="o">=</span> <span class="n">Property</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;_compressed&#39;</span><span class="p">]</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Property</span><span class="o">.</span><span class="n">_positional</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">compressed</span><span class="p">:</span>  <span class="c"># Compressed implies unindexed.</span>
      <span class="n">kwds</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;indexed&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">GenericProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="o">=</span> <span class="n">compressed</span>
    <span class="k">if</span> <span class="n">compressed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
      <span class="c"># TODO: Allow this, but only allow == and IN comparisons?</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;GenericProperty </span><span class="si">%s</span><span class="s"> cannot be compressed and &#39;</span>
                                <span class="s">&#39;indexed at the same time.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_to_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">_CompressedValue</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_from_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_CompressedValue</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">z_val</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span> <span class="ow">and</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
        <span class="s">&#39;Indexed value </span><span class="si">%s</span><span class="s"> must be at most </span><span class="si">%d</span><span class="s"> bytes&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">_MAX_STRING_LENGTH</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_db_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="c"># This is awkward but there seems to be no faster way to inspect</span>
    <span class="c"># what union member is present.  datastore_types.FromPropertyPb(),</span>
    <span class="c"># the undisputed authority, has the same series of if-elif blocks.</span>
    <span class="c"># (We don&#39;t even want to think about multiple members... :-)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">has_stringvalue</span><span class="p">():</span>
      <span class="n">sval</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">stringvalue</span><span class="p">()</span>
      <span class="n">meaning</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">meaning</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">meaning</span> <span class="o">==</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">BLOBKEY</span><span class="p">:</span>
        <span class="n">sval</span> <span class="o">=</span> <span class="n">BlobKey</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">meaning</span> <span class="o">==</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">BLOB</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">meaning_uri</span><span class="p">()</span> <span class="o">==</span> <span class="n">_MEANING_URI_COMPRESSED</span><span class="p">:</span>
          <span class="n">sval</span> <span class="o">=</span> <span class="n">_CompressedValue</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">meaning</span> <span class="o">==</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">ENTITY_PROTO</span><span class="p">:</span>
        <span class="c"># NOTE: This is only used for uncompressed LocalStructuredProperties.</span>
        <span class="n">pb</span> <span class="o">=</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">EntityProto</span><span class="p">()</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">MergePartialFromString</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>
        <span class="n">modelclass</span> <span class="o">=</span> <span class="n">Expando</span>
        <span class="k">if</span> <span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element_size</span><span class="p">():</span>
          <span class="n">kind</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">()</span>
          <span class="n">modelclass</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_kind_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">modelclass</span><span class="p">)</span>
        <span class="n">sval</span> <span class="o">=</span> <span class="n">modelclass</span><span class="o">.</span><span class="n">_from_pb</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">meaning</span> <span class="o">!=</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">BYTESTRING</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">sval</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
          <span class="c"># If this passes, don&#39;t return unicode.</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
          <span class="k">try</span><span class="p">:</span>
            <span class="n">sval</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">sval</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
          <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="k">pass</span>
      <span class="k">return</span> <span class="n">sval</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">has_int64value</span><span class="p">():</span>
      <span class="n">ival</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">int64value</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">meaning</span><span class="p">()</span> <span class="o">==</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">GD_WHEN</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_EPOCH</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">microseconds</span><span class="o">=</span><span class="n">ival</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">ival</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">has_booleanvalue</span><span class="p">():</span>
      <span class="c"># The booleanvalue field is an int32, so booleanvalue() returns</span>
      <span class="c"># an int, hence the conversion.</span>
      <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">booleanvalue</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">has_doublevalue</span><span class="p">():</span>
      <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">doublevalue</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">has_referencevalue</span><span class="p">():</span>
      <span class="n">rv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">referencevalue</span><span class="p">()</span>
      <span class="n">app</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">app</span><span class="p">()</span>
      <span class="n">namespace</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">name_space</span><span class="p">()</span>
      <span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">elem</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span> <span class="n">elem</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="ow">or</span> <span class="n">elem</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
               <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">pathelement_list</span><span class="p">()]</span>
      <span class="k">return</span> <span class="n">Key</span><span class="p">(</span><span class="n">pairs</span><span class="o">=</span><span class="n">pairs</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">has_pointvalue</span><span class="p">():</span>
      <span class="n">pv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">pointvalue</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">GeoPt</span><span class="p">(</span><span class="n">pv</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">pv</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">has_uservalue</span><span class="p">():</span>
      <span class="k">return</span> <span class="n">_unpack_user</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c"># A missing value implies null.</span>
      <span class="k">return</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">_db_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="c"># TODO: use a dict mapping types to functions</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="n">v</span><span class="o">.</span><span class="n">set_stringvalue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="c"># TODO: Set meaning to BLOB or BYTESTRING if it&#39;s not UTF-8?</span>
      <span class="c"># (Or TEXT if unindexed.)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
      <span class="n">v</span><span class="o">.</span><span class="n">set_stringvalue</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">))</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexed</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">TEXT</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>  <span class="c"># Must test before int!</span>
      <span class="n">v</span><span class="o">.</span><span class="n">set_booleanvalue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="n">_MAX_LONG</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">_MAX_LONG</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> can only accept 64-bit integers; &#39;</span>
                        <span class="s">&#39;received </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
      <span class="n">v</span><span class="o">.</span><span class="n">set_int64value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
      <span class="n">v</span><span class="o">.</span><span class="n">set_doublevalue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Key</span><span class="p">):</span>
      <span class="c"># See datastore_types.PackKey</span>
      <span class="n">ref</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">reference</span><span class="p">()</span>
      <span class="n">rv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">mutable_referencevalue</span><span class="p">()</span>  <span class="c"># A Reference</span>
      <span class="n">rv</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">app</span><span class="p">())</span>
      <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">has_name_space</span><span class="p">():</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">set_name_space</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">name_space</span><span class="p">())</span>
      <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element_list</span><span class="p">():</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">add_pathelement</span><span class="p">()</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> can only support the UTC. &#39;</span>
                                  <span class="s">&#39;Please derive a new Property to support &#39;</span>
                                  <span class="s">&#39;alternative timezones.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
      <span class="n">dt</span> <span class="o">=</span> <span class="n">value</span> <span class="o">-</span> <span class="n">_EPOCH</span>
      <span class="n">ival</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">+</span> <span class="mi">1000000</span> <span class="o">*</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
      <span class="n">v</span><span class="o">.</span><span class="n">set_int64value</span><span class="p">(</span><span class="n">ival</span><span class="p">)</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">GD_WHEN</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">GeoPt</span><span class="p">):</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">GEORSS_POINT</span><span class="p">)</span>
      <span class="n">pv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">mutable_pointvalue</span><span class="p">()</span>
      <span class="n">pv</span><span class="o">.</span><span class="n">set_x</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
      <span class="n">pv</span><span class="o">.</span><span class="n">set_y</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">users</span><span class="o">.</span><span class="n">User</span><span class="p">):</span>
      <span class="n">datastore_types</span><span class="o">.</span><span class="n">PackUser</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">value</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BlobKey</span><span class="p">):</span>
      <span class="n">v</span><span class="o">.</span><span class="n">set_stringvalue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">BLOBKEY</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
      <span class="n">set_key</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
      <span class="n">pb</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_to_pb</span><span class="p">(</span><span class="n">set_key</span><span class="o">=</span><span class="n">set_key</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">SerializePartialToString</span><span class="p">()</span>
      <span class="n">v</span><span class="o">.</span><span class="n">set_stringvalue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">ENTITY_PROTO</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_CompressedValue</span><span class="p">):</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">z_val</span>
      <span class="n">v</span><span class="o">.</span><span class="n">set_stringvalue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_meaning_uri</span><span class="p">(</span><span class="n">_MEANING_URI_COMPRESSED</span><span class="p">)</span>
      <span class="n">p</span><span class="o">.</span><span class="n">set_meaning</span><span class="p">(</span><span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">BLOB</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> does not support </span><span class="si">%s</span><span class="s"> types.&#39;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>


<span class="k">class</span> <span class="nc">ComputedProperty</span><span class="p">(</span><span class="n">GenericProperty</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Property whose value is determined by a user-supplied function.</span>

<span class="sd">  Computed properties cannot be set directly, but are instead generated by a</span>
<span class="sd">  function when required. They are useful to provide fields in the datastore</span>
<span class="sd">  that can be used for filtering or sorting without having to manually set the</span>
<span class="sd">  value in code - for example, sorting on the length of a BlobProperty, or</span>
<span class="sd">  using an equality filter to check if another field is not empty.</span>

<span class="sd">  ComputedProperty can be declared as a regular property, passing a function as</span>
<span class="sd">  the first argument, or it can be used as a decorator for the function that</span>
<span class="sd">  does the calculation.</span>

<span class="sd">  Example:</span>

<span class="sd">  &gt;&gt;&gt; class DatastoreFile(Model):</span>
<span class="sd">  ...   name = StringProperty()</span>
<span class="sd">  ...   name_lower = ComputedProperty(lambda self: self.name.lower())</span>
<span class="sd">  ...</span>
<span class="sd">  ...   data = BlobProperty()</span>
<span class="sd">  ...</span>
<span class="sd">  ...   @ComputedProperty</span>
<span class="sd">  ...   def size(self):</span>
<span class="sd">  ...     return len(self.data)</span>
<span class="sd">  ...</span>
<span class="sd">  ...   def _compute_hash(self):</span>
<span class="sd">  ...     return hashlib.sha1(self.data).hexdigest()</span>
<span class="sd">  ...   hash = ComputedProperty(_compute_hash, name=&#39;sha1&#39;)</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">repeated</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Constructor.</span>

<span class="sd">    Args:</span>
<span class="sd">      func: A function that takes one argument, the model instance, and returns</span>
<span class="sd">            a calculated value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ComputedProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">,</span>
                                           <span class="n">repeated</span><span class="o">=</span><span class="n">repeated</span><span class="p">,</span>
                                           <span class="n">verbose_name</span><span class="o">=</span><span class="n">verbose_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>

  <span class="k">def</span> <span class="nf">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">ComputedPropertyError</span><span class="p">(</span><span class="s">&quot;Cannot assign to a ComputedProperty&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_delete_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">ComputedPropertyError</span><span class="p">(</span><span class="s">&quot;Cannot delete a ComputedProperty&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="c"># About projections and computed properties: if the computed</span>
    <span class="c"># property itself is in the projection, don&#39;t recompute it; this</span>
    <span class="c"># prevents raising UnprojectedPropertyError if one of the</span>
    <span class="c"># dependents is not in the projection.  However, if the computed</span>
    <span class="c"># property is not in the projection, compute it normally -- its</span>
    <span class="c"># dependents may all be in the projection, and it may be useful to</span>
    <span class="c"># access the computed value without having it in the projection.</span>
    <span class="c"># In this case, if any of the dependents is not in the projection,</span>
    <span class="c"># accessing it in the computation function will raise</span>
    <span class="c"># UnprojectedPropertyError which will just bubble up.</span>
    <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ComputedProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>  <span class="c"># For its side effects.</span>


<span class="k">class</span> <span class="nc">MetaModel</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Metaclass for Model.</span>

<span class="sd">  This exists to fix up the properties -- they need to know their name.</span>
<span class="sd">  This is accomplished by calling the class&#39;s _fix_properties() method.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">classdict</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MetaModel</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">classdict</span><span class="p">)</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_fix_up_properties</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()):</span>
      <span class="n">props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span><span class="p">,</span> <span class="n">prop</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">props</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">_NotEqualMixin</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A class describing datastore entities.</span>

<span class="sd">  Model instances are usually called entities.  All model classes</span>
<span class="sd">  inheriting from Model automatically have MetaModel as their</span>
<span class="sd">  metaclass, so that the properties are fixed up properly after the</span>
<span class="sd">  class once the class is defined.</span>

<span class="sd">  Because of this, you cannot use the same Property object to describe</span>
<span class="sd">  multiple properties -- you must create separate Property objects for</span>
<span class="sd">  each property.  E.g. this does not work:</span>

<span class="sd">    wrong_prop = StringProperty()</span>
<span class="sd">    class Wrong(Model):</span>
<span class="sd">      wrong1 = wrong_prop</span>
<span class="sd">      wrong2 = wrong_prop</span>

<span class="sd">  The kind is normally equal to the class name (exclusive of the</span>
<span class="sd">  module name or any other parent scope).  To override the kind,</span>
<span class="sd">  define a class method named _get_kind(), as follows:</span>

<span class="sd">    class MyModel(Model):</span>
<span class="sd">      @classmethod</span>
<span class="sd">      def _get_kind(cls):</span>
<span class="sd">        return &#39;AnotherKind&#39;</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">MetaModel</span>

  <span class="c"># Class variables updated by _fix_up_properties()</span>
  <span class="n">_properties</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_has_repeated</span> <span class="o">=</span> <span class="bp">False</span>
  <span class="n">_kind_map</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># Dict mapping {kind: Model subclass}</span>

  <span class="c"># Defaults for instance variables.</span>
  <span class="n">_entity_key</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_values</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">_projection</span> <span class="o">=</span> <span class="p">()</span>  <span class="c"># Tuple of names of projected properties.</span>

  <span class="c"># Hardcoded pseudo-property for the key.</span>
  <span class="n">_key</span> <span class="o">=</span> <span class="n">ModelKey</span><span class="p">()</span>
  <span class="n">key</span> <span class="o">=</span> <span class="n">_key</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a new instance of this model (a.k.a. an entity).</span>

<span class="sd">    The new entity must be written to the datastore using an explicit</span>
<span class="sd">    call to .put().</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">      key: Key instance for this model. If key is used, id and parent must</span>
<span class="sd">        be None.</span>
<span class="sd">      id: Key id for this model. If id is used, key must be None.</span>
<span class="sd">      parent: Key instance for the parent model or None for a top-level one.</span>
<span class="sd">        If parent is used, key must be None.</span>
<span class="sd">      namespace: Optional namespace.</span>
<span class="sd">      app: Optional app ID.</span>
<span class="sd">      **kwds: Keyword arguments mapping to properties of this model.</span>

<span class="sd">    Note: you cannot define a property named key; the .key attribute</span>
<span class="sd">    always refers to the entity&#39;s key.  But you can define properties</span>
<span class="sd">    named id or parent.  Values for the latter cannot be passed</span>
<span class="sd">    through the constructor, but can be assigned to entity attributes</span>
<span class="sd">    after the entity has been created.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Model constructor takes no positional arguments.&#39;</span><span class="p">)</span>
    <span class="c"># self is passed implicitly through args so users can define a property</span>
    <span class="c"># named &#39;self&#39;.</span>
    <span class="p">(</span><span class="bp">self</span><span class="p">,)</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">get_arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_arg</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;key&#39;</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;app&#39;</span><span class="p">)</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;namespace&#39;</span><span class="p">)</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;parent&#39;</span><span class="p">)</span>
    <span class="n">projection</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;projection&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span>
          <span class="n">app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadArgumentError</span><span class="p">(</span>
            <span class="s">&#39;Model constructor given key= does not accept &#39;</span>
            <span class="s">&#39;id=, app=, namespace=, or parent=.&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">_validate_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span>
          <span class="n">app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span> <span class="nb">id</span><span class="p">,</span>
                      <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span>
    <span class="c"># Set the projection last, otherwise it will prevent _set_attributes().</span>
    <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_set_projection</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">__get_arg</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">kwds</span><span class="p">,</span> <span class="n">kwd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper method to parse keywords that may be property names.&quot;&quot;&quot;</span>
    <span class="n">alt_kwd</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">kwd</span>
    <span class="k">if</span> <span class="n">alt_kwd</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">alt_kwd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwd</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
      <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">kwd</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Property</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ModelKey</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">kwd</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_pb</span><span class="p">()</span><span class="o">.</span><span class="n">Encode</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serialized_pb</span><span class="p">):</span>
    <span class="n">pb</span> <span class="o">=</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">EntityProto</span><span class="p">(</span><span class="n">serialized_pb</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">_from_pb</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">set_key</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Populate an instance from keyword arguments.</span>

<span class="sd">    Each keyword argument will be used to set a corresponding</span>
<span class="sd">    property.  Keywords must refer to valid property name.  This is</span>
<span class="sd">    similar to passing keyword arguments to the Model constructor,</span>
<span class="sd">    except that no provisions for key, id or parent are made.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span>
  <span class="n">populate</span> <span class="o">=</span> <span class="n">_populate</span>

  <span class="k">def</span> <span class="nf">_set_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to set attributes from keyword arguments.</span>

<span class="sd">    Expando overrides this.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwds</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>  <span class="c"># Raises AttributeError for unknown properties.</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">Property</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Cannot set non-property </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
      <span class="n">prop</span><span class="o">.</span><span class="n">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_find_uninitialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to find uninitialized properties.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A set of property names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">name</span>
               <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>
               <span class="k">if</span> <span class="ow">not</span> <span class="n">prop</span><span class="o">.</span><span class="n">_is_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_check_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to check for uninitialized properties.</span>

<span class="sd">    Raises:</span>
<span class="sd">      BadValueError if it finds any.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">baddies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_uninitialized</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">baddies</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadValueError</span><span class="p">(</span>
        <span class="s">&#39;Entity has uninitialized properties: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">baddies</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an unambiguous string representation of an entity.&quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">_has_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_retrieve_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">rep</span> <span class="o">=</span> <span class="s">&#39;None&#39;</span>
        <span class="k">elif</span> <span class="n">prop</span><span class="o">.</span><span class="n">_repeated</span><span class="p">:</span>
          <span class="n">reprs</span> <span class="o">=</span> <span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">_value_to_repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
          <span class="k">if</span> <span class="n">reprs</span><span class="p">:</span>
            <span class="n">reprs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;[&#39;</span> <span class="o">+</span> <span class="n">reprs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">reprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reprs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;]&#39;</span>
            <span class="n">rep</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reprs</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">rep</span> <span class="o">=</span> <span class="s">&#39;[]&#39;</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">rep</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_value_to_repr</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span><span class="p">,</span> <span class="n">rep</span><span class="p">))</span>
    <span class="n">args</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">args</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;key=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
      <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;_projection=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">,))</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">s</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_get_kind</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the kind name for this class.</span>

<span class="sd">    This defaults to cls.__name__; users may overrid this to give a</span>
<span class="sd">    class a different on-disk name than its class name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_class_name</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A hook for polymodel to override.</span>

<span class="sd">    For regular models and expandos this is just an alias for</span>
<span class="sd">    _get_kind().  For PolyModel subclasses, it returns the class name</span>
<span class="sd">    (as set in the &#39;class&#39; attribute thereof), whereas _get_kind()</span>
<span class="sd">    returns the kind (the class name of the root class of a specific</span>
<span class="sd">    PolyModel hierarchy).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_default_filters</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an iterable of filters that are always to be applied.</span>

<span class="sd">    This is used by PolyModel to quietly insert a filter for the</span>
<span class="sd">    current class name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">()</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_reset_kind_map</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clear the kind map.  Useful for testing.&quot;&quot;&quot;</span>
    <span class="c"># Preserve &quot;system&quot; kinds, like __namespace__</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_kind_map</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">):</span>
        <span class="n">keep</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_kind_map</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_kind_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_lookup_model</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">default_model</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the model class for the kind.</span>

<span class="sd">    Args:</span>
<span class="sd">      kind: A string representing the name of the kind to lookup.</span>
<span class="sd">      default_model: The model class to use if the kind can&#39;t be found.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The model class for the requested kind.</span>
<span class="sd">    Raises:</span>
<span class="sd">      KindError: The kind was not found and no default_model was provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">modelclass</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_kind_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">default_model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modelclass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span>
          <span class="s">&quot;No model class found for kind &#39;</span><span class="si">%s</span><span class="s">&#39;. Did you forget to import it?&quot;</span> <span class="o">%</span>
          <span class="n">kind</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">modelclass</span>

  <span class="k">def</span> <span class="nf">_has_complete_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return whether this entity has a complete key.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
  <span class="n">has_complete_key</span> <span class="o">=</span> <span class="n">_has_complete_key</span>

  <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dummy hash function.</span>

<span class="sd">    Raises:</span>
<span class="sd">      Always TypeError to emphasize that entities are mutable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Model is not immutable&#39;</span><span class="p">)</span>

  <span class="c"># TODO: Reject __lt__, __le__, __gt__, __ge__.</span>

  <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare two entities of the same class for equality.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">NotImplemented</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_key</span><span class="p">:</span>
      <span class="c"># TODO: If one key is None and the other is an explicit</span>
      <span class="c"># incomplete key of the simplest form, this should be OK.</span>
      <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equivalent</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_equivalent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare two entities of the same class, excluding keys.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">:</span>  <span class="c"># TODO: What about subclasses?</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Cannot compare different model classes. &#39;</span>
                                <span class="s">&#39;</span><span class="si">%s</span><span class="s"> is not </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                                  <span class="n">other</span><span class="o">.</span><span class="n">__class_</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_projection</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">False</span>
    <span class="c"># It&#39;s all about determining inequality early.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_properties</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">False</span>  <span class="c"># Can only happen for Expandos.</span>
    <span class="n">my_prop_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">())</span>
    <span class="n">their_prop_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">my_prop_names</span> <span class="o">!=</span> <span class="n">their_prop_names</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">False</span>  <span class="c"># Again, only possible for Expandos.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
      <span class="n">my_prop_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">my_prop_names</span><span class="p">:</span>
      <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">my_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="n">their_value</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">my_value</span> <span class="o">!=</span> <span class="n">their_value</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

  <span class="k">def</span> <span class="nf">_to_pb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">allow_partial</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">set_key</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to turn an entity into an EntityProto protobuf.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_partial</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_check_initialized</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pb</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">pb</span> <span class="o">=</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">EntityProto</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">set_key</span><span class="p">:</span>
      <span class="c"># TODO: Move the key stuff into ModelAdapter.entity_to_pb()?</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key_to_pb</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">unused_name</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()):</span>
      <span class="n">prop</span><span class="o">.</span><span class="n">_serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pb</span>

  <span class="k">def</span> <span class="nf">_key_to_pb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to copy the key into a protobuf.&quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)]</span>
      <span class="n">ref</span> <span class="o">=</span> <span class="n">key_module</span><span class="o">.</span><span class="n">_ReferenceFromPairs</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">pb</span><span class="o">.</span><span class="n">mutable_key</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">ref</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">reference</span><span class="p">()</span>
      <span class="n">pb</span><span class="o">.</span><span class="n">mutable_key</span><span class="p">()</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">mutable_entity_group</span><span class="p">()</span>  <span class="c"># Must initialize this.</span>
    <span class="c"># To work around an SDK issue, only set the entity group if the</span>
    <span class="c"># full key is complete.  TODO: Remove the top test once fixed.</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">id</span><span class="p">():</span>
      <span class="n">elem</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="ow">or</span> <span class="n">elem</span><span class="o">.</span><span class="n">name</span><span class="p">():</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_element</span><span class="p">()</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_from_pb</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">set_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to create an entity from an EntityProto protobuf.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">EntityProto</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;pb must be a EntityProto; received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pb</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">ent</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>

    <span class="c"># A key passed in overrides a key in the pb.</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span><span class="o">.</span><span class="n">element_size</span><span class="p">():</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">pb</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
    <span class="c"># If set_key is not set, skip a trivial incomplete key.</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">set_key</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">id</span><span class="p">()</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">parent</span><span class="p">()):</span>
      <span class="n">ent</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key</span>

    <span class="n">indexed_properties</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">property_list</span><span class="p">()</span>
    <span class="n">unindexed_properties</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">raw_property_list</span><span class="p">()</span>
    <span class="n">projection</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">plist</span> <span class="ow">in</span> <span class="p">[</span><span class="n">indexed_properties</span><span class="p">,</span> <span class="n">unindexed_properties</span><span class="p">]:</span>
      <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">meaning</span><span class="p">()</span> <span class="o">==</span> <span class="n">entity_pb</span><span class="o">.</span><span class="n">Property</span><span class="o">.</span><span class="n">INDEX_VALUE</span><span class="p">:</span>
          <span class="n">projection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">ent</span><span class="o">.</span><span class="n">_get_property_for</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">plist</span> <span class="ow">is</span> <span class="n">indexed_properties</span><span class="p">)</span>
        <span class="n">prop</span><span class="o">.</span><span class="n">_deserialize</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

    <span class="n">ent</span><span class="o">.</span><span class="n">_set_projection</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ent</span>

  <span class="k">def</span> <span class="nf">_set_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projection</span><span class="p">):</span>
    <span class="n">by_prefix</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">propname</span> <span class="ow">in</span> <span class="n">projection</span><span class="p">:</span>
      <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">propname</span><span class="p">:</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">propname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">head</span> <span class="ow">in</span> <span class="n">by_prefix</span><span class="p">:</span>
          <span class="n">by_prefix</span><span class="p">[</span><span class="n">head</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">by_prefix</span><span class="p">[</span><span class="n">head</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tail</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_projection</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">propname</span><span class="p">,</span> <span class="n">proj</span> <span class="ow">in</span> <span class="n">by_prefix</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">propname</span><span class="p">)</span>
      <span class="n">subval</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_get_base_value_unwrapped_as_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">subval</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="n">item</span><span class="o">.</span><span class="n">_set_projection</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_property_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to get the Property for a protobuf-level property.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">depth</span><span class="p">:</span>
      <span class="c"># Apparently there&#39;s an unstructured value here.</span>
      <span class="c"># Assume it is a None written for a missing value.</span>
      <span class="c"># (It could also be that a schema change turned an unstructured</span>
      <span class="c"># value into a structured one.  In that case, too, it seems</span>
      <span class="c"># better to return None than to return an unstructured value,</span>
      <span class="c"># since the latter doesn&#39;t match the current schema.)</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="nb">next</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fake_property</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">indexed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prop</span>

  <span class="k">def</span> <span class="nf">_clone_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to clone self._properties if necessary.&quot;&quot;&quot;</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="ow">is</span> <span class="n">cls</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_properties</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_fake_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to create a fake Property.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_clone_properties</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">next</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">next</span><span class="p">):</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="n">StructuredProperty</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="nb">next</span><span class="p">)</span>
      <span class="n">prop</span><span class="o">.</span><span class="n">_store_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_BaseValue</span><span class="p">(</span><span class="n">Expando</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">compressed</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">meaning_uri</span><span class="p">()</span> <span class="o">==</span> <span class="n">_MEANING_URI_COMPRESSED</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="n">GenericProperty</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span>
                             <span class="n">repeated</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">multiple</span><span class="p">(),</span>
                             <span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">,</span>
                             <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span> <span class="o">=</span> <span class="nb">next</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>
    <span class="k">return</span> <span class="n">prop</span>

  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a dict containing the entity&#39;s property values.</span>

<span class="sd">    Args:</span>
<span class="sd">      include: Optional set of property names to include, default all.</span>
<span class="sd">      exclude: Optional set of property names to skip, default none.</span>
<span class="sd">        A name contained in both include and exclude is excluded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">include</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">))):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;include should be a list, tuple or set&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">))):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;exclude should be a list, tuple or set&#39;</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span>
      <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span><span class="o">.</span><span class="n">_get_for_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
      <span class="k">except</span> <span class="n">UnprojectedPropertyError</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c"># Ignore unprojected properties rather than failing.</span>
    <span class="k">return</span> <span class="n">values</span>
  <span class="n">to_dict</span> <span class="o">=</span> <span class="n">_to_dict</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_fix_up_properties</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fix up the properties by calling their _fix_up() method.</span>

<span class="sd">    Note: This is called by MetaModel, but may also be called manually</span>
<span class="sd">    after dynamically updating a model class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Verify that _get_kind() returns an 8-bit string.</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;Class </span><span class="si">%s</span><span class="s"> defines a _get_kind() method that returns &#39;</span>
                      <span class="s">&#39;a non-string (</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">kind</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>  <span class="c"># ASCII contents is okay.</span>
      <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;Class </span><span class="si">%s</span><span class="s"> defines a _get_kind() method that returns &#39;</span>
                        <span class="s">&#39;a Unicode string (</span><span class="si">%r</span><span class="s">); please encode using utf-8&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">kind</span><span class="p">))</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_properties</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># Map of {name: Property}</span>
    <span class="k">if</span> <span class="n">cls</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="n">__name__</span><span class="p">:</span>  <span class="c"># Skip the classes in *this* file.</span>
      <span class="k">return</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">cls</span><span class="p">)):</span>
      <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ModelAttribute</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ModelKey</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;ModelAttribute </span><span class="si">%s</span><span class="s"> cannot begin with an underscore &#39;</span>
                          <span class="s">&#39;character. _ prefixed attributes are reserved for &#39;</span>
                          <span class="s">&#39;temporary Model instance values.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">attr</span><span class="o">.</span><span class="n">_fix_up</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">Property</span><span class="p">):</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">_repeated</span> <span class="ow">or</span>
              <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">StructuredProperty</span><span class="p">)</span> <span class="ow">and</span>
               <span class="n">attr</span><span class="o">.</span><span class="n">_modelclass</span><span class="o">.</span><span class="n">_has_repeated</span><span class="p">)):</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_has_repeated</span> <span class="o">=</span> <span class="bp">True</span>
          <span class="n">cls</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">attr</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_update_kind_map</span><span class="p">()</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_update_kind_map</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the kind map to include this class.&quot;&quot;&quot;</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_kind_map</span><span class="p">[</span><span class="n">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">()]</span> <span class="o">=</span> <span class="n">cls</span>

  <span class="k">def</span> <span class="nf">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
        <span class="n">prop</span><span class="o">.</span><span class="n">_prepare_for_put</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_check_properties</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">property_names</span><span class="p">,</span> <span class="n">require_indexed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to check the given properties exist and meet specified</span>
<span class="sd">    requirements.</span>

<span class="sd">    Called from query.py.</span>

<span class="sd">    Args:</span>
<span class="sd">      property_names: List or tuple of property names -- each being a string,</span>
<span class="sd">        possibly containing dots (to address subproperties of structured</span>
<span class="sd">        properties).</span>

<span class="sd">    Raises:</span>
<span class="sd">      InvalidPropertyError if one of the properties is invalid.</span>
<span class="sd">      AssertionError if the argument is not a list or tuple of strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">property_names</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">property_names</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">property_names</span><span class="p">:</span>
      <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_unknown_property</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">prop</span><span class="o">.</span><span class="n">_check_property</span><span class="p">(</span><span class="n">rest</span><span class="p">,</span> <span class="n">require_indexed</span><span class="o">=</span><span class="n">require_indexed</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_unknown_property</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to raise an exception for an unknown property name.</span>

<span class="sd">    This is called by _check_properties().  It is overridden by</span>
<span class="sd">    Expando, where this is a no-op.</span>

<span class="sd">    Raises:</span>
<span class="sd">      InvalidPropertyError.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="n">InvalidPropertyError</span><span class="p">(</span><span class="s">&#39;Unknown property </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_validate_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validation for _key attribute (designed to be overridden).</span>

<span class="sd">    Args:</span>
<span class="sd">      key: Proposed Key to use for entity.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A valid key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">key</span>

  <span class="c"># Datastore API using the default context.</span>
  <span class="c"># These use local import since otherwise they&#39;d be recursive imports.</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_query</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Query object for this class.</span>

<span class="sd">    Args:</span>
<span class="sd">      distinct: Optional bool, short hand for group_by = projection.</span>
<span class="sd">      *args: Used to apply an initial filter</span>
<span class="sd">      **kwds: are passed to the Query() constructor.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A Query object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Validating distinct.</span>
    <span class="k">if</span> <span class="s">&#39;distinct&#39;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
      <span class="k">if</span> <span class="s">&#39;group_by&#39;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s">&#39;cannot use distinct= and group_by= at the same time&#39;</span><span class="p">)</span>
      <span class="n">projection</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;projection&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">projection</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s">&#39;cannot use distinct= without projection=&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;distinct&#39;</span><span class="p">):</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s">&#39;group_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">projection</span>

    <span class="c"># TODO: Disallow non-empty args and filter=.</span>
    <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">Query</span>  <span class="c"># Import late to avoid circular imports.</span>
    <span class="n">qry</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="n">qry</span> <span class="o">=</span> <span class="n">qry</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">cls</span><span class="o">.</span><span class="n">_default_filters</span><span class="p">())</span>
    <span class="n">qry</span> <span class="o">=</span> <span class="n">qry</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qry</span>
  <span class="n">query</span> <span class="o">=</span> <span class="n">_query</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_gql</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">query_string</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a GQL query.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">gql</span>  <span class="c"># Import late to avoid circular imports.</span>
    <span class="k">return</span> <span class="n">gql</span><span class="p">(</span><span class="s">&#39;SELECT * FROM </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_class_name</span><span class="p">(),</span> <span class="n">query_string</span><span class="p">),</span>
               <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
  <span class="n">gql</span> <span class="o">=</span> <span class="n">_gql</span>

  <span class="k">def</span> <span class="nf">_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write this entity to the datastore.</span>

<span class="sd">    If the operation creates or completes a key, the entity&#39;s key</span>
<span class="sd">    attribute is set to the new, complete key.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The key for the entity.  This is always a complete key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_put_async</span><span class="p">(</span><span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
  <span class="n">put</span> <span class="o">=</span> <span class="n">_put</span>

  <span class="k">def</span> <span class="nf">_put_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write this entity to the datastore.</span>

<span class="sd">    This is the asynchronous version of Model._put().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projection</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span><span class="s">&#39;Cannot put a partial entity&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tasklets</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">tasklets</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_for_put</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pre_put_hook</span><span class="p">()</span>
    <span class="n">fut</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span>
    <span class="n">post_hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_put_hook</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_default_hook</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">_default_post_put_hook</span><span class="p">,</span> <span class="n">post_hook</span><span class="p">):</span>
      <span class="n">fut</span><span class="o">.</span><span class="n">add_immediate_callback</span><span class="p">(</span><span class="n">post_hook</span><span class="p">,</span> <span class="n">fut</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fut</span>
  <span class="n">put_async</span> <span class="o">=</span> <span class="n">_put_async</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_get_or_insert</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transactionally retrieves an existing entity or creates a new one.</span>

<span class="sd">    Positional Args:</span>
<span class="sd">      name: Key name to retrieve or create.</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">      namespace: Optional namespace.</span>
<span class="sd">      app: Optional app ID.</span>
<span class="sd">      parent: Parent entity key, if any.</span>
<span class="sd">      context_options: ContextOptions object (not keyword args!) or None.</span>
<span class="sd">      **kwds: Keyword arguments to pass to the constructor of the model class</span>
<span class="sd">        if an instance for the specified key name does not already exist. If</span>
<span class="sd">        an instance with the supplied key_name and parent already exists,</span>
<span class="sd">        these arguments will be discarded.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Existing instance of Model class with the specified key name and parent</span>
<span class="sd">      or a new one that has just been created.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cls</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_get_or_insert_async</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
  <span class="n">get_or_insert</span> <span class="o">=</span> <span class="n">_get_or_insert</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_get_or_insert_async</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transactionally retrieves an existing entity or creates a new one.</span>

<span class="sd">    This is the asynchronous version of Model._get_or_insert().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># NOTE: The signature is really weird here because we want to support</span>
    <span class="c"># models with properties named e.g. &#39;cls&#39; or &#39;name&#39;.</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tasklets</span>
    <span class="n">cls</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">args</span>  <span class="c"># These must always be positional.</span>
    <span class="n">get_arg</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__get_arg</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;app&#39;</span><span class="p">)</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;namespace&#39;</span><span class="p">)</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;parent&#39;</span><span class="p">)</span>
    <span class="n">context_options</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">kwds</span><span class="p">,</span> <span class="s">&#39;context_options&#39;</span><span class="p">)</span>
    <span class="c"># (End of super-special argument parsing.)</span>
    <span class="c"># TODO: Test the heck out of this, in all sorts of evil scenarios.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;name must be a string; received </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;name cannot be an empty string.&#39;</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>

    <span class="nd">@tasklets.tasklet</span>
    <span class="k">def</span> <span class="nf">internal_tasklet</span><span class="p">():</span>
      <span class="nd">@tasklets.tasklet</span>
      <span class="k">def</span> <span class="nf">txn</span><span class="p">():</span>
        <span class="n">ent</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">key</span><span class="o">.</span><span class="n">get_async</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">context_options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">ent</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span>  <span class="c"># TODO: Use _populate().</span>
          <span class="n">ent</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">key</span>
          <span class="k">yield</span> <span class="n">ent</span><span class="o">.</span><span class="n">put_async</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">context_options</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">tasklets</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">in_transaction</span><span class="p">():</span>
        <span class="c"># Run txn() in existing transaction.</span>
        <span class="n">ent</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">txn</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c"># Maybe avoid a transaction altogether.</span>
        <span class="n">ent</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">key</span><span class="o">.</span><span class="n">get_async</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">context_options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="c"># Run txn() in new transaction.</span>
          <span class="n">ent</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">transaction_async</span><span class="p">(</span><span class="n">txn</span><span class="p">)</span>
      <span class="k">raise</span> <span class="n">tasklets</span><span class="o">.</span><span class="n">Return</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">internal_tasklet</span><span class="p">()</span>

  <span class="n">get_or_insert_async</span> <span class="o">=</span> <span class="n">_get_or_insert_async</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_allocate_ids</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allocates a range of key IDs for this model class.</span>

<span class="sd">    Args:</span>
<span class="sd">      size: Number of IDs to allocate. Either size or max can be specified,</span>
<span class="sd">        not both.</span>
<span class="sd">      max: Maximum ID to allocate. Either size or max can be specified,</span>
<span class="sd">        not both.</span>
<span class="sd">      parent: Parent key for which the IDs will be allocated.</span>
<span class="sd">      **ctx_options: Context options.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tuple with (start, end) for the allocated range, inclusive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_allocate_ids_async</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
                                   <span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
  <span class="n">allocate_ids</span> <span class="o">=</span> <span class="n">_allocate_ids</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_allocate_ids_async</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Allocates a range of key IDs for this model class.</span>

<span class="sd">    This is the asynchronous version of Model._allocate_ids().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tasklets</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">tasklets</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_pre_allocate_ids_hook</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span> <span class="bp">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
    <span class="n">fut</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">allocate_ids</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span>
    <span class="n">post_hook</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_post_allocate_ids_hook</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cls</span><span class="o">.</span><span class="n">_is_default_hook</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">_default_post_allocate_ids_hook</span><span class="p">,</span>
                                <span class="n">post_hook</span><span class="p">):</span>
      <span class="n">fut</span><span class="o">.</span><span class="n">add_immediate_callback</span><span class="p">(</span><span class="n">post_hook</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">fut</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fut</span>
  <span class="n">allocate_ids_async</span> <span class="o">=</span> <span class="n">_allocate_ids_async</span>

  <span class="nd">@classmethod</span>
  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_get_by_id</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns an instance of Model class by ID.</span>

<span class="sd">    This is really just a shorthand for Key(cls, id, ...).get().</span>

<span class="sd">    Args:</span>
<span class="sd">      id: A string or integer key ID.</span>
<span class="sd">      parent: Optional parent key of the model to get.</span>
<span class="sd">      namespace: Optional namespace.</span>
<span class="sd">      app: Optional app ID.</span>
<span class="sd">      **ctx_options: Context options.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A model instance or None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_get_by_id_async</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
  <span class="n">get_by_id</span> <span class="o">=</span> <span class="n">_get_by_id</span>

  <span class="nd">@classmethod</span>
  <span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_get_by_id_async</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns an instance of Model class by ID (and app, namespace).</span>

<span class="sd">    This is the asynchronous version of Model._get_by_id().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">_get_kind</span><span class="p">(),</span> <span class="nb">id</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">get_async</span><span class="p">(</span><span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span>
  <span class="n">get_by_id_async</span> <span class="o">=</span> <span class="n">_get_by_id_async</span>

  <span class="c"># Hooks that wrap around mutations.  Most are class methods with</span>
  <span class="c"># the notable exception of put, which is an instance method.</span>

  <span class="c"># To use these, override them in your model class and call</span>
  <span class="c"># super(&lt;myclass&gt;, cls).&lt;hook&gt;(*args).</span>

  <span class="c"># Note that the pre-hooks are called before the operation is</span>
  <span class="c"># scheduled.  The post-hooks are called (by the Future) after the</span>
  <span class="c"># operation has completed.</span>

  <span class="c"># Do not use or touch the _default_* hooks.  These exist for</span>
  <span class="c"># internal use only.</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_pre_allocate_ids_hook</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
    <span class="k">pass</span>
  <span class="n">_default_pre_allocate_ids_hook</span> <span class="o">=</span> <span class="n">_pre_allocate_ids_hook</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_post_allocate_ids_hook</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
    <span class="k">pass</span>
  <span class="n">_default_post_allocate_ids_hook</span> <span class="o">=</span> <span class="n">_post_allocate_ids_hook</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_pre_delete_hook</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">pass</span>
  <span class="n">_default_pre_delete_hook</span> <span class="o">=</span> <span class="n">_pre_delete_hook</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_post_delete_hook</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
    <span class="k">pass</span>
  <span class="n">_default_post_delete_hook</span> <span class="o">=</span> <span class="n">_post_delete_hook</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_pre_get_hook</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">pass</span>
  <span class="n">_default_pre_get_hook</span> <span class="o">=</span> <span class="n">_pre_get_hook</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_post_get_hook</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
    <span class="k">pass</span>
  <span class="n">_default_post_get_hook</span> <span class="o">=</span> <span class="n">_post_get_hook</span>

  <span class="k">def</span> <span class="nf">_pre_put_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">pass</span>
  <span class="n">_default_pre_put_hook</span> <span class="o">=</span> <span class="n">_pre_put_hook</span>

  <span class="k">def</span> <span class="nf">_post_put_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
    <span class="k">pass</span>
  <span class="n">_default_post_put_hook</span> <span class="o">=</span> <span class="n">_post_put_hook</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_is_default_hook</span><span class="p">(</span><span class="n">default_hook</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks whether a specific hook is in its default state.</span>

<span class="sd">    Args:</span>
<span class="sd">      cls: A ndb.model.Model class.</span>
<span class="sd">      default_hook: Callable specified by ndb internally (do not override).</span>
<span class="sd">      hook: The hook defined by a model class using _post_*_hook.</span>

<span class="sd">    Raises:</span>
<span class="sd">      TypeError if either the default hook or the tested hook are not callable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">default_hook</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Default hooks for ndb.model.Model must be callable&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Hooks must be callable&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">default_hook</span><span class="o">.</span><span class="n">im_func</span> <span class="ow">is</span> <span class="n">hook</span><span class="o">.</span><span class="n">im_func</span>


<span class="k">class</span> <span class="nc">Expando</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Model subclass to support dynamic Property names and types.</span>

<span class="sd">  See the module docstring for details.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c"># Set this to False (in an Expando subclass or entity) to make</span>
  <span class="c"># properties default to unindexed.</span>
  <span class="n">_default_indexed</span> <span class="o">=</span> <span class="bp">True</span>

  <span class="k">def</span> <span class="nf">_set_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwds</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">_unknown_property</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="c"># It is not an error as the property may be a dynamic property.</span>
    <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>
      <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prop</span><span class="o">.</span><span class="n">_get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="p">(</span><span class="n">Property</span><span class="p">,</span> <span class="nb">property</span><span class="p">))):</span>
      <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="c"># TODO: Refactor this to share code with _fake_property().</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_clone_properties</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="n">StructuredProperty</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="n">StructuredProperty</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">repeated</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
      <span class="n">indexed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_indexed</span>
      <span class="c"># TODO: What if it&#39;s a list of Model instances?</span>
      <span class="n">prop</span> <span class="o">=</span> <span class="n">GenericProperty</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">repeated</span><span class="o">=</span><span class="n">repeated</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">)</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">_code_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">_set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="p">(</span><span class="n">Property</span><span class="p">,</span> <span class="nb">property</span><span class="p">))):</span>
      <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Expando</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__delattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">Property</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Model properties must be Property instances; not </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                      <span class="n">prop</span><span class="p">)</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">_delete_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">_properties</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> still in the list of properties for the &#39;</span>
                         <span class="s">&#39;base class.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>


<span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Run a callback in a transaction.</span>

<span class="sd">  Args:</span>
<span class="sd">    callback: A function or tasklet to be called.</span>
<span class="sd">    **ctx_options: Transaction options.</span>

<span class="sd">  Useful options include:</span>
<span class="sd">    retries=N: Retry up to N times (i.e. try up to N+1 times)</span>
<span class="sd">    propagation=&lt;flag&gt;: Determines how an existing transaction should be</span>
<span class="sd">      propagated, where &lt;flag&gt; can be one of the following:</span>
<span class="sd">      TransactionOptions.NESTED: Start a nested transaction (this is the</span>
<span class="sd">        default; but actual nested transactions are not yet implemented,</span>
<span class="sd">        so effectively you can only use this outside an existing transaction).</span>
<span class="sd">      TransactionOptions.MANDATORY: A transaction must already be in progress.</span>
<span class="sd">      TransactionOptions.ALLOWED: If a transaction is in progress, join it.</span>
<span class="sd">      TransactionOptions.INDEPENDENT: Always start a new parallel transaction.</span>
<span class="sd">    xg=True: On the High Replication Datastore, enable cross-group</span>
<span class="sd">      transactions, i.e. allow writing to up to 5 entity groups.</span>

<span class="sd">  WARNING: Using anything other than NESTED for the propagation flag</span>
<span class="sd">  can have strange consequences.  When using ALLOWED or MANDATORY, if</span>
<span class="sd">  an exception is raised, the transaction is likely not safe to</span>
<span class="sd">  commit.  When using INDEPENDENT it is not generally safe to return</span>
<span class="sd">  values read to the caller (as they were not read in the caller&#39;s</span>
<span class="sd">  transaction).</span>

<span class="sd">  Returns:</span>
<span class="sd">    Whatever callback() returns.</span>

<span class="sd">  Raises:</span>
<span class="sd">    Whatever callback() raises; datastore_errors.TransactionFailedError</span>
<span class="sd">    if the transaction failed.</span>

<span class="sd">  Note:</span>
<span class="sd">    To pass arguments to a callback function, use a lambda, e.g.</span>
<span class="sd">      def my_callback(key, inc):</span>
<span class="sd">        ...</span>
<span class="sd">      transaction(lambda: my_callback(Key(...), 1))</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">fut</span> <span class="o">=</span> <span class="n">transaction_async</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">fut</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>


<span class="nd">@utils.positional</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">transaction_async</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Run a callback in a transaction.</span>

<span class="sd">  This is the asynchronous version of transaction().</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tasklets</span>
  <span class="k">return</span> <span class="n">tasklets</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span><span class="o">.</span><span class="n">transaction</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">in_transaction</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;Return whether a transaction is currently active.&quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tasklets</span>
  <span class="k">return</span> <span class="n">tasklets</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">()</span>


<span class="nd">@utils.decorator</span>
<span class="k">def</span> <span class="nf">transactional</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Decorator to make a function automatically run in a transaction.</span>

<span class="sd">  Args:</span>
<span class="sd">    **ctx_options: Transaction options (see transaction(), but propagation</span>
<span class="sd">      default to TransactionOptions.ALLOWED).</span>

<span class="sd">  This supports two forms:</span>

<span class="sd">  (1) Vanilla:</span>
<span class="sd">      @transactional</span>
<span class="sd">      def callback(arg):</span>
<span class="sd">        ...</span>

<span class="sd">  (2) With options:</span>
<span class="sd">      @transactional(retries=1)</span>
<span class="sd">      def callback(arg):</span>
<span class="sd">        ...</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">transactional_async</span><span class="o">.</span><span class="n">wrapped_decorator</span><span class="p">(</span>
      <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>


<span class="nd">@utils.decorator</span>
<span class="k">def</span> <span class="nf">transactional_async</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The async version of @ndb.transaction.&quot;&quot;&quot;</span>
  <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;propagation&#39;</span><span class="p">,</span> <span class="n">datastore_rpc</span><span class="o">.</span><span class="n">TransactionOptions</span><span class="o">.</span><span class="n">ALLOWED</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwds</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">transaction_async</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">transaction_async</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>


<span class="nd">@utils.decorator</span>
<span class="k">def</span> <span class="nf">transactional_tasklet</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The async version of @ndb.transaction.</span>

<span class="sd">  Will return the result of the wrapped function as a Future.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tasklets</span>
  <span class="n">func</span> <span class="o">=</span> <span class="n">tasklets</span><span class="o">.</span><span class="n">tasklet</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">transactional_async</span><span class="o">.</span><span class="n">wrapped_decorator</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>


<span class="nd">@utils.decorator</span>
<span class="k">def</span> <span class="nf">non_transactional</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">,</span> <span class="n">allow_existing</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A decorator that ensures a function is run outside a transaction.</span>

<span class="sd">  If there is an existing transaction (and allow_existing=True), the</span>
<span class="sd">  existing transaction is paused while the function is executed.</span>

<span class="sd">  Args:</span>
<span class="sd">    allow_existing: If false, throw an exception if called from within</span>
<span class="sd">      a transaction.  If true, temporarily re-establish the</span>
<span class="sd">      previous non-transactional context.  Defaults to True.</span>

<span class="sd">  This supports two forms, similar to transactional().</span>

<span class="sd">  Returns:</span>
<span class="sd">    A wrapper for the decorated function that ensures it runs outside a</span>
<span class="sd">    transaction.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tasklets</span>
  <span class="n">ctx</span> <span class="o">=</span> <span class="n">tasklets</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_existing</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
      <span class="s">&#39;</span><span class="si">%s</span><span class="s"> cannot be called within a transaction.&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
  <span class="n">save_ctx</span> <span class="o">=</span> <span class="n">ctx</span>
  <span class="k">while</span> <span class="n">ctx</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">_parent_context</span>
    <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">datastore_errors</span><span class="o">.</span><span class="n">BadRequestError</span><span class="p">(</span>
        <span class="s">&#39;Context without non-transactional ancestor&#39;</span><span class="p">)</span>
  <span class="n">save_ds_conn</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">_GetConnection</span><span class="p">()</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">save_ctx</span><span class="p">,</span> <span class="s">&#39;_old_ds_conn&#39;</span><span class="p">):</span>
      <span class="n">datastore</span><span class="o">.</span><span class="n">_SetConnection</span><span class="p">(</span><span class="n">save_ctx</span><span class="o">.</span><span class="n">_old_ds_conn</span><span class="p">)</span>
    <span class="n">tasklets</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">tasklets</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">save_ctx</span><span class="p">)</span>
    <span class="n">datastore</span><span class="o">.</span><span class="n">_SetConnection</span><span class="p">(</span><span class="n">save_ds_conn</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_multi_async</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Fetches a sequence of keys.</span>

<span class="sd">  Args:</span>
<span class="sd">    keys: A sequence of keys.</span>
<span class="sd">    **ctx_options: Context options.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A list of futures.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">get_async</span><span class="p">(</span><span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_multi</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Fetches a sequence of keys.</span>

<span class="sd">  Args:</span>
<span class="sd">    keys: A sequence of keys.</span>
<span class="sd">    **ctx_options: Context options.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A list whose items are either a Model instance or None if the key wasn&#39;t</span>
<span class="sd">    found.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
          <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">get_multi_async</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">put_multi_async</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stores a sequence of Model instances.</span>

<span class="sd">  Args:</span>
<span class="sd">    entities: A sequence of Model instances.</span>
<span class="sd">    **ctx_options: Context options.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A list of futures.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">put_async</span><span class="p">(</span><span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">put_multi</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stores a sequence of Model instances.</span>

<span class="sd">  Args:</span>
<span class="sd">    entities: A sequence of Model instances.</span>
<span class="sd">    **ctx_options: Context options.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A list with the stored keys.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
          <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">put_multi_async</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">delete_multi_async</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Deletes a sequence of keys.</span>

<span class="sd">  Args:</span>
<span class="sd">    keys: A sequence of keys.</span>
<span class="sd">    **ctx_options: Context options.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A list of futures.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">delete_async</span><span class="p">(</span><span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">delete_multi</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Deletes a sequence of keys.</span>

<span class="sd">  Args:</span>
<span class="sd">    keys: A sequence of keys.</span>
<span class="sd">    **ctx_options: Context options.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A list whose items are all None, one per deleted key.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
          <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">delete_multi_async</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_options</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">get_indexes_async</span><span class="p">(</span><span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Get a data structure representing the configured indexes.</span>

<span class="sd">  Args:</span>
<span class="sd">    **ctx_options: Context options.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A future.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tasklets</span>
  <span class="n">ctx</span> <span class="o">=</span> <span class="n">tasklets</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_indexes</span><span class="p">(</span><span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_indexes</span><span class="p">(</span><span class="o">**</span><span class="n">ctx_options</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Get a data structure representing the configured indexes.</span>

<span class="sd">  Args:</span>
<span class="sd">    **ctx_options: Context options.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A list of Index objects.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">get_indexes_async</span><span class="p">(</span><span class="o">**</span><span class="n">ctx_options</span><span class="p">)</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>


<span class="c"># Update __all__ to contain all Property and Exception subclasses.</span>
<span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_object</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;Property&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">_object</span><span class="p">,</span> <span class="n">Property</span><span class="p">))</span> <span class="ow">or</span>
      <span class="p">(</span><span class="n">_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;Error&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">_object</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">))):</span>
    <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_name</span><span class="p">)</span>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Google, Inc.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../',
            VERSION:'1.4.11',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>